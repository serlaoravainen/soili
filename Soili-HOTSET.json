[
  {
    "path": "supabase/functions/sendemail/index.ts",
    "size": 4211,
    "sha256": "00024e978c47804d1232c13503f06f93a0a0512ce27badc80ae3ab0e70f1c387",
    "lang": "typescript",
    "lines": 145,
    "modifiedAt": "2025-09-02T01:28:28+03:00",
    "commitSha": "29d28ab09b16112f6f64a83fb43e1143e63a0ed0",
    "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/supabase/functions/sendemail/index.ts",
    "chunks": [
      {
        "i": 0,
        "text": "// supabase/functions/sendemail/index.ts\n// Deno + Supabase Edge Function + Resend\nimport \"jsr:@supabase/functions-js/edge-runtime.d.ts\";\nimport { Resend } from \"npm:resend@3\";\nimport { z } from \"npm:zod@3\";\n\nconst resend = new Resend(Deno.env.get(\"RESEND_API_KEY\") ?? \"\");\nconst FROM = Deno.env.get(\"FROM_EMAIL\") ?? \"Soili <onboarding@resend.dev>\";\nconst ALLOWED_ORIGIN = Deno.env.get(\"ALLOWED_ORIGIN\") ?? \"*\";\n\n// Salli vain POST + CORS preflight\nfunction corsHeaders(origin: string | null) {\n  const o = origin && ALLOWED_ORIGIN !== \"*\" ? ALLOWED_ORIGIN : \"*\";\n  return {\n    \"Access-Control-Allow-Origin\": o,\n    \"Access-Control-Allow-Methods\": \"POST, OPTIONS\",\n    \"Access-Control-Allow-Headers\": \"authorization, x-client-info, apikey, content-type\",\n  };\n}\n\nconst BodySchema = z.object({\n  to: z.union([z.string().email(), z.array(z.string().email()).nonempty()]),\n  subject: z.string().min(1),\n  // vähintään toinen: text tai html\n  text: z.string().optional(),\n  html: z.string().optional(),\n  replyTo: z.string().email().optional(),\n  // kevyt anti-spam kenttä (honeypot)\n  _honey: z.string().optional(),\n});\n\ntype ResendError = {\n  name?: string;\n  message?: string;\n  statusCode?: number;\n  [key: string]: unknown;\n};\n\n\nDeno.serve(async (req) => {\n  // CORS preflight\n  if (req.method === \"OPTIONS\") {\n    return new Response(\"ok\", { headers: corsHeaders(req.headers.get(\"Origin\")) });\n  }\n\n  if (req.method !== \"POST\") {\n    return new Response(JSON.stringify({ error: \"Method Not Allowed\" }), {\n      status: 405,\n      headers: { \"content-type\": \"application/json\", ...corsHeaders(req.headers.get(\"Origin\")) },\n    });\n  }\n\n  try {\n    const origin = req.headers.get(\"Origin\");\n    const headers = { \"content-type\": \"application/json\", ...corsHeaders(origin) };\n\n    // **Supabase Functions vaatii Authorization: Bearer <anon|service key>**\n    const auth = req.headers.get(\"authorization\") ?? \"\";\n    if (!auth.toLowerCase().startsWith(\"bearer \")) {\n      return new Response(JSON.stringify({ error: \"Missing Authorization Bearer token\" }), {\n        status: 401,\n        headers,\n      });\n    }\n\n    const json = await req.json().catch(() => null);\n    const parsed = BodySchema.safeParse(json);\n    if (!parsed.success) {\n      return new Response(JSON.stringify({ error: \"Invalid body\", details: parsed.error.flatten() }), {\n        status: 400,\n        headers,\n      });\n    }\n\n    const { to, subject, text, html, replyTo, _honey } = parsed.data;\n\n    // honeypot – jos botti täyttää, dropataan\n    if (_honey && _honey.trim() !== \"\") {\n      return new Response(JSON.stringify({ ok: true, dropped: true }), { status: 200, headers });\n    }\n\n    if (!text && !html) {\n      return new Response(JSON.stringify({ error: \"Provide 'text' or 'html'\" }), {\n        status: 400,\n        headers,\n      });\n    }\n\n    type ResendSendResponse = {\n    id?: string;\n    error?: {\n    name?: string;\n    message?: string;\n    statusCode?: number;\n    [key: string]: unknown;\n    } | string | null;\n    [key: string]: unknown;\n    };\n\nconst sendRes = (await resend.emails.send({\n  from: FROM,\n  to,\n  subject,\n  text: text ?? undefined,\n  html: html ?? undefined,\n  reply_to: replyTo,\n})) as ResendSendResponse;\n\nif (sendRes.error) {\n  const err: ResendError =\n    typeof sendRes.error === \"string\"\n      ? { message: sendRes.error }\n      : (sendRes.error ?? {});\n\n  const status =\n    typeof err.statusCode === \"number\" &&\n    err.statusCode >= 400 &&\n    err.statusCode < 600\n      ? err.statusCode\n      : 400;\n\n  return new Response(\n    JSON.stringify({\n      error: {\n        name: err.name ?? \"ResendError\",\n        message: err.message ?? \"Resend rejected the request\",\n        statusCode: status,\n      },\n      hint:\n        \"Check RESEND_API_KEY, FROM_EMAIL (sandbox vs. verified domain), and recipient.\",\n    }),\n    { status, headers }\n  );\n}\n\n\n    return new Response(JSON.stringify({ ok: true, data: sendRes }), { status: 200, headers });\n} catch (e: unknown) {\n  return new Response(\n    JSON.stringify({ error: \"Internal error\", details: String(e) }),\n    { status: 500, headers: { \"content-type\": \"application/json\", ...corsHeaders(req.headers.get(\"Origin\")) } }\n  );\n}\n});\n",
        "byteOffset": 0,
        "totalChunks": 1,
        "hasMore": false,
        "startLine": 1,
        "endLine": 145
      }
    ]
  },
  {
    "path": "supabase/functions/mailer/index.ts",
    "size": 16950,
    "sha256": "308a3ca3b92618ed4689a1b51c8651a40862cff49b6fee6e7fcf4af1ee127767",
    "lang": "typescript",
    "lines": 496,
    "modifiedAt": "2025-09-02T01:28:28+03:00",
    "commitSha": "29d28ab09b16112f6f64a83fb43e1143e63a0ed0",
    "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/supabase/functions/mailer/index.ts",
    "chunks": [
      {
        "i": 0,
        "text": "// supabase/functions/mailer/index.ts\n// Prosessoi mailijonon: lähettää adminille mailin uusista poissaolopyynnöistä.\n// Ajastus: cronilla esim. joka minuutti.\n\nimport \"jsr:@supabase/functions-js/edge-runtime.d.ts\";\nimport { createClient } from \"https://esm.sh/@supabase/supabase-js@2\";\n\n// --- Types ---\ntype JobType = \"admin_new_absence\" | \"employee_shift_changed\" | \"employee_new_shift\" | \"employee_shift_deleted\" | string;\ntype ExtendedJobType = JobType | \"employee_new_shift\";\ntype EmployeeJobType = \"employee_shift_changed\" | \"employee_new_shift\" | \"employee_shift_deleted\";\nconst EMPLOYEE_JOB_TYPES: EmployeeJobType[] = [\"employee_shift_changed\",\"employee_new_shift\",\"employee_shift_deleted\"];\nconst MAIL_AGG_WINDOW_MIN = parseInt(Deno.env.get(\"MAIL_AGG_WINDOW_MIN\") ?? \"10\", 10);\n\ntype BaseJob = {\n  id: number;\n  type: ExtendedJobType;\n  payload: Record<string, unknown>;\n  status: \"queued\" | \"sent\" | \"failed\" | string;\n  attempt_count: number;\n  last_error?: string | null;\n  created_at: string;\n  processed_at?: string | null;\n};\n\n\ntype EmployeeShiftChangedPayload = {\n  shift_id: string;\n  employee_id: string;\n  work_date: string;\n  old_start?: string | null;\n  old_end?: string | null;\n  new_start?: string | null;\n  new_end?: string | null;\n};\n\ntype AppSettingsRow = {\n  email_notifications: boolean;\n  admin_notification_emails: string[];\n  absence_requests: boolean;\n  schedule_changes: boolean;\n  employee_updates: boolean;\n  system_updates: boolean;\n  daily_digest: boolean;\n  digest_time: string;\n};\n\ntype MailJobRow = BaseJob;\n\n// ---- ENV ----\nconst SUPABASE_URL = Deno.env.get(\"SUPABASE_URL\")!;\nconst SUPABASE_SERVICE_ROLE_KEY = Deno.env.get(\"SUPABASE_SERVICE_ROLE_KEY\")!;\nconst RESEND_API_KEY = Deno.env.get(\"RESEND_API_KEY\")!;\nconst FROM_EMAIL = Deno.env.get(\"FROM_EMAIL\") ?? \"Soili <onboarding@resend.dev>\";\n\nif (!SUPABASE_URL || !SUPABASE_SERVICE_ROLE_KEY) {\n  throw new Error(\"Missing SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY\");\n}\nif (!RESEND_API_KEY) {\n  throw new Error(\"Missing RESEND_API_KEY\");\n}\n\nconst sb = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY, {\n  auth: { persistSession: false },\n});\n\n// ---- Resend sender ----\nasync function sendEmail(to: string[] | string, subject: string, text: string) {\n  const resp = await fetch(\"https://api.resend.com/emails\", {\n    method: \"POST\",\n    headers: {\n      Authorization: `Bearer ${RESEND_API_KEY}`,\n      \"Content-Type\": \"application/json\",\n    },\n    body: JSON.stringify({\n      from: FROM_EMAIL,\n      to,\n      subject,\n      text,\n    }),\n  });\n\n  if (!resp.ok) {\n    const errText = await resp.text().catch(() => resp.statusText);\n    throw new Error(`Resend failed: ${resp.status} ${errText}`);\n  }\n}\n\n// ---- New: employee new shift ----\nasync function processEmployeeNewShift(job: BaseJob, settings: AppSettingsRow) {\n  if (!settings.email_notifications) return \"skipped: email_notifications=false\";\n  if (!settings.schedule_changes)    return \"skipped: schedule_changes=false\";\n\n  const p = job.payload;\n  const empId = String(p.employee_id ?? \"\");\n  if (!empId) return \"skipped: no employee_id\";\n\n  const { data: emp, error: empErr } = await sb\n    .from(\"employees\")\n    .select(\"email,name\")\n    .eq(\"id\", empId)\n    .maybeSingle();\n  if (empErr) throw empErr;\n  const to = emp?.email;\n  if (!to) return \"skipped: employee has no email\";\n\n  const date = String(p.work_date ?? \"\");\n  const s = p.start ? String(p.start) : \"\";\n  const e = p.end   ? String(p.end)   : \"\";\n\n  const subject = `Sinulle on lisätty uusi työvuoro (${date})`;\n  const lines = [\n    emp?.name ? `Hei ${emp.name},` : \"Hei,\",\n    \"\",\n    \"Sinulle on lisätty uusi työvuoro:\",\n    `Aika: ${s}${e ? ` – ${e}` : \"\"}`,\n    date ? `Päivä: ${date}` : null,\n    \"\",\n    \"Terveisin,\",\n    \"Soili\",\n  ].filter(Boolean).join(\"\\n\");\n\n  await sendEmail([to], subject, lines);\n  return \"sent\";\n}\n\n// ---- New: employee shift deleted ----\nasync function processEmployeeShiftDeleted(job: BaseJob, settings: AppSettingsRow) {\n  if (!settings.email_notifications) return \"skipped: email_notifications=false\";\n  if (!settings.schedule_changes)    return \"skipped: schedule_changes=false\";\n\n  const p = job.payload;\n  const empId = String(p.employee_id ?? \"\");\n  if (!empId) return \"skipped: no employee_id\";\n\n  const { data: emp, error: empErr } = await sb\n    .from(\"employees\")\n    .select(\"email,name\")\n    .eq(\"id\", empId)\n    .maybeSingle();\n  if (empErr) throw empErr;\n  const to = emp?.email;\n  if (!to) return \"skipped: employee has no email\";\n\n  const date = String(p.work_date ?? \"\");\n  const s = p.start ? String(p.start) : \"\";\n  const e = p.end   ? String(p.end)   : \"\";\n\n  const subject = `Vuorosi on peruttu (${date})`;\n  const lines = [\n    emp?.name ? `Hei ${emp.name},` : \"Hei,\",\n    \"\",\n    \"Sinulle merkitty työvuoro on poistettu.\",\n    (s || e) ? `Aika: ${s}${e ? ` – ${e}` : \"\"}` : null,\n    date ? `Päivä: ${date}` : null,\n    \"\",\n    \"Jos tämä on virhe, ole yhteydessä esihenkilöösi.\",\n    \"\",\n    \"Terveisin,\",\n    \"Soili\",\n  ].filter(Boolean).join(\"\\n\");\n\n  await sendEmail([to], subject, lines);\n  return \"sent\";\n}\n\n// =============== BULK MELUNESTO: KOONTI 5–10 MIN IKKUNASSA ===============\n// Perusidea: kun törmätään yhteen employee_* jobiin, kerätään kaikki saman työntekijän\n// queued/tuoreet jobit viimeisten N minuuttien sisällä, merkitään ne 'processing',\n// lähetetään YKSI koontimaili ja merkataan kaikki 'sent'.\n\nfunction cutoffISO(min: number) {\n  return new Date(Date.now() - min * 60_000).toISOString();\n}\n\nfunction isEmployeeJob(t: string): t is EmployeeJobType {\n  return (EMPLOYEE_JOB_TYPES as string[]).includes(t);\n}\n\nasync function claimViaRpc(employeeId: string, sinceISO: string, limit = 200) {\n  const { data, error } = await sb.rpc(\"claim_employee_jobs\", {\n    p_employee_id: employeeId,\n    p_since: sinceISO,\n    p_types: EMPLOYEE_JOB_TYPES,\n    p_limit: limit,\n  });\n  if (error) throw error;\n  // supabase-js v2 palauttaa data: any[]; tyypitetään kevyesti\n  return (data ?? []) as BaseJob[];\n}\n\n\nfunction fmtTimeMaybe(s?: string | null) {\n  if (!s) return \"\";\n  return String(s);\n}\n\nfunction summarizeEmployeeJobs(jobs: MailJobRow[]) {\n  // Palauttaa rivit ja laskurit\n  const lines: string[] = [];\n  let added = 0, changed = 0, deleted = 0;\n  // Lajittele ajankohdan mukaan display-friendly\n  jobs.sort((a, b) => (a.created_at < b.created_at ? -1 : 1));\n  for (const j of jobs) {\n    const p = j.payload;\n    const date = String(p[\"work_date\"] ?? \"\");\n    if (j.type === \"employee_new_shift\") {\n      added++;\n      const s = fmtTimeMaybe(p[\"start\"] as string | undefined);\n      const e = fmtTimeMaybe(p[\"end\"] as string | undefined);\n      lines.push(`• Uusi vuoro ${date}${s || e ? ` (${s}${e ? `–${e}` : \"\"})` : \"\"}`);\n    } else if (j.type === \"employee_shift_changed\") {\n      changed++;\n      const os = fmtTimeMaybe(p[\"old_start\"] as string | undefined);\n      const oe = fmtTimeMaybe(p[\"old_end\"] as string | undefined);\n      const ns = fmtTimeMaybe(p[\"new_start\"] as string | undefined);\n      const ne = fmtTimeMaybe(p[\"new_end\"] as string | undefined);\n      lines.push(`• Vuoro päivitetty ${date}: ${os || oe ? `${os}–${oe} ⇒ ` : \"\"}${ns}–${ne}`);\n    } else if (j.type === \"employee_shift_deleted\") {\n      deleted++;\n      const s = fmtTimeMaybe(p[\"start\"] as string | undefined);\n      const e = fmtTimeMaybe(p[\"end\"] as string | undefined);\n      lines.push(`• Vuoro poistettu ${date}${s || e ? ` (${s}${e ? `–${e}` : \"\"})` : \"\"}`);\n    }\n  }\n  return { lines, added, changed, deleted };\n}\n\ntype AggregationResult =\n  | { kind: \"handled\"; claimedIds: number[]; count: number }\n  | { kind: \"failed\"; claimedIds: number[]; error: string }\n  | { kind: \"fallback\" };\n\nasync function processEmployeeJobsAggregated(anchorJob: BaseJob, settings: AppSettingsRow): Promise<AggregationResult> {\n  if (!settings.email_notifications || !settings.schedule_changes) return \"skipped: schedule notifications off\";\n  const empId = String(anchorJob.payload[\"employee_id\"] ?? \"\");\n  if (!empId) return \"skipped: no employee_id\";\n\n  // Hae vastaanottaja\n  const { data: emp, error: empErr } = await sb\n    .from(\"employees\")\n    .select(\"email,name\")\n    .eq(\"id\", empId)\n    .maybeSingle();\n  if (empErr) throw empErr;\n  const to = emp?.email;\n  if (!to) return \"skipped: employee has no email\";\n\n  const since = cutoffISO(MAIL_AGG_WINDOW_MIN);\n  const claimed = await claimViaRpc(empId, since);\n  if (!claimed.length) {\n    // Ei mitään koottavaa tämän ankkurin ympärille → anna kutsujan hoitaa fallback\n    return { kind: \"fallback\" };\n  }\n\n  const { lines, added, changed, deleted } = summarizeEmployeeJobs(claimed);\n  if (lines.length === 0) {\n    await sb.from(\"mail_jobs\")\n      .update({ status: \"sent\", processed_at: new Date().toISOString(), last_error: null })\n      .in(\"id\", claimed.map(j => j.id));\n    return { kind: \"handled\", claimedIds: claimed.map(j => j.id), count: 0 };\n  }\n\n  // subject esim: \"Työvuoripäivitykset (5 kpl) – <päivämäärä>\"\n  const total = added + changed + deleted;\n  const today = new Date().toISOString().slice(0,10);\n  const subject = `Työvuoripäivitykset (${total} kpl) – ${today}`;\n  const greeting = emp?.name ? `Hei ${emp.name},` : \"Hei,\";\n  const text = [\n    greeting, \"\", \n    \"Tässä viimeisimmät muutokset työvuoroihisi:\", \n    \"\", \n    ...lines, \n    \"\", \n    \"Terveisin,\", \n    \"Soili\"\n  ].join(\"\\n\");\n\n  try {\n    await sendEmail([to], subject, text);\n    // Merkkaa kaikki claimed sentiksi\n    await sb.from(\"mail_jobs\")\n      .update({ status: \"sent\", processed_at: new Date().toISOString(), last_error: null })\n      .in(\"id\", claimed.map(j => j.id));\n    return { kind: \"handled\", claimedIds: claimed.map(j => j.id), count: total };\n  } catch (e) {\n    const msg = e instanceof Error ? e.message : String(e);\n    await sb.from(\"mail_jobs\")\n      .update({ status: \"failed\", processed_at: new Date().toISOString(), last_error: msg.slice(0, 500) })\n      .in(\"id\", claimed.map(j => j.id));\n    return { kind: \"failed\", claimedIds: claimed.map(j => j.id), error: msg };\n  }\n}\n\n\n\n// ---- Load settings (DB is source of truth) ----\nasync function loadSettings(): Promise<AppSettingsRow> {\n  const { data, error } = await sb\n    .from(\"app_settings\")\n    .select(\"email_notifications, admin_notification_emails, absence_requests, schedule_changes, employee_updates, system_updates, daily_digest, digest_time\")\n    .eq(\"id\", 1)\n    .maybeSingle();\n  if (error) throw error;\n  return data ?? {\n    email_notifications: true,\n    admin_notification_emails: [],\n    absence_requests: true,\n    schedule_changes: true,\n    employee_updates: false,\n    system_updates: false,\n    daily_digest: false,\n    digest_time: \"08:00\",\n  };\n}\n\n// ---- Process one job ----\nasync function processAdminNewAbsence(job: BaseJob, settings: AppSettingsRow) {\n  if (!settings.email_notifications) return \"skipped: email_notifications=false\";\n  if (!settings.absence_requests) return \"skipped: absence_requests=false\";\n  const recipients = settings.admin_notification_emails ?? [];\n  if (!Array.isArray(recipients) || recipients.length === 0) return \"skipped: no recipients\";\n\n  // Hae nimi\n  const { data: emp, error: empErr } = await sb\n    .from(\"employees\")\n    .select(\"name\")\n    .eq(\"id\", String(job.payload.employee_id))\n    .maybeSingle();\n\n  if (empErr) throw empErr;\n\n  const employeeName = emp?.name ?? \"Tuntematon\";\n  const s = String(job.payload.start_date);\n  const e = (job.payload.end_date ?? job.payload.start_date) as string;\n\n  const subject = `Uusi poissaolopyyntö: ${employeeName} (${s}${e !== s ? `–${e}` : \"\"})`;\n  const lines = [\n    `Työntekijä: ${employeeName}`,\n    `Ajankohta: ${s}${e !== s ? ` – ${e}` : \"\"}`,\n    job.payload.reason ? `Syy: ${String(job.payload.reason)}` : null,\n    // Voit halutessa lisätä dashboard-linkin .env:iin, esim. DASHBOARD_URL\n    Deno.env.get(\"DASHBOARD_URL\") ? `Avaa hallinta: ${Deno.env.get(\"DASHBOARD_URL\")}` : null,\n  ].filter(Boolean);\n  const text = lines.join(\"\\n\");\n\n  await sendEmail(recipients, subject, text);\n  return \"sent\";\n}\n\n// ---- New: employee shift changed ----\nasync function processEmployeeShiftChanged(job: BaseJob, settings: AppSettingsRow) {\n  if (!settings.email_notifications) return \"skipped: email_notifications=false\";\n  if (!settings.schedule_changes)    return \"skipped: schedule_changes=false\";\n\n  const p = job.payload as EmployeeShiftChangedPayload;\n  const empId = String(p.employee_id ?? \"\");\n  if (!empId) return \"skipped: no employee_id\";\n\n  const { data: emp, error: empErr } = await sb\n    .from(\"employees\")\n    .select(\"email,name\")\n    .eq(\"id\", empId)\n    .maybeSingle();\n  if (empErr) throw empErr;\n  const to = emp?.email;\n  if (!to) return \"skipped: employee has no email\";\n\n  const date = String(p.work_date ?? \"\");\n  const oldS = p.old_start ? String(p.old_start) : \"\";\n  const oldE = p.old_end   ? String(p.old_end)   : \"\";\n  const newS = p.new_start ? String(p.new_start) : \"\";\n  const newE = p.new_end   ? String(p.new_end)   : \"\";\n\n  const subject = `Työvuorosi on muuttunut (${date})`;\n  const lines = [\n    emp?.name ? `Hei ${emp.name},` : \"Hei,\",\n    \"\",\n    \"Työvuoriasi on päivitetty:\",\n    (oldS || oldE) ? `Aiemmin: ${oldS} – ${oldE}` : null,\n    `Uusi:    ${newS} – ${newE}`,\n    date ? `Päivä:   ${date}` : null,\n    \"\",\n    \"Jos tämä ei käy, ole yhteydessä esihenkilöön.\",\n    \"\",\n    \"Terveisin,\",\n    \"Soili\",\n  ].filter(Boolean).join(\"\\n\");\n\n  await sendEmail([to], subject, lines);\n  return \"sent\";\n}\n\n\n// ---- Main queue loop ----\nasync function processQueue(limit = 25) {\n  const settings = await loadSettings();\n\n  const { data: jobs, error } = await sb\n    .from(\"mail_jobs\")\n    .select(\"*\")\n    .eq(\"status\", \"queued\")\n    .order(\"created_at\", { ascending: true })\n    .limit(limit);\n\n  if (error) throw error;\n  if (!jobs || jobs.length === 0) return { processed: 0 };\n\n  let success = 0;\n  let failed = 0;\n\n  // Koonti voi “nielaista” monta jobia kerralla. Pidetään kirjaa niistä, ettei\n  // samaa satsiä käsitellä uudestaan saman loopin myöhemmillä iteraatioilla.\n  const skipIds = new Set<number>();\n\n  for (const job of jobs as BaseJob[]) {\n    if (skipIds.has(job.id)) continue; // jo käsitelty osana koontia\n    try {\n      let outcome = \"skipped\";\n      if (job.type === \"admin_new_absence\") {\n        outcome = await processAdminNewAbsence(job, settings);\n      } else if (isEmployeeJob(job.type)) {\n        // UUSI: koonti viimeisen N minuutin ikkunassa\n        const agg = await processEmployeeJobsAggregated(job, settings);\n        if (agg.kind === \"handled\") {\n          agg.claimedIds.forEach(id => skipIds.add(id));\n          success++;\n          continue; // koonti hoiti statukset\n        }\n        if (agg.kind === \"failed\") {\n          agg.claimedIds.forEach(id => skipIds.add(id));\n          failed++;\n          continue; // koonti hoiti statukset failediksi\n        }\n        // agg.kind === \"fallback\" → käsitellään normaalisti yksittäisenä alla\n      } else if (job.type === \"employee_shift_changed\") {\n        // (varalle; normaalisti yllä oleva haaraa jo tämän)\n        outcome = await processEmployeeShiftChanged(job, settings);\n      } else if (job.type === \"employee_new_shift\") {\n        outcome = await processEmployeeNewShift(job, settings);\n      } else if (job.type === \"employee_shift_deleted\") {\n        outcome = await processEmployeeShiftDeleted(job, settings);\n      } else {\n        outcome = `skipped: unknown type ${job.type}`;\n      }\n\n      // Päivitä tila\n      await sb\n        .from(\"mail_jobs\")\n        .update({\n          status: outcome.startsWith(\"sent\")\n            ? \"sent\"\n            : outcome.startsWith(\"skipped\")\n            ? \"sent\"\n            : \"failed\",\n          attempt_count: job.attempt_count + 1,\n          last_error: outcome.startsWith(\"sent\") ? null : outcome,\n          processed_at: new Date().toISOString(),\n        })\n        .eq(\"id\", job.id);\n\n      if (outcome.startsWith(\"sent\")) success++;\n      else if (!outcome.startsWith(\"skipped\")) failed++;\n    } catch (e: unknown) {\n      failed++;\n      const msg = e instanceof Error ? e.message : String(e);\n      await sb\n        .from(\"mail_jobs\")\n        .update({\n          status: \"failed\",\n          attempt_count: job.attempt_count + 1,\n          last_error: msg.slice(0, 500),\n          processed_at: new Date().toISOString(),\n        })\n        .eq(\"id\", job.id);\n    }\n  }\n\n\n  return { processed: jobs.length, success, failed };\n}\n\n// ---- Edge entrypoint ----\nDeno.serve(async () => {\n  try {\n    const res = await processQueue(25);\n    return new Response(JSON.stringify(res), {\n      headers: { \"Content-Type\": \"application/json\" },\n    });\n  } catch (e: unknown) {\n    const msg = e instanceof Error ? e.message : String(e);\n    return new Response(JSON.stringify({ error: msg }), { status: 500 });\n  }\n});\n\n",
        "byteOffset": 0,
        "totalChunks": 1,
        "hasMore": false,
        "startLine": 1,
        "endLine": 496
      }
    ]
  },
  {
    "path": "src/store/useSettingsStore.ts",
    "size": 6866,
    "sha256": "294dc83e38274572455d1850345f9353dccf732e12b7b0fedbc586d2b416199c",
    "lang": "typescript",
    "lines": 240,
    "modifiedAt": "2025-09-02T01:28:28+03:00",
    "commitSha": "29d28ab09b16112f6f64a83fb43e1143e63a0ed0",
    "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/store/useSettingsStore.ts",
    "chunks": [
      {
        "i": 0,
        "text": "// stores/useSettingsStore.ts\nimport { create } from \"zustand\";\nimport { persist, subscribeWithSelector } from \"zustand/middleware\";\nimport {\n  Settings,\n  SettingsSchema,\n  DEFAULT_SETTINGS,\n  Theme,\n} from \"@/lib/settingsSchema\";\n\ntype State = {\n  settings: Settings;\n\n  setAll: (s: Settings) => void;\n  reset: () => void;\n\n  updateGeneral: <K extends keyof Settings[\"general\"]>(\n    key: K,\n    value: Settings[\"general\"][K]\n  ) => void;\n\n  updateAutoGen: <K extends keyof Settings[\"autoGeneration\"]>(\n    key: K,\n    value: Settings[\"autoGeneration\"][K]\n  ) => void;\n\n  updateExport: <K extends keyof Settings[\"export\"]>(\n    key: K,\n    value: Settings[\"export\"][K]\n  ) => void;\n\n  updateNotifications: <K extends keyof Settings[\"notifications\"]>(\n    key: K,\n    value: Settings[\"notifications\"][K]\n  ) => void;\n\n  updateSystem: <K extends keyof Settings[\"system\"]>(\n    key: K,\n    value: Settings[\"system\"][K]\n  ) => void;\n\n  importFromJson: (raw: unknown) =>\n    | { ok: true }\n    | { ok: false; error: string };\n\n  exportToFile: () => void;\n  hasHydrated: boolean;\n  _setHydrated: (v: boolean) => void;\n};\n\n// ✅ OIKEA KOKOONPANO: persist(subscribeWithSelector(config), options)\nexport const useSettingsStore = create<State>()(\n  persist(\n    subscribeWithSelector<State>((set, get) => ({\n      settings: DEFAULT_SETTINGS,\n\n      setAll: (s) => set({ settings: s }),\n      reset: () => set({ settings: DEFAULT_SETTINGS }),\n\n      updateGeneral: (key, value) =>\n        set((st) => ({\n          settings: {\n            ...st.settings,\n            general: { ...st.settings.general, [key]: value },\n          },\n        })),\n\n      updateAutoGen: (key, value) =>\n        set((st) => ({\n          settings: {\n            ...st.settings,\n            autoGeneration: {\n              ...st.settings.autoGeneration,\n              [key]: value,\n            },\n          },\n        })),\n\n      updateExport: (key, value) =>\n        set((st) => ({\n          settings: {\n            ...st.settings,\n            export: { ...st.settings.export, [key]: value },\n          },\n        })),\n\n      updateNotifications: (key, value) =>\n        set((st) => ({\n          settings: {\n            ...st.settings,\n            notifications: {\n              ...st.settings.notifications,\n              [key]: value,\n            },\n          },\n        })),\n\n      updateSystem: (key, value) =>\n        set((st) => ({\n          settings: {\n            ...st.settings,\n            system: { ...st.settings.system, [key]: value },\n          },\n        })),\n\n      importFromJson: (raw) => {\n        let data: unknown = raw;\n        if (typeof raw === \"string\") {\n          try {\n            data = JSON.parse(raw);\n          } catch {\n            return {\n              ok: false as const,\n              error: \"Virheellinen JSON: ei voitu jäsentää.\",\n            };\n          }\n        }\n\n        const parsed = SettingsSchema.safeParse(data);\n        if (!parsed.success) {\n          const msg = parsed.error.issues\n            .map((i) => `${i.path.join(\".\") || \"(root)\"}: ${i.message}`)\n            .join(\"; \");\n          return { ok: false as const, error: msg };\n        }\n\n        set({ settings: parsed.data });\n        return { ok: true as const };\n      },\n\n      exportToFile: () => {\n        const data = JSON.stringify(get().settings, null, 2);\n        const blob = new Blob([data], { type: \"application/json\" });\n        const url = URL.createObjectURL(blob);\n        const a = document.createElement(\"a\");\n        a.href = url;\n        a.download = \"soili-settings.json\";\n        document.body.appendChild(a);\n        a.click();\n        a.remove();\n        URL.revokeObjectURL(url);\n      },\n\n      hasHydrated: false,\n      _setHydrated: (v) => set({ hasHydrated: v }),\n\n    })),\n    {\n      name: \"soili-settings-v2\",\n          version: 2,\nmigrate: (persisted: unknown): State => {\n  try {\n    // jos dataa ei ole → palauta default state\n    if (!persisted || typeof persisted !== \"object\") {\n      return { settings: DEFAULT_SETTINGS, hasHydrated: false, _setHydrated: () => {}, setAll: () => {}, reset: () => {}, updateGeneral: () => {}, updateAutoGen: () => {}, updateExport: () => {}, updateNotifications: () => {}, updateSystem: () => {}, importFromJson: () => ({ ok: false, error: \"not implemented\" }), exportToFile: () => {} } as State;\n    }\n\n    const st = persisted as State;\n    if (!st?.settings) {\n      return { ...st, settings: DEFAULT_SETTINGS };\n    }\n\n    const prevNotifs: Partial<Settings[\"notifications\"]> | undefined =\n      st.settings.notifications;\n\n    const nextNotifs: Settings[\"notifications\"] = {\n      ...prevNotifs,\n      adminNotificationEmails: Array.isArray(\n        prevNotifs?.adminNotificationEmails\n      )\n        ? prevNotifs!.adminNotificationEmails!\n        : [],\n      emailNotifications:\n        prevNotifs?.emailNotifications ?? DEFAULT_SETTINGS.notifications.emailNotifications,\n      absenceRequests:\n        prevNotifs?.absenceRequests ?? DEFAULT_SETTINGS.notifications.absenceRequests,\n      scheduleChanges:\n        prevNotifs?.scheduleChanges ?? DEFAULT_SETTINGS.notifications.scheduleChanges,\n      employeeUpdates:\n        prevNotifs?.employeeUpdates ?? DEFAULT_SETTINGS.notifications.employeeUpdates,\n      systemUpdates:\n        prevNotifs?.systemUpdates ?? DEFAULT_SETTINGS.notifications.systemUpdates,\n      dailyDigest:\n        prevNotifs?.dailyDigest ?? DEFAULT_SETTINGS.notifications.dailyDigest,\n      digestTime:\n        prevNotifs?.digestTime ?? DEFAULT_SETTINGS.notifications.digestTime,\n    };\n\n    return {\n      ...st,\n      settings: {\n        ...st.settings,\n        notifications: nextNotifs,\n      },\n    };\n  } catch {\n    // fallback jos jotain hajoaa → default state\n    return { settings: DEFAULT_SETTINGS } as State;\n  }\n},\n\n\n      onRehydrateStorage: () => (_state, error) => {\n        if (error) {\n          console.error(\"settings-store rehydrate failed\", error);\n          return;\n        }\n        _state?._setHydrated?.(true);\n      },\n    }\n  )\n);\n\n// (valinnainen) teema- ja push-sivuvaikutukset:\nif (typeof window !== \"undefined\") {\n  const applyTheme = (theme: Theme) => {\n    const root = document.documentElement;\n    const prefersDark =\n      window.matchMedia?.(\"(prefers-color-scheme: dark)\").matches;\n    const eff = theme === \"system\" ? (prefersDark ? \"dark\" : \"light\") : theme;\n    root.classList.remove(\"light\", \"dark\");\n    root.classList.add(eff);\n  };\n\n  applyTheme(useSettingsStore.getState().settings.general.theme);\n\n  useSettingsStore.subscribe(\n    (s) => s.settings.general.theme,\n    (theme) => applyTheme(theme)\n  );\n}\n\n// Apukoukku jos haluat kytkeä autosaven muualle\nexport function useAutoSaveConfig() {\n  return useSettingsStore((s) => ({\n    enabled: s.settings.general.autoSave,\n    intervalSec: s.settings.general.autoSaveInterval,\n  }));\n}\n",
        "byteOffset": 0,
        "totalChunks": 1,
        "hasMore": false,
        "startLine": 1,
        "endLine": 240
      }
    ]
  },
  {
    "path": "supabase/schema.sql",
    "size": 110448,
    "sha256": "b4f1ea6b4ebaf3d87550a385f5037efa47e0eca77babc8133c6bdfecc4e46bd8",
    "lang": "sql",
    "lines": 4000,
    "modifiedAt": "2025-09-02T01:28:28+03:00",
    "commitSha": "29d28ab09b16112f6f64a83fb43e1143e63a0ed0",
    "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/supabase/schema.sql",
    "chunks": [
      {
        "i": 0,
        "text": "--\n-- PostgreSQL database dump\n--\n\n\\restrict [REDACTED]\n\n-- Dumped from database version 17.4\n-- Dumped by pg_dump version 17.6 (Ubuntu 17.6-1.pgdg24.04+1)\n\nSET statement_timeout = 0;\nSET lock_timeout = 0;\nSET idle_in_transaction_session_timeout = 0;\nSET transaction_timeout = 0;\nSET client_encoding = 'UTF8';\nSET standard_conforming_strings = on;\nSELECT pg_catalog.set_config('search_path', '', false);\nSET check_function_bodies = false;\nSET xmloption = content;\nSET client_min_messages = warning;\nSET row_security = off;\n\n--\n-- Name: auth; Type: SCHEMA; Schema: -; Owner: -\n--\n\nCREATE SCHEMA auth;\n\n\n--\n-- Name: pg_cron; Type: EXTENSION; Schema: -; Owner: -\n--\n\nCREATE EXTENSION IF NOT EXISTS pg_cron WITH SCHEMA pg_catalog;\n\n\n--\n-- Name: EXTENSION pg_cron; Type: COMMENT; Schema: -; Owner: -\n--\n\nCOMMENT ON EXTENSION pg_cron IS 'Job scheduler for PostgreSQL';\n\n\n--\n-- Name: graphql; Type: SCHEMA; Schema: -; Owner: -\n--\n\nCREATE SCHEMA graphql;\n\n\n--\n-- Name: graphql_public; Type: SCHEMA; Schema: -; Owner: -\n--\n\nCREATE SCHEMA graphql_public;\n\n\n--\n-- Name: pg_net; Type: EXTENSION; Schema: -; Owner: -\n--\n\nCREATE EXTENSION IF NOT EXISTS pg_net WITH SCHEMA extensions;\n\n\n--\n-- Name: EXTENSION pg_net; Type: COMMENT; Schema: -; Owner: -\n--\n\nCOMMENT ON EXTENSION pg_net IS 'Async HTTP';\n\n\n--\n-- Name: pgbouncer; Type: SCHEMA; Schema: -; Owner: -\n--\n\nCREATE SCHEMA pgbouncer;\n\n\n--\n-- Name: realtime; Type: SCHEMA; Schema: -; Owner: -\n--\n\nCREATE SCHEMA realtime;\n\n\n--\n-- Name: storage; Type: SCHEMA; Schema: -; Owner: -\n--\n\nCREATE SCHEMA storage;\n\n\n--\n-- Name: supabase_migrations; Type: SCHEMA; Schema: -; Owner: -\n--\n\nCREATE SCHEMA supabase_migrations;\n\n\n--\n-- Name: vault; Type: SCHEMA; Schema: -; Owner: -\n--\n\nCREATE SCHEMA vault;\n\n\n--\n-- Name: pg_graphql; Type: EXTENSION; Schema: -; Owner: -\n--\n\nCREATE EXTENSION IF NOT EXISTS pg_graphql WITH SCHEMA graphql;\n\n\n--\n-- Name: EXTENSION pg_graphql; Type: COMMENT; Schema: -; Owner: -\n--\n\nCOMMENT ON EXTENSION pg_graphql IS 'pg_graphql: GraphQL support';\n\n\n--\n-- Name: pg_stat_statements; Type: EXTENSION; Schema: -; Owner: -\n--\n\nCREATE EXTENSION IF NOT EXISTS pg_stat_statements WITH SCHEMA extensions;\n\n\n--\n-- Name: EXTENSION pg_stat_statements; Type: COMMENT; Schema: -; Owner: -\n--\n\nCOMMENT ON EXTENSION pg_stat_statements IS 'track planning and execution statistics of all SQL statements executed';\n\n\n--\n-- Name: pgcrypto; Type: EXTENSION; Schema: -; Owner: -\n--\n\nCREATE EXTENSION IF NOT EXISTS pgcrypto WITH SCHEMA extensions;\n\n\n--\n-- Name: EXTENSION pgcrypto; Type: COMMENT; Schema: -; Owner: -\n--\n\nCOMMENT ON EXTENSION pgcrypto IS 'cryptographic functions';\n\n\n--\n-- Name: supabase_vault; Type: EXTENSION; Schema: -; Owner: -\n--\n\nCREATE EXTENSION IF NOT EXISTS supabase_vault WITH SCHEMA vault;\n\n\n--\n-- Name: EXTENSION supabase_vault; Type: COMMENT; Schema: -; Owner: -\n--\n\nCOMMENT ON EXTENSION supabase_vault IS 'Supabase Vault Extension';\n\n\n--\n-- Name: uuid-ossp; Type: EXTENSION; Schema: -; Owner: -\n--\n\nCREATE EXTENSION IF NOT EXISTS \"uuid-ossp\" WITH SCHEMA extensions;\n\n\n--\n-- Name: EXTENSION \"uuid-ossp\"; Type: COMMENT; Schema: -; Owner: -\n--\n\nCOMMENT ON EXTENSION \"uuid-ossp\" IS 'generate universally unique identifiers (UUIDs)';\n\n\n--\n-- Name: aal_level; Type: TYPE; Schema: auth; Owner: -\n--\n\nCREATE TYPE auth.aal_level AS ENUM (\n    'aal1',\n    'aal2',\n    'aal3'\n);\n\n\n--\n-- Name: code_challenge_method; Type: TYPE; Schema: auth; Owner: -\n--\n\nCREATE TYPE auth.code_challenge_method AS ENUM (\n    's256',\n    'plain'\n);\n\n\n--\n-- Name: factor_status; Type: TYPE; Schema: auth; Owner: -\n--\n\nCREATE TYPE auth.factor_status AS ENUM (\n    'unverified',\n    'verified'\n);\n\n\n--\n-- Name: factor_type; Type: TYPE; Schema: auth; Owner: -\n--\n\nCREATE TYPE auth.factor_type AS ENUM (\n    'totp',\n    'webauthn',\n    'phone'\n);\n\n\n--\n-- Name: one_time_token_type; Type: TYPE; Schema: auth; Owner: -\n--\n\nCREATE TYPE auth.one_time_token_type AS ENUM (\n    'confirmation_token',\n    'reauthentication_token',\n    'recovery_token',\n    'email_change_token_new',\n    'email_change_token_current',\n    'phone_change_token'\n);\n\n\n--\n-- Name: action; Type: TYPE; Schema: realtime; Owner: -\n--\n\nCREATE TYPE realtime.action AS ENUM (\n    'INSERT',\n    'UPDATE',\n    'DELETE',\n    'TRUNCATE',\n    'ERROR'\n);\n\n\n--\n-- Name: equality_op; Type: TYPE; Schema: realtime; Owner: -\n--\n\nCREATE TYPE realtime.equality_op AS ENUM (\n    'eq',\n    'neq',\n    'lt',\n    'lte',\n    'gt',\n    'gte',\n    'in'\n);\n\n\n--\n-- Name: user_defined_filter; Type: TYPE; Schema: realtime; Owner: -\n--\n\nCREATE TYPE realtime.user_defined_filter AS (\n\tcolumn_name text,\n\top realtime.equality_op,\n\tvalue text\n);\n\n\n--\n-- Name: wal_column; Type: TYPE; Schema: realtime; Owner: -\n--\n\nCREATE TYPE realtime.wal_column AS (\n\tname text,\n\ttype_name text,\n\ttype_oid oid,\n\tvalue jsonb,\n\tis_pkey boolean,\n\tis_selectable boolean\n);\n\n\n--\n-- Name: wal_rls; Type: TYPE; Schema: realtime; Owner: -\n--\n\nCREATE TYPE realtime.wal_rls AS (\n\twal jsonb,\n\tis_rls_enabled boolean,\n\tsubscription_ids uuid[],\n\terrors text[]\n);\n\n\n--\n-- Name: email(); Type: FUNCTION; Schema: auth; Owner: -\n--\n\nCREATE FUNCTION auth.email() RETURNS text\n    LANGUAGE sql STABLE\n    AS $$\n  select \n  coalesce(\n    nullif(current_setting('request.jwt.claim.email', true), ''),\n    (nullif(current_setting('request.jwt.claims', true), '')::jsonb ->> 'email')\n  )::text\n$$;\n\n\n--\n-- Name: FUNCTION email(); Type: COMMENT; Schema: auth; Owner: -\n--\n\nCOMMENT ON FUNCTION auth.email() IS 'Deprecated. Use auth.jwt() -> ''email'' instead.';\n\n\n--\n-- Name: jwt(); Type: FUNCTION; Schema: auth; Owner: -\n--\n\nCREATE FUNCTION auth.jwt() RETURNS jsonb\n    LANGUAGE sql STABLE\n    AS $$\n  select \n    coalesce(\n        nullif(current_setting('request.jwt.claim', true), ''),\n        nullif(current_setting('request.jwt.claims', true), '')\n    )::jsonb\n$$;\n\n\n--\n-- Name: role(); Type: FUNCTION; Schema: auth; Owner: -\n--\n\nCREATE FUNCTION auth.role() RETURNS text\n    LANGUAGE sql STABLE\n    AS $$\n  select \n  coalesce(\n    nullif(current_setting('request.jwt.claim.role', true), ''),\n    (nullif(current_setting('request.jwt.claims', true), '')::jsonb ->> 'role')\n  )::text\n$$;\n\n\n--\n-- Name: FUNCTION role(); Type: COMMENT; Schema: auth; Owner: -\n--\n\nCOMMENT ON FUNCTION auth.role() IS 'Deprecated. Use auth.jwt() -> ''role'' instead.';\n\n\n--\n-- Name: uid(); Type: FUNCTION; Schema: auth; Owner: -\n--\n\nCREATE FUNCTION auth.uid() RETURNS uuid\n    LANGUAGE sql STABLE\n    AS $$\n  select \n  coalesce(\n    nullif(current_setting('request.jwt.claim.sub', true), ''),\n    (nullif(current_setting('request.jwt.claims', true), '')::jsonb ->> 'sub')\n  )::uuid\n$$;\n\n\n--\n-- Name: FUNCTION uid(); Type: COMMENT; Schema: auth; Owner: -\n--\n\nCOMMENT ON FUNCTION auth.uid() IS 'Deprecated. Use auth.jwt() -> ''sub'' instead.';\n\n\n--\n-- Name: get_auth(text); Type: FUNCTION; Schema: pgbouncer; Owner: -\n--\n\nCREATE FUNCTION pgbouncer.get_auth(p_usename text) RETURNS TABLE(username text, password text)\n    LANGUAGE plpgsql SECURITY DEFINER\n    AS $_$\nbegin\n    raise debug 'PgBouncer auth request: %', p_usename;\n\n    return query\n    select \n        rolname::text, \n        case when rolvaliduntil < now() \n            then null \n            else rolpassword::text \n        end \n    from pg_authid \n    where rolname=$1 and rolcanlogin;\nend;\n$_$;\n\n\nSET default_tablespace = '';\n\nSET default_table_access_method = heap;\n\n--\n-- Name: mail_jobs; Type: TABLE; Schema: public; Owner: -\n--\n\nCREATE TABLE public.mail_jobs (\n    id bigint NOT NULL,\n    type text NOT NULL,\n    payload jsonb NOT NULL,\n    status text DEFAULT 'queued'::text NOT NULL,\n    attempt_count integer DEFAULT 0 NOT NULL,\n    last_error text,\n    created_at timestamp with time zone DEFAULT now() NOT NULL,\n    processed_at timestamp with time zone,\n    job_key text GENERATED ALWAYS AS (\nCASE\n    WHEN (type = 'admin_new_absence'::text) THEN (((((payload ->> 'employee_id'::text) || '|'::text) || (payload ->> 'start_date'::text)) || '|'::text) || COALESCE((payload ->> 'end_date'::text), ''::text))\n    ELSE NULL::text\nEND) STORED\n);\n\n\n--\n-- Name: claim_employee_jobs(text, timestamp with time zone, text[], integer); Type: FUNCTION; Schema: public; Owner: -\n--\n\nCREATE FUNCTION public.claim_employee_jobs(p_employee_id text, p_since timestamp with time zone, p_types text[], p_limit integer DEFAULT 200) RETURNS SETOF public.mail_jobs\n    LANGUAGE sql SECURITY DEFINER\n    SET search_path TO 'public'\n    AS $$\n  with candidate as (\n    select id\n    from public.mail_jobs\n    where status = 'queued'\n      and created_at >= p_since\n      and type = any(p_types)\n      and payload->>'employee_id' = p_employee_id\n    order by created_at asc\n    limit p_limit\n  ),\n  locked as (\n    update public.mail_jobs m\n      set status = 'processing',\n          processed_at = now(),\n          attempt_count = m.attempt_count + 1\n    where m.id in (select id from candidate)\n      and m.status = 'queued'\n    returning m.*\n  )\n  select * from locked;\n$$;\n\n\n--\n-- Name: claim_employee_jobs(uuid, timestamp with time zone, text[], integer); Type: FUNCTION; Schema: public; Owner: -\n--\n\nCREATE FUNCTION public.claim_employee_jobs(p_employee_id uuid, p_since timestamp with time zone, p_types text[], p_limit integer DEFAULT 200) RETURNS SETOF public.mail_jobs\n    LANGUAGE plpgsql SECURITY DEFINER\n    SET search_path TO 'public'\n    AS $$\nbegin\n  return query\n  with cte as (\n    select id\n    from mail_jobs\n    where status = 'queued'\n      and (payload->>'employee_id') = p_employee_id::text\n      and type = any(p_types)\n      and created_at >= p_since\n    order by created_at asc\n    limit p_limit\n    for update skip locked\n  )\n  update mail_jobs m\n  set status = 'processing'\n  from cte\n  where m.id = cte.id\n  returning m.*;\nend;\n$$;\n\n\n--\n-- Name: enqueue_admin_new_absence(); Type: FUNCTION; Schema: public; Owner: -\n--\n\nCREATE FUNCTION public.enqueue_admin_new_absence() RETURNS trigger\n    LANGUAGE plpgsql SECURITY DEFINER\n    AS $$\nDECLARE\n  cfg RECORD;\n  _end_date date;\nBEGIN\n  SELECT email_notifications, absence_requests, admin_notification_emails\n    INTO cfg\n  FROM public.app_settings\n  WHERE id = 1;\n\n  IF COALESCE(cfg.email_notifications,false) IS NOT TRUE THEN RETURN NEW; END IF;\n  IF COALESCE(cfg.absence_requests,false)     IS NOT TRUE THEN RETURN NEW; END IF;\n  IF cfg.admin_notification_emails IS NULL\n     OR array_length(cfg.admin_notification_emails,1) < 1 THEN\n    RETURN NEW;\n  END IF;\n\n  -- normalisoi: jos end_date puuttuu → start_date\n  _end_date := COALESCE(NEW.end_date, NEW.start_date);\n\n  INSERT INTO public.mail_jobs (type, status, attempt_count, payload)\n  VALUES (\n    'admin_new_absence',\n    'queued',\n    0,\n    jsonb_build_object(\n      'employee_id', NEW.employee_id,\n      'start_date', NEW.start_date,\n      'end_date',   _end_date,\n      'reason',     NEW.reason\n    )\n  )\n  ON CONFLICT (job_key) DO NOTHING;  -- nyt toimii, koska on UNIQUE CONSTRAINT\n\n  -- älä kaada inserttiä vaikka HTTP failaa\n  BEGIN\n    PERFORM net.http_post(\n      url     := 'https://musrmpblsazxcrhwthtc.functions.supabase.co/mailer',\n      headers := jsonb_build_object('Authorization','Bearer '||'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.[REDACTED].k6zU1Eiif-06XVvlHMugfxsL-ZFnXiTuf5Qg28r5x8A'),\n      body    := '{}'::jsonb\n    );\n  EXCEPTION WHEN OTHERS THEN\n    NULL;\n  END;\n\n  RETURN NEW;\nEND;\n$$;\n\n\n--\n-- Name: enqueue_employee_new_shift(); Type: FUNCTION; Schema: public; Owner: -\n--\n\nCREATE FUNCTION public.enqueue_employee_new_shift() RETURNS trigger\n    LANGUAGE plpgsql\n    AS $$\nbegin\n  if new.published is true then\n    insert into public.mail_jobs(type, payload)\n    values ('employee_new_shift', jsonb_build_object(\n      'employee_id', new.employee_id,\n      'work_date', new.work_date::text,\n      'start', new.start_time::text,\n      'end', new.end_time::text\n    ));\n  end if;\n  return new;\nend$$;\n\n\n--\n-- Name: enqueue_employee_shift_changed(); Type: FUNCTION; Schema: public; Owner: -\n--\n\nCREATE FUNCTION public.enqueue_employee_shift_changed() RETURNS trigger\n    LANGUAGE plpgsql\n    AS $$\ndeclare\n  changed boolean := false;\nbegin\n  -- ilmoita vain jos new.published=true\n  if new.published is not true then\n    return new;\n  end if;\n\n  if (old.employee_id is distinct from new.employee_id)\n     or (old.start_time  is distinct from new.start_time)\n     or (old.end_time    is distinct from new.end_time)\n     or (old.work_date   is distinct from new.work_date) then\n    changed := true;\n  end if;\n\n  if changed then\n    insert into public.mail_jobs(type, payload)\n    values ('employee_shift_changed', jsonb_build_object(\n      'employee_id', new.employee_id,\n      'work_date', new.work_date::text,\n      'old_start', old.start_time::text,\n      'old_end',   old.end_time::text,\n      'new_start', new.start_time::text,\n      'new_end',   new.end_time::text\n    ));\n\n    -- BONUS (listasi kohta 4): jos työntekijä vaihtui, ilmoita vanhalle \"removed\"\n    if old.employee_id is distinct from new.employee_id then\n      insert into public.mail_jobs(type, payload)\n      values ('employee_shift_deleted', jsonb_build_object(\n        'employee_id', old.employee_id,\n        'work_date',   coalesce(new.work_date, old.work_date)::text,\n        'start',       old.start_time::text,\n        'end',         old.end_time::text\n      ));\n    end if;\n  end if;\n\n  return new;\nend$$;\n\n\n--\n-- Name: enqueue_employee_shift_deleted(); Type: FUNCTION; Schema: public; Owner: -\n--\n\nCREATE FUNCTION public.enqueue_employee_shift_deleted() RETURNS trigger\n    LANGUAGE plpgsql\n    AS $$\nbegin\n  -- ilmoita vain jos poistettava rivi oli julkaistu\n  if old.published is true then\n    insert into public.mail_jobs(type, payload)\n    values ('employee_shift_deleted', jsonb_build_object(\n      'employee_id', old.employee_id,\n      'work_date',   old.work_date::text,\n      'start',       old.start_time::text,\n      'end',         old.end_time::text\n    ));\n  end if;\n  return old;\nend$$;\n\n\n--\n-- Name: enqueue_on_publish_flip(); Type: FUNCTION; Schema: public; Owner: -\n--\n\nCREATE FUNCTION public.enqueue_on_publish_flip() RETURNS trigger\n    LANGUAGE plpgsql\n    AS $$\nbegin\n  if old.published is distinct from new.published and new.published is true then\n    new.published_at := coalesce(new.published_at, now());\n    insert into public.mail_jobs(type, payload)\n    values ('employee_new_shift', jsonb_build_object(\n      'employee_id', new.employee_id,\n      'work_date',   new.work_date::text,\n      'start',       new.start_time::text,\n      'end',         new.end_time::text\n    ));\n  end if;\n  return new;\nend$$;\n\n\n--\n-- Name: notify_absence_insert(); Type: FUNCTION; Schema: public; Owner: -\n--\n\nCREATE FUNCTION public.notify_absence_insert() RETURNS trigger\n    LANGUAGE plpgsql SECURITY DEFINER\n    SET search_path TO 'public'\n    AS $$\nbegin\n  insert into public.notifications(type, title, message)\n  values (\n    'absence_request',\n    'Uusi poissaolopyyntö',\n    'Työntekijä ' || coalesce((select name from public.employees e where e.id = new.employee_id), 'Tuntematon')\n      || ' on jättänyt poissaolopyynnön ' || new.start_date::text\n      || coalesce(' – ' || new.end_date::text, '')\n  );\n  return new;\nend $$;\n\n\n--\n-- Name: notify_absence_status_update(); Type: FUNCTION; Schema: public; Owner: -\n--\n\nCREATE FUNCTION public.notify_absence_status_update() RETURNS trigger\n    LANGUAGE plpgsql SECURITY DEFINER\n    SET search_path TO 'public'\n    AS $$\nbegin\n  if new.status is distinct from old.status then\n    if new.status = 'approved' then\n      insert into public.notifications(type, title, message)\n      values (\n        'absence_approved',\n        'Poissaolo hyväksytty',\n        'Poissaolo ('|| new.start_date::text || coalesce(' – '||new.end_date::text,'') || ') hyväksyttiin.'\n      );\n    elsif new.status = 'declined' then\n      insert into public.notifications(type, title, message)\n      values (\n        'absence_declined',\n        'Poissaolo hylätty',\n        'Poissaolopyyntö hylättiin.'\n      );\n    end if;\n  end if;\n  return new;\nend $$;\n\n\n--\n-- Name: notify_employee_added(); Type: FUNCTION; Schema: public; Owner: -\n--\n\nCREATE FUNCTION public.notify_employee_added() RETURNS trigger\n    LANGUAGE plpgsql SECURITY DEFINER\n    SET search_path TO 'public'\n    AS $$\nbegin\n  insert into public.notifications(type, title, message)\n  values (\n    'employee_added',\n    'Uusi työntekijä',\n    coalesce(new.name,'Tuntematon') || ' on lisätty järjestelmään.'\n  );\n  return new;\nend $$;\n\n\n--\n-- Name: set_updated_at(); Type: FUNCTION; Schema: public; Owner: -\n--\n\nCREATE FUNCTION public.set_updated_at() RETURNS trigger\n    LANGUAGE plpgsql\n    AS $$\nbegin\n  new.updated_at = now();\n  return new;\nend; $$;\n\n\n--\n-- Name: trg_absence_enqueue_job(); Type: FUNCTION; Schema: public; Owner: -\n--\n\nCREATE FUNCTION public.trg_absence_enqueue_job() RETURNS trigger\n    LANGUAGE plpgsql\n    AS $$\nbegin\n  insert into mail_jobs (type, payload)\n  values (\n    'admin_new_absence',\n    jsonb_build_object(\n      'absence_id', new.id,\n      'employee_id', new.employee_id,\n      'start_date', new.start_date,\n      'end_date', new.end_date,\n      'reason', new.reason\n    )\n  );\n  return new;\nend;\n$$;\n\n\n--\n-- Name: apply_rls(jsonb, integer); Type: FUNCTION; Schema: realtime; Owner: -\n--\n\nCREATE FUNCTION realtime.apply_rls(wal jsonb, max_record_bytes integer DEFAULT (1024 * 1024)) RETURNS SETOF realtime.wal_rls\n    LANGUAGE plpgsql\n    AS $$\ndeclare\n-- Regclass of the table e.g. public.notes\nentity_ regclass = (quote_ident(wal ->> 'schema') || '.' || quote_ident(wal ->> 'table'))::regclass;\n\n-- I, U, D, T: insert, update ...\naction realtime.action = (\n    case wal ->> 'action'\n        when 'I' then 'INSERT'\n        when 'U' then 'UPDATE'\n        when 'D' then 'DELETE'\n        else 'ERROR'\n    end\n);\n\n-- Is row level security enabled for the table\nis_rls_enabled bool = relrowsecurity from pg_class where oid = entity_;\n\nsubscriptions realtime.subscription[] = array_agg(subs)\n    from\n        realtime.subscription subs\n    where\n        subs.entity = entity_;\n\n-- Subscription vars\nroles regrole[] = array_agg(distinct us.claims_role::text)\n    from\n        unnest(subscriptions) us;\n\nworking_role regrole;\nclaimed_role regrole;\nclaims jsonb;\n\nsubscription_id uuid;\nsubscription_has_access bool;\nvisible_to_subscription_ids uuid[] = '{}';\n\n-- structured info for wal's columns\ncolumns realtime.wal_column[];\n-- previous identity values for update/delete\nold_columns realtime.wal_column[];\n\nerror_record_exceeds_max_size boolean = octet_length(wal::text) > max_record_bytes;\n\n-- Primary jsonb output for record\noutput jsonb;\n\nbegin\nperform set_config('role', null, true);\n\ncolumns =\n    array_agg(\n        (\n            x->>'name',\n            x->>'type',\n            x->>'typeoid',\n            realtime.cast(\n                (x->'value') #>> '{}',\n                coalesce(\n                    (x->>'typeoid')::regtype, -- null when wal2json version <= 2.4\n                    (x->>'type')::regtype\n                )\n            ),\n            (pks ->> 'name') is not null,\n            true\n        )::realtime.wal_column\n    )\n    from\n        jsonb_array_elements(wal -> 'columns') x\n        left join jsonb_array_elements(wal -> 'pk') pks\n            on (x ->> 'name') = (pks ->> 'name');\n\nold_columns =\n    array_agg(\n        (\n            x->>'name',\n            x->>'type',\n            x->>'typeoid',\n            realtime.cast(\n                (x->'value') #>> '{}',\n                coalesce(\n                    (x->>'typeoid')::regtype, -- null when wal2json version <= 2.4\n                    (x->>'type')::regtype\n                )\n            ),\n            (pks ->> 'name') is not null,\n            true\n        )::realtime.wal_column\n    )\n    from\n        jsonb_array_elements(wal -> 'identity') x\n        left join jsonb_array_elements(wal -> 'pk') pks\n            on (x ->> 'name') = (pks ->> 'name');\n\nfor working_role in select * from unnest(roles) loop\n\n    -- Update `is_selectable` for columns and old_columns\n    columns =\n        array_agg(\n            (\n                c.name,\n                c.type_name,\n                c.type_oid,\n                c.value,\n                c.is_pkey,\n                pg_catalog.has_column_privilege(working_role, entity_, c.name, 'SELECT')\n            )::realtime.wal_column\n        )\n        from\n            unnest(columns) c;\n\n    old_columns =\n            array_agg(\n                (\n                    c.name,\n                    c.type_name,\n                    c.type_oid,\n                    c.value,\n                    c.is_pkey,\n                    pg_catalog.has_column_privilege(working_role, entity_, c.name, 'SELECT')\n                )::realtime.wal_column\n            )\n            from\n                unnest(old_columns) c;\n\n    if action <> 'DELETE' and count(1) = 0 from unnest(columns) c where c.is_pkey then\n        return next (\n            jsonb_build_object(\n                'schema', wal ->> 'schema',\n                'table', wal ->> 'table',\n                'type', action\n            ),\n            is_rls_enabled,\n            -- subscriptions is already filtered by entity\n            (select array_agg(s.subscription_id) from unnest(subscriptions) as s where claims_role = working_role),\n            array['Error 400: Bad Request, no primary key']\n        )::realtime.wal_rls;\n\n    -- The claims role does not have SELECT permission to the primary key of entity\n    elsif action <> 'DELETE' and sum(c.is_selectable::int) <> count(1) from unnest(columns) c where c.is_pkey then\n        return next (\n            jsonb_build_object(\n                'schema', wal ->> 'schema',\n                'table', wal ->> 'table',\n                'type', action\n            ),\n            is_rls_enabled,\n            (select array_agg(s.subscription_id) from unnest(subscriptions) as s where claims_role = working_role),\n            array['Error 401: Unauthorized']\n        )::realtime.wal_rls;\n\n    else\n        output = jsonb_build_object(\n            'schema', wal ->> 'schema',\n            'table', wal ->> 'table',\n            'type', action,\n            'commit_timestamp', to_char(\n                ((wal ->> 'timestamp')::timestamptz at time zone 'utc'),\n                'YYYY-MM-DD\"T\"HH24:MI:SS.MS\"Z\"'\n            ),\n            'columns', (\n                select\n                    jsonb_agg(\n                        jsonb_build_object(\n                            'name', pa.attname,\n                            'type', pt.typname\n                        )\n                        order by pa.attnum asc\n                    )\n                from\n                    pg_attribute pa\n                    join pg_type pt\n                        on pa.atttypid = pt.oid\n                where\n                    attrelid = entity_\n                    and attnum > 0\n                    and pg_catalog.has_column_privilege(working_role, entity_, pa.attname, 'SELECT')\n            )\n        )\n        -- Add \"record\" key for insert and update\n        || case\n            when action in ('INSERT', 'UPDATE') then\n                jsonb_build_object(\n                    'record',\n                    (\n                        select\n                            jsonb_object_agg(\n                                -- if unchanged toast, get column name and value from old record\n                                coalesce((c).name, (oc).name),\n                                case\n                                    when (c).name is null then (oc).value\n                                    else (c).value\n                                end\n                            )\n                        from\n                            unnest(columns) c\n                            full outer join unnest(old_columns) oc\n                                on (c).name = (oc).name\n                        where\n                            coalesce((c).is_selectable, (oc).is_selectable)\n                            and ( not error_record_exceeds_max_size or (octet_length((c).value::text) <= 64))\n                    )\n                )\n            else '{}'::jsonb\n        end\n        -- Add \"old_record\" key for update and delete\n        || case\n            when action = 'UPDATE' then\n                jsonb_build_object(\n                        'old_record',\n                        (\n                            select jsonb_object_agg((c).name, (c).value)\n                            from unnest(old_columns) c\n                            where\n                                (c).is_selectable\n                                and ( not error_record_exceeds_max_size or (octet_length((c).value::text) <= 64))\n                        )\n                    )\n            when action = 'DELETE' then\n                jsonb_build_object(\n                    'old_record',\n                    (\n                        select jsonb_object_agg((c).name, (c).value)\n                        from unnest(old_columns) c\n                        where\n                            (c).is_selectable\n                            and ( not error_record_exceeds_max_size or (octet_length((c).value::text) <= 64))\n                            and ( not is_rls_enabled or (c).is_pkey ) -- if RLS enabled, we can't secure deletes so filter to pkey\n                    )\n                )\n            else '{}'::jsonb\n        end;\n\n        -- Create the prepared statement\n        if is_rls_enabled and action <> 'DELETE' then\n            if (select 1 from pg_prepared_statements where name = 'walrus_rls_stmt' limit 1) > 0 then\n                deallocate walrus_rls_stmt;\n            end if;\n            execute realtime.build_prepared_statement_sql('walrus_rls_stmt', entity_, columns);\n        end if;\n\n        visible_to_subscription_ids = '{}';\n\n        for subscription_id, claims in (\n                select\n                    subs.subscription_id,\n                    subs.claims\n                from\n                    unnest(subscriptions) subs\n                where\n                    subs.entity = entity_\n                    and subs.claims_role = working_role\n                    and (\n                        realtime.is_visible_through_filters(columns, subs.filters)\n                        or (\n                          action = 'DELETE'\n                          and realtime.is_visible_through_filters(old_columns, subs.filters)\n                        )\n                    )\n        ) loop\n\n            if not is_rls_enabled or action = 'DELETE' then\n                visible_to_subscription_ids = visible_to_subscription_ids || subscription_id;\n            else\n                -- Check if RLS allows the role to see the record\n                perform\n                    -- Trim leading and trailing quotes from working_role because set_config\n                    -- doesn't recognize the role as valid if they are included\n                    set_config('role', trim(both '\"' from working_role::text), true),\n                    set_config('request.jwt.claims', claims::text, true);\n\n                execute 'execute walrus_rls_stmt' into subscription_has_access;\n\n                if subscription_has_access then\n                    visible_to_subscription_ids = visible_to_subscription_ids || subscription_id;\n                end if;\n            end if;\n        end loop;\n\n        perform set_config('role', null, true);\n\n        return next (\n            output,\n            is_rls_enabled,\n            visible_to_subscription_ids,\n            case\n                when error_record_exceeds_max_size then array['Error 413: Payload Too Large']\n                else '{}'\n            end\n        )::realtime.wal_rls;\n\n    end if;\nend loop;\n\nperform set_config('role', null, true);\nend;\n$$;\n\n\n--\n-- Name: broadcast_changes(text, text, text, text, text, record, record, text); Type: FUNCTION; Schema: realtime; Owner: -\n--\n\nCREATE FUNCTION realtime.broadcast_changes(topic_name text, event_name text, operation text, table_name text, table_schema text, new record, old record, level text DEFAULT 'ROW'::text) RETURNS void\n    LANGUAGE plpgsql\n    AS $$\nDECLARE\n    -- Declare a variable to hold the JSONB representation of the row\n    row_data jsonb := '{}'::jsonb;\nBEGIN\n    IF level = 'STATEMENT' THEN\n        RAISE EXCEPTION 'function can only be triggered for each row, not for each statement';\n    END IF;\n    -- Check the operation type and handle accordingly\n    IF operation = 'INSERT' OR operation = 'UPDATE' OR operation = 'DELETE' THEN\n        row_data := jsonb_build_object('old_record', OLD, 'record', NEW, 'operation', operation, 'table', table_name, 'schema', table_schema);\n        PERFORM realtime.send (row_data, event_name, topic_name);\n    ELSE\n        RAISE EXCEPTION 'Unexpected operation type: %', operation;\n    END IF;\nEXCEPTION\n    WHEN OTHERS THEN\n        RAISE EXCEPTION 'Failed to process the row: %', SQLERRM;\nEND;\n\n$$;\n\n\n--\n-- Name: build_prepared_statement_sql(text, regclass, realtime.wal_column[]); Type: FUNCTION; Schema: realtime; Owner: -\n--\n\nCREATE FUNCTION realtime.build_prepared_statement_sql(prepared_statement_name text, entity regclass, columns realtime.wal_column[]) RETURNS text\n    LANGUAGE sql\n    AS $$\n      /*\n      Builds a sql string that, if executed, creates a prepared statement to\n      tests retrive a row from *entity* by its primary key columns.\n      Example\n          select realtime.build_prepared_statement_sql('public.notes', '{\"id\"}'::text[], '{\"bigint\"}'::text[])\n      */\n          select\n      'prepare ' || prepared_statement_name || ' as\n          select\n              exists(\n                  select\n                      1\n                  from\n                      ' || entity || '\n                  where\n                      ' || string_agg(quote_ident(pkc.name) || '=' || quote_nullable(pkc.value #>> '{}') , ' and ') || '\n              )'\n          from\n              unnest(columns) pkc\n          where\n              pkc.is_pkey\n          group by\n              entity\n      $$;\n\n\n--\n-- Name: cast(text, regtype); Type: FUNCTION; Schema: realtime; Owner: -\n--\n\nCREATE FUNCTION realtime.\"cast\"(val text, type_ regtype) RETURNS jsonb\n    LANGUAGE plpgsql IMMUTABLE\n    AS $$\n    declare\n      res jsonb;\n    begin\n      execute format('select to_jsonb(%L::'|| type_::text || ')', val)  into res;\n      return res;\n    end\n    $$;\n\n\n--\n-- Name: check_equality_op(realtime.equality_op, regtype, text, text); Type: FUNCTION; Schema: realtime; Owner: -\n--\n\nCREATE FUNCTION realtime.check_equality_op(op realtime.equality_op, type_ regtype, val_1 text, val_2 text) RETURNS boolean\n    LANGUAGE plpgsql IMMUTABLE\n    AS $$\n      /*\n      Casts *val_1* and *val_2* as type *type_* and check the *op* condition for truthiness\n      */\n      declare\n          op_symbol text = (\n              case\n                  when op = 'eq' then '='\n                  when op = 'neq' then '!='\n                  when op = 'lt' then '<'\n                  when op = 'lte' then '<='\n                  when op = 'gt' then '>'\n                  when op = 'gte' then '>='\n                  when op = 'in' then '= any'\n                  else 'UNKNOWN OP'\n              end\n          );\n          res boolean;\n      begin\n          execute format(\n              'select %L::'|| type_::text || ' ' || op_symbol\n              || ' ( %L::'\n              || (\n                  case\n                      when op = 'in' then type_::text || '[]'\n                      else type_::text end\n              )\n              || ')', val_1, val_2) into res;\n          return res;\n      end;\n      $$;\n\n\n--\n-- Name: is_visible_through_filters(realtime.wal_column[], realtime.user_defined_filter[]); Type: FUNCTION; Schema: realtime; Owner: -\n--\n\nCREATE FUNCTION realtime.is_visible_through_filters(columns realtime.wal_column[], filters realtime.user_defined_filter[]) RETURNS boolean\n    LANGUAGE sql IMMUTABLE\n    AS $_$\n    /*\n    Should the record be visible (true) or filtered out (false) after *filters* are applied\n    */\n        select\n            -- Default to allowed when no filters present\n            $2 is null -- no filters. this should not happen because subscriptions has a default\n            or array_length($2, 1) is null -- array length of an empty array is null\n            or bool_and(\n                coalesce(\n                    realtime.check_equality_op(\n                        op:=f.op,\n                        type_:=coalesce(\n                            col.type_oid::regtype, -- null when wal2json version <= 2.4\n                            col.type_name::regtype\n                        ),\n                        -- cast jsonb to text\n                        val_1:=col.value #>> '{}',\n                        val_2:=f.value\n                    ),\n                    false -- if null, filter does not match\n                )\n            )\n        from\n            unnest(filters) f\n            join unnest(columns) col\n                on f.column_name = col.name;\n    $_$;\n\n\n--\n-- Name: list_changes(name, name, integer, integer); Type: FUNCTION; Schema: realtime; Owner: -\n--\n\nCREATE FUNCTION realtime.list_changes(publication name, slot_name name, max_changes integer, max_record_bytes integer) RETURNS SETOF realtime.wal_rls\n    LANGUAGE sql\n    SET log_min_messages TO 'fatal'\n    AS $$\n      with pub as (\n        select\n          concat_ws(\n            ',',\n            case when bool_or(pubinsert) then 'insert' else null end,\n            case when bool_or(pubupdate) then 'update' else null end,\n            case when bool_or(pubdelete) then 'delete' else null end\n          ) as w2j_actions,\n          coalesce(\n            string_agg(\n              realtime.quote_wal2json(format('%I.%I', schemaname, tablename)::regclass),\n              ','\n            ) filter (where ppt.tablename is not null and ppt.tablename not like '% %'),\n            ''\n          ) w2j_add_tables\n        from\n          pg_publication pp\n          left join pg_publication_tables ppt\n            on pp.pubname = ppt.pubname\n        where\n          pp.pubname = publication\n        group by\n          pp.pubname\n        limit 1\n      ),\n      w2j as (\n        select\n          x.*, pub.w2j_add_tables\n        from\n          pub,\n          pg_logical_slot_get_changes(\n            slot_name, null, max_changes,\n            'include-pk', 'true',\n            'include-transaction', 'false',\n            'include-timestamp', 'true',\n            'include-type-oids', 'true',\n            'format-version', '2',\n            'actions', pub.w2j_actions,\n            'add-tables', pub.w2j_add_tables\n          ) x\n      )\n      select\n        xyz.wal,\n        xyz.is_rls_enabled,\n        xyz.subscription_ids,\n        xyz.errors\n      from\n        w2j,\n        realtime.apply_rls(\n          wal := w2j.data::jsonb,\n          max_record_bytes := max_record_bytes\n        ) xyz(wal, is_rls_enabled, subscription_ids, errors)\n      where\n        w2j.w2j_add_tables <> ''\n        and xyz.subscription_ids[1] is not null\n    $$;\n\n\n--\n-- Name: quote_wal2json(regclass); Type: FUNCTION; Schema: realtime; Owner: -\n--\n\nCREATE FUNCTION realtime.quote_wal2json(entity regclass) RETURNS text\n    LANGUAGE sql IMMUTABLE STRICT\n    AS $$\n      select\n        (\n          select string_agg('' || ch,'')\n          from unnest(string_to_array(nsp.nspname::text, null)) with ordinality x(ch, idx)\n          where\n            not (x.idx = 1 and x.ch = '\"')\n            and not (\n              x.idx = array_length(string_to_array(nsp.nspname::text, null), 1)\n              and x.ch = '\"'\n            )\n        )\n        || '.'\n        || (\n          select string_agg('' || ch,'')\n          from unnest(string_to_array(pc.relname::text, null)) with ordinality x(ch, idx)\n          where\n            not (x.idx = 1 and x.ch = '\"')\n            and not (\n              x.idx = array_length(string_to_array(nsp.nspname::text, null), 1)\n              and x.ch = '\"'\n            )\n          )\n      from\n        pg_class pc\n        join pg_namespace nsp\n          on pc.relnamespace = nsp.oid\n      where\n        pc.oid = entity\n    $$;\n\n\n--\n-- Name: send(jsonb, text, text, boolean); Type: FUNCTION; Schema: realtime; Owner: -\n--\n\nCREATE FUNCTION realtime.send(payload jsonb, event text, topic text, private boolean DEFAULT true) RETURNS void\n    LANGUAGE plpgsql\n    AS $$\nBEGIN\n  BEGIN\n    -- Set the topic configuration\n    EXECUTE format('SET LOCAL realtime.topic TO %L', topic);\n\n    -- Attempt to insert the message\n    INSERT INTO realtime.messages (payload, event, topic, private, extension)\n    VALUES (payload, event, topic, private, 'broadcast');\n  EXCEPTION\n    WHEN OTHERS THEN\n      -- Capture and notify the error\n      RAISE WARNING 'ErrorSendingBroadcastMessage: %', SQLERRM;\n  END;\nEND;\n$$;\n\n\n--\n-- Name: subscription_check_filters(); Type: FUNCTION; Schema: realtime; Owner: -\n--\n\nCREATE FUNCTION realtime.subscription_check_filters() RETURNS trigger\n    LANGUAGE plpgsql\n    AS $$\n    /*\n    Validates that the user defined filters for a subscription:\n    - refer to valid columns that the claimed role may access\n    - values are coercable to the correct column type\n    */\n    declare\n        col_names text[] = coalesce(\n                array_agg(c.column_name order by c.ordinal_position),\n                '{}'::text[]\n            )\n            from\n                information_schema.columns c\n            where\n                format('%I.%I', c.table_schema, c.table_name)::regclass = new.entity\n                and pg_catalog.has_column_privilege(\n                    (new.claims ->> 'role'),\n                    format('%I.%I', c.table_schema, c.table_name)::regclass,\n                    c.column_name,\n                    'SELECT'\n                );\n        filter realtime.user_defined_filter;\n        col_type regtype;\n\n        in_val jsonb;\n    begin\n        for filter in select * from unnest(new.filters) loop\n            -- Filtered column is valid\n            if not filter.column_name = any(col_names) then\n                raise exception 'invalid column for filter %', filter.column_name;\n            end if;\n\n            -- Type is sanitized and safe for string interpolation\n            col_type = (\n                select atttypid::regtype\n                from pg_catalog.pg_attribute\n                where attrelid = new.entity\n                      and attname = filter.column_name\n            );\n            if col_type is null then\n                raise exception 'failed to lookup type for column %', filter.column_name;\n            end if;\n\n            -- Set maximum number of entries for in filter\n            if filter.op = 'in'::realtime.equality_op then\n                in_val = realtime.cast(filter.value, (col_type::text || '[]')::regtype);\n                if coalesce(jsonb_array_length(in_val), 0) > 100 then\n                    raise exception 'too many values for `in` filter. Maximum 100';\n                end if;\n            else\n                -- raises an exception if value is not coercable to type\n                perform realtime.cast(filter.value, col_type);\n            end if;\n\n        end loop;\n\n        -- Apply consistent order to filters so the unique constraint on\n        -- (subscription_id, entity, filters) can't be tricked by a different filter order\n        new.filters = coalesce(\n            array_agg(f order by f.column_name, f.op, f.value),\n            '{}'\n        ) from unnest(new.filters) f;\n\n        return new;\n    end;\n    $$;\n\n\n--\n-- Name: to_regrole(text); Type: FUNCTION; Schema: realtime; Owner: -\n--\n\nCREATE FUNCTION realtime.to_regrole(role_name text) RETURNS regrole\n    LANGUAGE sql IMMUTABLE\n    AS $$ select role_name::regrole $$;\n\n\n--\n-- Name: topic(); Type: FUNCTION; Schema: realtime; Owner: -\n--\n\nCREATE FUNCTION realtime.topic() RETURNS text\n    LANGUAGE sql STABLE\n    AS $$\nselect nullif(current_setting('realtime.topic', true), '')::text;\n$$;\n\n\n--\n-- Name: can_insert_object(text, text, uuid, jsonb); Type: FUNCTION; Schema: storage; Owner: -\n--\n\nCREATE FUNCTION storage.can_insert_object(bucketid text, name text, owner uuid, metadata jsonb) RETURNS void\n    LANGUAGE plpgsql\n    AS $$\nBEGIN\n  INSERT INTO \"storage\".\"objects\" (\"bucket_id\", \"name\", \"owner\", \"metadata\") VALUES (bucketid, name, owner, metadata);\n  -- hack to rollback the successful insert\n  RAISE sqlstate 'PT200' using\n  message = 'ROLLBACK',\n  detail = 'rollback successful insert';\nEND\n$$;\n\n\n--\n-- Name: extension(text); Type: FUNCTION; Schema: storage; Owner: -\n--\n\nCREATE FUNCTION storage.extension(name text) RETURNS text\n    LANGUAGE plpgsql\n    AS $$\nDECLARE\n_parts text[];\n_filename text;\nBEGIN\n\tselect string_to_array(name, '/') into _parts;\n\tselect _parts[array_length(_parts,1)] into _filename;\n\t-- @todo return the last part instead of 2\n\treturn reverse(split_part(reverse(_filename), '.', 1));\nEND\n$$;\n\n\n--\n-- Name: filename(text); Type: FUNCTION; Schema: storage; Owner: -\n--\n\nCREATE FUNCTION storage.filename(name text) RETURNS text\n    LANGUAGE plpgsql\n    AS $$\nDECLARE\n_parts text[];\nBEGIN\n\tselect string_to_array(name, '/') into _parts;\n\treturn _parts[array_length(_parts,1)];\nEND\n$$;\n\n\n--\n-- Name: foldername(text); Type: FUNCTION; Schema: storage; Owner: -\n--\n\nCREATE FUNCTION storage.foldername(name text) RETURNS text[]\n    LANGUAGE plpgsql\n    AS $$\nDECLARE\n_parts text[];\nBEGIN\n\tselect string_to_array(name, '/') into _parts;\n\treturn _parts[1:array_length(_parts,1)-1];\nEND\n$$;\n\n\n--\n-- Name: get_size_by_bucket(); Type: FUNCTION; Schema: storage; Owner: -\n--\n\nCREATE FUNCTION storage.get_size_by_bucket() RETURNS TABLE(size bigint, bucket_id text)\n    LANGUAGE plpgsql\n    AS $$\nBEGIN\n    return query\n        select sum((metadata->>'size')::int) as size, obj.bucket_id\n        from \"storage\".objects as obj\n        group by obj.bucket_id;\nEND\n$$;\n\n\n--\n-- Name: list_multipart_uploads_with_delimiter(text, text, text, integer, text, text); Type: FUNCTION; Schema: storage; Owner: -\n--\n\nCREATE FUNCTION storage.list_multipart_uploads_with_delimiter(bucket_id text, prefix_param text, delimiter_param text, max_keys integer DEFAULT 100, next_key_token text DEFAULT ''::text, next_upload_token text DEFAULT ''::text) RETURNS TABLE(key text, id text, created_at timestamp with time zone)\n    LANGUAGE plpgsql\n    AS $_$\nBEGIN\n    RETURN QUERY EXECUTE\n        'SELECT DISTINCT ON(key COLLATE \"C\") * from (\n            SELECT\n                CASE\n                    WHEN position($2 IN substring(key from length($1) + 1)) > 0 THEN\n                        substring(key from 1 for length($1) + position($2 IN substring(key from length($1) + 1)))\n                    ELSE\n                        key\n                END AS key, id, created_at\n            FROM\n                storage.s3_multipart_uploads\n            WHERE\n                bucket_id = $5 AND\n                key ILIKE $1 || ''%'' AND\n                CASE\n                    WHEN $4 != '''' AND $6 = '''' THEN\n                        CASE\n                            WHEN position($2 IN substring(key from length($1) + 1)) > 0 THEN\n                                substring(key from 1 for length($1) + position($2 IN substring(key from length($1) + 1))) COLLATE \"C\" > $4\n                            ELSE\n                                key COLLATE \"C\" > $4\n                            END\n                    ELSE\n                        true\n                END AND\n                CASE\n                    WHEN $6 != '''' THEN\n                        id COLLATE \"C\" > $6\n                    ELSE\n                        true\n                    END\n            ORDER BY\n                key COLLATE \"C\" ASC, created_at ASC) as e order by key COLLATE \"C\" LIMIT $3'\n        USING prefix_param, delimiter_param, max_keys, next_key_token, bucket_id, next_upload_token;\nEND;\n$_$;\n\n\n--\n-- Name: list_objects_with_delimiter(text, text, text, integer, text, text); Type: FUNCTION; Schema: storage; Owner: -\n--\n\nCREATE FUNCTION storage.list_objects_with_delimiter(bucket_id text, prefix_param text, delimiter_param text, max_keys integer DEFAULT 100, start_after text DEFAULT ''::text, next_token text DEFAULT ''::text) RETURNS TABLE(name text, id uuid, metadata jsonb, updated_at timestamp with time zone)\n    LANGUAGE plpgsql\n    AS $_$\nBEGIN\n    RETURN QUERY EXECUTE\n        'SELECT DISTINCT ON(name COLLATE \"C\") * from (\n            SELECT\n                CASE\n                    WHEN position($2 IN substring(name from length($1) + 1)) > 0 THEN\n                        substring(name from 1 for length($1) + position($2 IN substring(name from length($1) + 1)))\n                    ELSE\n                        name\n                END AS name, id, metadata, updated_at\n            FROM\n                storage.objects\n            WHERE\n                bucket_id = $5 AND\n                name ILIKE $1 || ''%'' AND\n                CASE\n                    WHEN $6 != '''' THEN\n                    name COLLATE \"C\" > $6\n                ELSE true END\n                AND CASE\n                    WHEN $4 != '''' THEN\n                        CASE\n                            WHEN position($2 IN substring(name from length($1) + 1)) > 0 THEN\n                                substring(name from 1 for length($1) + position($2 IN substring(name from length($1) + 1))) COLLATE \"C\" > $4\n                            ELSE\n                                name COLLATE \"C\" > $4\n                            END\n                    ELSE\n                        true\n                END\n            ORDER BY\n                name COLLATE \"C\" ASC) as e order by name COLLATE \"C\" LIMIT $3'\n        USING prefix_param, delimiter_param, max_keys, next_token, bucket_id, start_after;\nEND;\n$_$;\n\n\n--\n-- Name: operation(); Type: FUNCTION; Schema: storage; Owner: -\n--\n\nCREATE FUNCTION storage.operation() RETURNS text\n    LANGUAGE plpgsql STABLE\n    AS $$\nBEGIN\n    RETURN current_setting('storage.operation', true);\nEND;\n$$;\n\n\n--\n-- Name: search(text, text, integer, integer, integer, text, text, text); Type: FUNCTION; Schema: storage; Owner: -\n--\n\nCREATE FUNCTION storage.search(prefix text, bucketname text, limits integer DEFAULT 100, levels integer DEFAULT 1, offsets integer DEFAULT 0, search text DEFAULT ''::text, sortcolumn text DEFAULT 'name'::text, sortorder text DEFAULT 'asc'::text) RETURNS TABLE(name text, id uuid, updated_at timestamp with time zone, created_at timestamp with time zone, last_accessed_at timestamp with time zone, metadata jsonb)\n    LANGUAGE plpgsql STABLE\n    AS $_$\ndeclare\n  v_order_by text;\n  v_sort_order text;\nbegin\n  case\n    when sortcolumn = 'name' then\n      v_order_by = 'name';\n    when sortcolumn = 'updated_at' then\n      v_order_by = 'updated_at';\n    when sortcolumn = 'created_at' then\n      v_order_by = 'created_at';\n    when sortcolumn = 'last_accessed_at' then\n      v_order_by = 'last_accessed_at';\n    else\n      v_order_by = 'name';\n  end case;\n\n  case\n    when sortorder = 'asc' then\n      v_sort_order = 'asc';\n    when sortorder = 'desc' then\n      v_sort_order = 'desc';\n    else\n      v_sort_order = 'asc';\n  end case;\n\n  v_order_by = v_order_by || ' ' || v_sort_order;\n\n  return query execute\n    'with folders as (\n       select path_tokens[$1] as folder\n       from storage.objects\n         where objects.name ilike $2 || $3 || ''%''\n           and bucket_id = $4\n           and array_length(objects.path_tokens, 1) <> $1\n       group by folder\n       order by folder ' || v_sort_order || '\n     )\n     (select folder as \"name\",\n            null as id,\n            null as updated_at,\n            null as created_at,\n            null as last_accessed_at,\n            null as metadata from folders)\n     union all\n     (select path_tokens[$1] as \"name\",\n            id,\n            updated_at,\n            created_at,\n            last_accessed_at,\n            metadata\n     from storage.objects\n     where objects.name ilike $2 || $3 || ''%''\n       and bucket_id = $4\n       and array_length(objects.path_tokens, 1) = $1\n     order by ' || v_order_by || ')\n     limit $5\n     offset $6' using levels, prefix, search, bucketname, limits, offsets;\nend;\n$_$;\n\n\n--\n-- Name: update_updated_at_column(); Type: FUNCTION; Schema: storage; Owner: -\n--\n\nCREATE FUNCTION storage.update_updated_at_column() RETURNS trigger\n    LANGUAGE plpgsql\n    AS $$\nBEGIN\n    NEW.updated_at = now();\n    RETURN NEW; \nEND;\n$$;\n\n\n--\n-- Name: audit_log_entries; Type: TABLE; Schema: auth; Owner: -\n--\n\nCREATE TABLE auth.audit_log_entries (\n    instance_id uuid,\n    id uuid NOT NULL,\n    payload json,\n    created_at timestamp with time zone,\n    ip_address character varying(64) DEFAULT ''::character varying NOT NULL\n);\n\n\n--\n-- Name: TABLE audit_log_entries; Type: COMMENT; Schema: auth; Owner: -\n--\n\nCOMMENT ON TABLE auth.audit_log_entries IS 'Auth: Audit trail for user actions.';\n\n\n--\n-- Name: flow_state; Type: TABLE; Schema: auth; Owner: -\n--\n\nCREATE TABLE auth.flow_state (\n    id uuid NOT NULL,\n    user_id uuid,\n    auth_code text NOT NULL,\n    code_challenge_method auth.code_challenge_method NOT NULL,\n    code_challenge text NOT NULL,\n    provider_type text NOT NULL,\n    provider_access_token text,\n    provider_refresh_token text,\n    created_at timestamp with time zone,\n    updated_at timestamp with time zone,\n    authentication_method text NOT NULL,\n    auth_code_issued_at timestamp with time zone\n);\n\n\n--\n-- Name: TABLE flow_state; Type: COMMENT; Schema: auth; Owner: -\n--\n\nCOMMENT ON TABLE auth.flow_state IS 'stores metadata for pkce logins';\n\n\n--\n-- Name: identities; Type: TABLE; Schema: auth; Owner: -\n--\n\nCREATE TABLE auth.identities (\n    provider_id text NOT NULL,\n    user_id uuid NOT NULL,\n    identity_data jsonb NOT NULL,\n    provider text NOT NULL,\n    last_sign_in_at timestamp with time zone,\n    created_at timestamp with time zone,\n    updated_at timestamp with time zone,\n    email text GENERATED ALWAYS AS (lower((identity_data ->> 'email'::text))) STORED,\n    id uuid DEFAULT gen_random_uuid() NOT NULL\n);\n\n\n--\n-- Name: TABLE identities; Type: COMMENT; Schema: auth; Owner: -\n--\n\nCOMMENT ON TABLE auth.identities IS 'Auth: Stores identities associated to a user.';\n\n\n--\n-- Name: COLUMN identities.email; Type: COMMENT; Schema: auth; Owner: -\n--\n\nCOMMENT ON COLUMN auth.identities.email IS 'Auth: Email is a generated column that references the optional email property in the identity_data';\n\n\n--\n-- Name: instances; Type: TABLE; Schema: auth; Owner: -\n--\n\nCREATE TABLE auth.instances (\n    id uuid NOT NULL,\n    uuid uuid,\n    raw_base_config text,\n    created_at timestamp with time zone,\n    updated_at timestamp with time zone\n);\n\n\n--\n-- Name: TABLE instances; Type: COMMENT; Schema: auth; Owner: -\n--\n\nCOMMENT ON TABLE auth.instances IS 'Auth: Manages users across multiple sites.';\n\n\n--\n-- Name: mfa_amr_claims; Type: TABLE; Schema: auth; Owner: -\n--\n\nCREATE TABLE auth.mfa_amr_claims (\n    session_id uuid NOT NULL,\n    created_at timestamp with time zone NOT NULL,\n    updated_at timestamp with time zone NOT NULL,\n    authentication_method text NOT NULL,\n    id uuid NOT NULL\n);\n\n\n--\n-- Name: TABLE mfa_amr_claims; Type: COMMENT; Schema: auth; Owner: -\n--\n\nCOMMENT ON TABLE auth.mfa_amr_claims IS 'auth: stores authenticator method reference claims for multi factor authentication';\n\n\n--\n-- Name: mfa_challenges; Type: TABLE; Schema: auth; Owner: -\n--\n\nCREATE TABLE auth.mfa_challenges (\n    id uuid NOT NULL,\n    factor_id uuid NOT NULL,\n    created_at timestamp with time zone NOT NULL,\n    verified_at timestamp with time zone,\n    ip_address inet NOT NULL,\n    otp_code text,\n    web_authn_session_data jsonb\n);\n\n\n--\n-- Name: TABLE mfa_challenges; Type: COMMENT; Schema: auth; Owner: -\n--\n\nCOMMENT ON TABLE auth.mfa_challenges IS 'auth: stores metadata about challenge requests made';\n\n\n--\n-- Name: mfa_factors; Type: TABLE; Schema: auth; Owner: -\n--\n\nCREATE TABLE auth.mfa_factors (\n    id uuid NOT NULL,\n    user_id uuid NOT NULL,\n    friendly_name text,\n    factor_type auth.factor_type NOT NULL,\n    status auth.factor_status NOT NULL,\n    created_at timestamp with time zone NOT NULL,\n    updated_at timestamp with time zone NOT NULL,\n    secret text,\n    phone text,\n    last_challenged_at timestamp with time zone,\n    web_authn_credential jsonb,\n    web_authn_aaguid uuid\n);\n\n\n--\n-- Name: TABLE mfa_factors; Type: COMMENT; Schema: auth; Owner: -\n--\n\nCOMMENT ON TABLE auth.mfa_factors IS 'auth: stores metadata about factors';\n\n\n--\n-- Name: one_time_tokens; Type: TABLE; Schema: auth; Owner: -\n--\n\nCREATE TABLE auth.one_time_tokens (\n    id uuid NOT NULL,\n    user_id uuid NOT NULL,\n    token_type auth.one_time_token_type NOT NULL,\n    token_hash text NOT NULL,\n    relates_to text NOT NULL,\n    created_at timestamp without time zone DEFAULT now() NOT NULL,\n    updated_at timestamp without time zone DEFAULT now() NOT NULL,\n    CONSTRAINT one_time_tokens_token_hash_check CHECK ((char_length(token_hash) > 0))\n);\n\n\n--\n-- Name: refresh_tokens; Type: TABLE; Schema: auth; Owner: -\n--\n\nCREATE TABLE auth.refresh_tokens (\n    instance_id uuid,\n    id bigint NOT NULL,\n    token character varying(255),\n    user_id character varying(255),\n    revoked boolean,\n    created_at timestamp with time zone,\n    updated_at timestamp with time zone,\n    parent character varying(255),\n    session_id uuid\n);\n\n\n--\n-- Name: TABLE refresh_tokens; Type: COMMENT; Schema: auth; Owner: -\n--\n\nCOMMENT ON TABLE auth.refresh_tokens IS 'Auth: Store of tokens used to refresh JWT tokens once they expire.';\n\n\n--\n-- Name: refresh_tokens_id_seq; Type: SEQUENCE; Schema: auth; Owner: -\n--\n\nCREATE SEQUENCE auth.refresh_tokens_id_seq\n    START WITH 1\n    INCREMENT BY 1\n    NO MINVALUE\n    NO MAXVALUE\n    CACHE 1;\n\n\n--\n-- Name: refresh_tokens_id_seq; Type: SEQUENCE OWNED BY; Schema: auth; Owner: -\n--\n\nALTER SEQUENCE auth.refresh_tokens_id_seq OWNED BY auth.refresh_tokens.id;\n\n\n--\n-- Name: saml_providers; Type: TABLE; Schema: auth; Owner: -\n--\n\nCREATE TABLE auth.saml_providers (\n    id uuid NOT NULL,\n    sso_provider_id uuid NOT NULL,\n    entity_id text NOT NULL,\n    metadata_xml text NOT NULL,\n    metadata_url text,\n    attribute_mapping jsonb,\n    created_at timestamp with time zone,\n    updated_at timestamp with time zone,\n    name_id_format text,\n    CONSTRAINT \"entity_id not empty\" CHECK ((char_length(entity_id) > 0)),\n    CONSTRAINT \"metadata_url not empty\" CHECK (((metadata_url = NULL::text) OR (char_length(metadata_url) > 0))),\n    CONSTRAINT \"metadata_xml not empty\" CHECK ((char_length(metadata_xml) > 0))\n);\n\n\n--\n-- Name: TABLE saml_providers; Type: COMMENT; Schema: auth; Owner: -\n--\n\nCOMMENT ON TABLE auth.saml_providers IS 'Auth: Manages SAML Identity Provider connections.';\n\n\n--\n-- Name: saml_relay_states; Type: TABLE; Schema: auth; Owner: -\n--\n\nCREATE TABLE auth.saml_relay_states (\n    id uuid NOT NULL,\n    sso_provider_id uuid NOT NULL,\n    request_id text NOT NULL,\n    for_email text,\n    redirect_to text,\n    created_at timestamp with time zone,\n    updated_at timestamp with time zone,\n    flow_state_id uuid,\n    CONSTRAINT \"request_id not empty\" CHECK ((char_length(request_id) > 0))\n);\n\n\n--\n-- Name: TABLE saml_relay_states; Type: COMMENT; Schema: auth; Owner: -\n--\n\nCOMMENT ON TABLE auth.saml_relay_states IS 'Auth: Contains SAML Relay State information for each Service Provider initiated login.';\n\n\n--\n-- Name: schema_migrations; Type: TABLE; Schema: auth; Owner: -\n--\n\nCREATE TABLE auth.schema_migrations (\n    version character varying(255) NOT NULL\n);\n\n\n--\n-- Name: TABLE schema_migrations; Type: COMMENT; Schema: auth; Owner: -\n--\n\nCOMMENT ON TABLE auth.schema_migrations IS 'Auth: Manages updates to the auth system.';\n\n\n--\n-- Name: sessions; Type: TABLE; Schema: auth; Owner: -\n--\n\nCREATE TABLE auth.sessions (\n    id uuid NOT NULL,\n    user_id uuid NOT NULL,\n    created_at timestamp with time zone,\n    updated_at timestamp with time zone,\n    factor_id uuid,\n    aal auth.aal_level,\n    not_after timestamp with time zone,\n    refreshed_at timestamp without time zone,\n    user_agent text,\n    ip inet,\n    tag text\n);\n\n\n--\n-- Name: TABLE sessions; Type: COMMENT; Schema: auth; Owner: -\n--\n\nCOMMENT ON TABLE auth.sessions IS 'Auth: Stores session data associated to a user.';\n\n\n--\n-- Name: COLUMN sessions.not_after; Type: COMMENT; Schema: auth; Owner: -\n--\n\nCOMMENT ON COLUMN auth.sessions.not_after IS 'Auth: Not after is a nullable column that contains a timestamp after which the session should be regarded as expired.';\n\n\n--\n-- Name: sso_domains; Type: TABLE; Schema: auth; Owner: -\n--\n\nCREATE TABLE auth.sso_domains (\n    id uuid NOT NULL,\n    sso_provider_id uuid NOT NULL,\n    domain text NOT NULL,\n    created_at timestamp with time zone,\n    updated_at timestamp with time zone,\n    CONSTRAINT \"domain not empty\" CHECK ((char_length(domain) > 0))\n);\n\n\n--\n-- Name: TABLE sso_domains; Type: COMMENT; Schema: auth; Owner: -\n--\n\nCOMMENT ON TABLE auth.sso_domains IS 'Auth: Manages SSO email address domain mapping to an SSO Identity Provider.';\n\n\n--\n-- Name: sso_providers; Type: TABLE; Schema: auth; Owner: -\n--\n\nCREATE TABLE auth.sso_providers (\n    id uuid NOT NULL,\n    resource_id text,\n    created_at timestamp with time zone,\n    updated_at timestamp with time zone,\n    disabled boolean,\n    CONSTRAINT \"resource_id not empty\" CHECK (((resource_id = NULL::text) OR (char_length(resource_id) > 0)))\n);\n\n\n--\n-- Name: TABLE sso_providers; Type: COMMENT; Schema: auth; Owner: -\n--\n\nCOMMENT ON TABLE auth.sso_providers IS 'Auth: Manages SSO identity provider information; see saml_providers for SAML.';\n\n\n--\n-- Name: COLUMN sso_providers.resource_id; Type: COMMENT; Schema: auth; Owner: -\n--\n\nCOMMENT ON COLUMN auth.sso_providers.resource_id IS 'Auth: Uniquely identifies a SSO provider according to a user-chosen resource ID (case insensitive), useful in infrastructure as code.';\n\n\n--\n-- Name: users; Type: TABLE; Schema: auth; Owner: -\n--\n\nCREATE TABLE auth.users (\n    instance_id uuid,\n    id uuid NOT NULL,\n    aud character varying(255),\n    role character varying(255),\n    email character varying(255),\n    encrypted_password character varying(255),\n    email_confirmed_at timestamp with time zone,\n    invited_at timestamp with time zone,\n    confirmation_token character varying(255),\n    confirmation_sent_at timestamp with time zone,\n    recovery_token character varying(255),\n    recovery_sent_at timestamp with time zone,\n    email_change_token_new character varying(255),\n    email_change character varying(255),\n    email_change_sent_at timestamp with time zone,\n    last_sign_in_at timestamp with time zone,\n    raw_app_meta_data jsonb,\n    raw_user_meta_data jsonb,\n    is_super_admin boolean,\n    created_at timestamp with time zone,\n    updated_at timestamp with time zone,\n    phone text DEFAULT NULL::character varying,\n    phone_confirmed_at timestamp with time zone,\n    phone_change text DEFAULT ''::character varying,\n    phone_change_token character varying(255) DEFAULT ''::character varying,\n    phone_change_sent_at timestamp with time zone,\n    confirmed_at timestamp with time zone GENERATED ALWAYS AS (LEAST(email_confirmed_at, phone_confirmed_at)) STORED,\n    email_change_token_current character varying(255) DEFAULT ''::character varying,\n    email_change_confirm_status smallint DEFAULT 0,\n    banned_until timestamp with time zone,\n    reauthentication_token character varying(255) DEFAULT ''::character varying,\n    reauthentication_sent_at timestamp with time zone,\n    is_sso_user boolean DEFAULT false NOT NULL,\n    deleted_at timestamp with time zone,\n    is_anonymous boolean DEFAULT false NOT NULL,\n    CONSTRAINT users_email_change_confirm_status_check CHECK (((email_change_confirm_status >= 0) AND (email_change_confirm_status <= 2)))\n);\n\n\n--\n-- Name: TABLE users; Type: COMMENT; Schema: auth; Owner: -\n--\n\nCOMMENT ON TABLE auth.users IS 'Auth: Stores user login data within a secure schema.';\n\n\n--\n-- Name: COLUMN users.is_sso_user; Type: COMMENT; Schema: auth; Owner: -\n--\n\nCOMMENT ON COLUMN auth.users.is_sso_user IS 'Auth: Set this column to true when the account comes from SSO. These accounts can have duplicate emails.';\n\n\n--\n-- Name: absences; Type: TABLE; Schema: public; Owner: -\n--\n\nCREATE TABLE public.absences (\n    id uuid DEFAULT gen_random_uuid() NOT NULL,\n    employee_id uuid NOT NULL,\n    start_date date NOT NULL,\n    end_date date,\n    reason text,\n    message text,\n    status text DEFAULT 'pending'::text NOT NULL,\n    submitted_at timestamp with time zone DEFAULT now(),\n    CONSTRAINT absences_status_valid_check CHECK ((status = ANY (ARRAY['pending'::text, 'approved'::text, 'declined'::text])))\n);\n\n\n--\n-- Name: app_settings; Type: TABLE; Schema: public; Owner: -\n--\n\nCREATE TABLE public.app_settings (\n    id integer NOT NULL,\n    email_notifications boolean DEFAULT true NOT NULL,\n    admin_notification_emails text[] DEFAULT '{}'::text[] NOT NULL,\n    absence_requests boolean DEFAULT true NOT NULL,\n    schedule_changes boolean DEFAULT true NOT NULL,\n    employee_updates boolean DEFAULT false NOT NULL,\n    system_updates boolean DEFAULT false NOT NULL,\n    daily_digest boolean DEFAULT false NOT NULL,\n    digest_time text DEFAULT '08:00'::text NOT NULL,\n    updated_at timestamp with time zone DEFAULT now() NOT NULL,\n    CONSTRAINT app_settings_id_check CHECK ((id = 1))\n);\n\n\n--\n-- Name: employees; Type: TABLE; Schema: public; Owner: -\n--\n\nCREATE TABLE public.employees (\n    id uuid DEFAULT gen_random_uuid() NOT NULL,\n    name text NOT NULL,\n    email text,\n    department text,\n    is_active boolean DEFAULT true NOT NULL,\n    created_at timestamp without time zone DEFAULT now()\n);\n\n\n--\n-- Name: mail_jobs_id_seq; Type: SEQUENCE; Schema: public; Owner: -\n--\n\nALTER TABLE public.mail_jobs ALTER COLUMN id ADD GENERATED BY DEFAULT AS IDENTITY (\n    SEQUENCE NAME public.mail_jobs_id_seq\n    START WITH 1\n    INCREMENT BY 1\n    NO MINVALUE\n    NO MAXVALUE\n    CACHE 1\n);\n\n\n--\n-- Name: notifications; Type: TABLE; Schema: public; Owner: -\n--\n\nCREATE TABLE public.notifications (\n    id uuid DEFAULT gen_random_uuid() NOT NULL,\n    type text NOT NULL,\n    title text NOT NULL,\n    message text NOT NULL,\n    created_at timestamp with time zone DEFAULT now() NOT NULL,\n    is_read boolean DEFAULT false NOT NULL,\n    CONSTRAINT notifications_type_check CHECK ((type = ANY (ARRAY['absence_request'::text, 'absence_approved'::text, 'absence_declined'::text, 'employee_added'::text, 'shift_auto'::text])))\n);\n\n\n--\n-- Name: profiles; Type: TABLE; Schema: public; Owner: -\n--\n\nCREATE TABLE public.profiles (\n    id uuid NOT NULL,\n    email text,\n    is_admin boolean DEFAULT false NOT NULL,\n    created_at timestamp with time zone DEFAULT now() NOT NULL\n);\n\n\n--\n-- Name: shifts; Type: TABLE; Schema: public; Owner: -\n--\n\nCREATE TABLE public.shifts (\n    id uuid DEFAULT gen_random_uuid() NOT NULL,\n    employee_id uuid NOT NULL,\n    work_date date NOT NULL,\n    start_time time without time zone,\n    end_time time without time zone,\n    hours numeric(4,2) DEFAULT 0 NOT NULL,\n    type text DEFAULT 'normal'::text NOT NULL,\n    is_locked boolean DEFAULT false NOT NULL,\n    note text,\n    created_at timestamp with time zone DEFAULT now() NOT NULL,\n    updated_at timestamp with time zone DEFAULT now() NOT NULL,\n    published boolean DEFAULT false NOT NULL,\n    published_at timestamp with time zone,\n    CONSTRAINT shifts_hours_check CHECK (((hours >= (0)::numeric) AND (hours <= (24)::numeric))),\n    CONSTRAINT shifts_hours_range_chk CHECK (((hours >= (0)::numeric) AND (hours <= (24)::numeric))),\n    CONSTRAINT shifts_time_order_chk CHECK (((start_time IS NULL) OR (end_time IS NULL) OR (start_time < end_time))),\n    CONSTRAINT shifts_type_allowed_chk CHECK ((type = ANY (ARRAY['normal'::text, 'locked'::text, 'absent'::text, 'holiday'::text]))),\n    CONSTRAINT shifts_type_check CHECK ((type = ANY (ARRAY['normal'::text, 'locked'::text, 'absent'::text, 'holiday'::text])))\n);\n\n\n--\n-- Name: messages; Type: TABLE; Schema: realtime; Owner: -\n--\n\nCREATE TABLE realtime.messages (\n    topic text NOT NULL,\n    extension text NOT NULL,\n    payload jsonb,\n    event text,\n    private boolean DEFAULT false,\n    updated_at timestamp without time zone DEFAULT now() NOT NULL,\n    inserted_at timestamp without time zone DEFAULT now() NOT NULL,\n    id uuid DEFAULT gen_random_uuid() NOT NULL\n)\nPARTITION BY RANGE (inserted_at);\n\n\n--\n-- Name: messages_2025_08_29; Type: TABLE; Schema: realtime; Owner: -\n--\n\nCREATE TABLE realtime.messages_2025_08_29 (\n    topic text NOT NULL,\n    extension text NOT NULL,\n    payload jsonb,\n    event text,\n    private boolean DEFAULT false,\n    updated_at timestamp without time zone DEFAULT now() NOT NULL,\n    inserted_at timestamp without time zone DEFAULT now() NOT NULL,\n    id uuid DEFAULT gen_random_uuid() NOT NULL\n);\n\n\n--\n-- Name: messages_2025_08_30; Type: TABLE; Schema: realtime; Owner: -\n--\n\nCREATE TABLE realtime.messages_2025_08_30 (\n    topic text NOT NULL,\n    extension text NOT NULL,\n    payload jsonb,\n    event text,\n    private boolean DEFAULT false,\n    updated_at timestamp without time zone DEFAULT now() NOT NULL,\n    inserted_at timestamp without time zone DEFAULT now() NOT NULL,\n    id uuid DEFAULT gen_random_uuid() NOT NULL\n);\n\n\n--\n-- Name: messages_2025_08_31; Type: TABLE; Schema: realtime; Owner: -\n--\n\nCREATE TABLE realtime.messages_2025_08_31 (\n    topic text NOT NULL,\n    extension text NOT NULL,\n    payload jsonb,\n    event text,\n    private boolean DEFAULT false,\n    updated_at timestamp without time zone DEFAULT now() NOT NULL,\n    inserted_at timestamp without time zone DEFAULT now() NOT NULL,\n    id uuid DEFAULT gen_random_uuid() NOT NULL\n);\n\n\n--\n-- Name: messages_2025_09_01; Type: TABLE; Schema: realtime; Owner: -\n--\n\nCREATE TABLE realtime.messages_2025_09_01 (\n    topic text NOT NULL,\n    extension text NOT NULL,\n    payload jsonb,\n    event text,\n    private boolean DEFAULT false,\n    updated_at timestamp without time zone DEFAULT now() NOT NULL,\n    inserted_at timestamp without time zone DEFAULT now() NOT NULL,\n    id uuid DEFAULT gen_random_uuid() NOT NULL\n);\n\n\n--\n-- Name: messages_2025_09_02; Type: TABLE; Schema: realtime; Owner: -\n--\n\nCREATE TABLE realtime.messages_2025_09_02 (\n    topic text NOT NULL,\n    extension text NOT NULL,\n    payload jsonb,\n    event text,\n    private boolean DEFAULT false,\n    updated_at timestamp without time zone DEFAULT now() NOT NULL,\n    inserted_at timestamp without time zone DEFAULT now() NOT NULL,\n    id uuid DEFAULT gen_random_uuid() NOT NULL\n);\n\n\n--\n-- Name: messages_2025_09_03; Type: TABLE; Schema: realtime; Owner: -\n--\n\nCREATE TABLE realtime.messages_2025_09_03 (\n    topic text NOT NULL,\n    extension text NOT NULL,\n    payload jsonb,\n    event text,\n    private boolean DEFAULT false,\n    updated_at timestamp without time zone DEFAULT now() NOT NULL,\n    inserted_at timestamp without time zone DEFAULT now() NOT NULL,\n    id uuid DEFAULT gen_random_uuid() NOT NULL\n);\n\n\n--\n-- Name: messages_2025_09_04; Type: TABLE; Schema: realtime; Owner: -\n--\n\nCREATE TABLE realtime.messages_2025_09_04 (\n    topic text NOT NULL,\n    extension text NOT NULL,\n    payload jsonb,\n    event text,\n    private boolean DEFAULT false,\n    updated_at timestamp without time zone DEFAULT now() NOT NULL,\n    inserted_at timestamp without time zone DEFAULT now() NOT NULL,\n    id uuid DEFAULT gen_random_uuid() NOT NULL\n);\n\n\n--\n-- Name: schema_migrations; Type: TABLE; Schema: realtime; Owner: -\n--\n\nCREATE TABLE realtime.schema_migrations (\n    version bigint NOT NULL,\n    inserted_at timestamp(0) without time zone\n);\n\n\n--\n-- Name: subscription; Type: TABLE; Schema: realtime; Owner: -\n--\n\nCREATE TABLE realtime.subscription (\n    id bigint NOT NULL,\n    subscription_id uuid NOT NULL,\n    entity regclass NOT NULL,\n    filters realtime.user_defined_filter[] DEFAULT '{}'::realtime.user_defined_filter[] NOT NULL,\n    claims jsonb NOT NULL,\n    claims_role regrole GENERATED ALWAYS AS (realtime.to_regrole((claims ->> 'role'::text))) STORED NOT NULL,\n    created_at timestamp without time zone DEFAULT timezone('utc'::text, now()) NOT NULL\n);\n\n\n--\n-- Name: subscription_id_seq; Type: SEQUENCE; Schema: realtime; Owner: -\n--\n\nALTER TABLE realtime.subscription ALTER COLUMN id ADD GENERATED ALWAYS AS IDENTITY (\n    SEQUENCE NAME realtime.subscription_id_seq\n    START WITH 1\n    INCREMENT BY 1\n    NO MINVALUE\n    NO MAXVALUE\n    CACHE 1\n);\n\n\n--\n-- Name: buckets; Type: TABLE; Schema: storage; Owner: -\n--\n\nCREATE TABLE storage.buckets (\n    id text NOT NULL,\n    name text NOT NULL,\n    owner uuid,\n    created_at timestamp with time zone DEFAULT now(),\n    updated_at timestamp with time zone DEFAULT now(),\n    public boolean DEFAULT false,\n    avif_autodetection boolean DEFAULT false,\n    file_size_limit bigint,\n    allowed_mime_types text[],\n    owner_id text\n);\n\n\n--\n-- Name: COLUMN buckets.owner; Type: COMMENT; Schema: storage; Owner: -\n--\n\nCOMMENT ON COLUMN storage.buckets.owner IS 'Field is deprecated, use owner_id instead';\n\n\n--\n-- Name: migrations; Type: TABLE; Schema: storage; Owner: -\n--\n\nCREATE TABLE storage.migrations (\n    id integer NOT NULL,\n    name character varying(100) NOT NULL,\n    hash character varying(40) NOT NULL,\n    executed_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP\n);\n\n\n--\n-- Name: objects; Type: TABLE; Schema: storage; Owner: -\n--\n\nCREATE TABLE storage.objects (\n    id uuid DEFAULT gen_random_uuid() NOT NULL,\n    bucket_id text,\n    name text,\n    owner uuid,\n    created_at timestamp with time zone DEFAULT now(),\n    updated_at timestamp with time zone DEFAULT now(),\n    last_accessed_at timestamp with time zone DEFAULT now(),\n    metadata jsonb,\n    path_tokens text[] GENERATED ALWAYS AS (string_to_array(name, '/'::text)) STORED,\n    version text,\n    owner_id text,\n    user_metadata jsonb\n);\n\n\n--\n-- Name: COLUMN objects.owner; Type: COMMENT; Schema: storage; Owner: -\n--\n\nCOMMENT ON COLUMN storage.objects.owner IS 'Field is deprecated, use owner_id instead';\n\n\n--\n-- Name: s3_multipart_uploads; Type: TABLE; Schema: storage; Owner: -\n--\n\nCREATE TABLE storage.s3_multipart_uploads (\n    id text NOT NULL,\n    in_progress_size bigint DEFAULT 0 NOT NULL,\n    upload_signature text NOT NULL,\n    bucket_id text NOT NULL,\n    key text NOT NULL COLLATE pg_catalog.\"C\",\n    version text NOT NULL,\n    owner_id text,\n    created_at timestamp with time zone DEFAULT now() NOT NULL,\n    user_metadata jsonb\n);\n\n\n--\n-- Name: s3_multipart_uploads_parts; Type: TABLE; Schema: storage; Owner: -\n--\n\nCREATE TABLE storage.s3_multipart_uploads_parts (\n    id uuid DEFAULT gen_random_uuid() NOT NULL,\n    upload_id text NOT NULL,\n    size bigint DEFAULT 0 NOT NULL,\n    part_number integer NOT NULL,\n    bucket_id text NOT NULL,\n    key text NOT NULL COLLATE pg_catalog.\"C\",\n    etag text NOT NULL,\n    owner_id text,\n    version text NOT NULL,\n    created_at timestamp with time zone DEFAULT now() NOT NULL\n);\n\n\n--\n-- Name: schema_migrations; Type: TABLE; Schema: supabase_migrations; Owner: -\n--\n\nCREATE TABLE supabase_migrations.schema_migrations (\n    version text NOT NULL,\n    statements text[],\n    name text\n);\n\n\n--\n-- Name: seed_files; Type: TABLE; Schema: supabase_migrations; Owner: -\n--\n\nCREATE TABLE supabase_migrations.seed_files (\n    path text NOT NULL,\n    hash text NOT NULL\n);\n\n\n--\n-- Name: messages_2025_08_29; Type: TABLE ATTACH; Schema: realtime; Owner: -\n--\n\nALTER TABLE ONLY realtime.messages ATTACH PARTITION realtime.messages_2025_08_29 FOR VALUES FROM ('2025-08-29 00:00:00') TO ('2025-08-30 00:00:00');\n\n\n--\n-- Name: messages_2025_08_30; Type: TABLE ATTACH; Schema: realtime; Owner: -\n--\n\nALTER TABLE ONLY realtime.messages ATTACH PARTITION realtime.messages_2025_08_30 FOR VALUES FROM ('2025-08-30 00:00:00') TO ('2025-08-31 00:00:00');\n\n\n--\n-- Name: messages_2025_08_31; Type: TABLE ATTACH; Schema: realtime; Owner: -\n--\n\nALTER TABLE ONLY realtime.messages ATTACH PARTITION realtime.messages_2025_08_31 FOR VALUES FROM ('2025-08-31 00:00:00') TO ('2025-09-01 00:00:00');\n\n\n--\n-- Name: messages_2025_09_01; Type: TABLE ATTACH; Schema: realtime; Owner: -\n--\n\nALTER TABLE ONLY realtime.messages ATTACH PARTITION realtime.messages_2025_09_01 FOR VALUES FROM ('2025-09-01 00:00:00') TO ('2025-09-02 00:00:00');\n\n\n--\n-- Name: messages_2025_09_02; Type: TABLE ATTACH; Schema: realtime; Owner: -\n--\n\nALTER TABLE ONLY realtime.messages ATTACH PARTITION realtime.messages_2025_09_02 FOR VALUES FROM ('2025-09-02 00:00:00') TO ('2025-09-03 00:00:00');\n\n\n--\n-- Name: messages_2025_09_03; Type: TABLE ATTACH; Schema: realtime; Owner: -\n--\n\nALTER TABLE ONLY realtime.messages ATTACH PARTITION realtime.messages_2025_09_03 FOR VALUES FROM ('2025-09-03 00:00:00') TO ('2025-09-04 00:00:00');\n\n\n--\n-- Name: messages_2025_09_04; Type: TABLE ATTACH; Schema: realtime; Owner: -\n--\n\nALTER TABLE ONLY realtime.messages ATTACH PARTITION realtime.messages_2025_09_04 FOR VALUES FROM ('2025-09-04 00:00:00') TO ('2025-09-05 00:00:00');\n\n\n--\n-- Name: refresh_tokens id; Type: DEFAULT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.refresh_tokens ALTER COLUMN id SET DEFAULT nextval('auth.refresh_tokens_id_seq'::regclass);\n\n\n--\n-- Name: mfa_amr_claims amr_id_pk; Type: CONSTRAINT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.mfa_amr_claims\n    ADD CONSTRAINT amr_id_pk PRIMARY KEY (id);\n\n\n--\n-- Name: audit_log_entries audit_log_entries_pkey; Type: CONSTRAINT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.audit_log_entries\n    ADD CONSTRAINT audit_log_entries_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: flow_state flow_state_pkey; Type: CONSTRAINT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.flow_state\n    ADD CONSTRAINT flow_state_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: identities identities_pkey; Type: CONSTRAINT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.identities\n    ADD CONSTRAINT identities_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: identities identities_provider_id_provider_unique; Type: CONSTRAINT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.identities\n    ADD CONSTRAINT identities_provider_id_provider_unique UNIQUE (provider_id, provider);\n\n\n--\n-- Name: instances instances_pkey; Type: CONSTRAINT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.instances\n    ADD CONSTRAINT instances_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: mfa_amr_claims [REDACTED]; Type: CONSTRAINT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.mfa_amr_claims\n    ADD CONSTRAINT [REDACTED] UNIQUE (session_id, authentication_method);\n\n\n--\n-- Name: mfa_challenges mfa_challenges_pkey; Type: CONSTRAINT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.mfa_challenges\n    ADD CONSTRAINT mfa_challenges_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: mfa_factors mfa_factors_last_challenged_at_key; Type: CONSTRAINT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.mfa_factors\n    ADD CONSTRAINT mfa_factors_last_challenged_at_key UNIQUE (last_challenged_at);\n\n\n--\n-- Name: mfa_factors mfa_factors_pkey; Type: CONSTRAINT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.mfa_factors\n    ADD CONSTRAINT mfa_factors_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: one_time_tokens one_time_tokens_pkey; Type: CONSTRAINT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.one_time_tokens\n    ADD CONSTRAINT one_time_tokens_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: refresh_tokens refresh_tokens_pkey; Type: CONSTRAINT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.refresh_tokens\n    ADD CONSTRAINT refresh_tokens_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: refresh_tokens refresh_tokens_token_unique; Type: CONSTRAINT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.refresh_tokens\n    ADD CONSTRAINT refresh_tokens_token_unique UNIQUE (token);\n\n\n--\n-- Name: saml_providers saml_providers_entity_id_key; Type: CONSTRAINT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.saml_providers\n    ADD CONSTRAINT saml_providers_entity_id_key UNIQUE (entity_id);\n\n\n--\n-- Name: saml_providers saml_providers_pkey; Type: CONSTRAINT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.saml_providers\n    ADD CONSTRAINT saml_providers_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: saml_relay_states saml_relay_states_pkey; Type: CONSTRAINT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.saml_relay_states\n    ADD CONSTRAINT saml_relay_states_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: schema_migrations schema_migrations_pkey; Type: CONSTRAINT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.schema_migrations\n    ADD CONSTRAINT schema_migrations_pkey PRIMARY KEY (version);\n\n\n--\n-- Name: sessions sessions_pkey; Type: CONSTRAINT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.sessions\n    ADD CONSTRAINT sessions_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: sso_domains sso_domains_pkey; Type: CONSTRAINT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.sso_domains\n    ADD CONSTRAINT sso_domains_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: sso_providers sso_providers_pkey; Type: CONSTRAINT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.sso_providers\n    ADD CONSTRAINT sso_providers_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: users users_phone_key; Type: CONSTRAINT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.users\n    ADD CONSTRAINT users_phone_key UNIQUE (phone);\n\n\n--\n-- Name: users users_pkey; Type: CONSTRAINT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.users\n    ADD CONSTRAINT users_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: absences absences_pkey; Type: CONSTRAINT; Schema: public; Owner: -\n--\n\nALTER TABLE ONLY public.absences\n    ADD CONSTRAINT absences_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: app_settings app_settings_pkey; Type: CONSTRAINT; Schema: public; Owner: -\n--\n\nALTER TABLE ONLY public.app_settings\n    ADD CONSTRAINT app_settings_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: employees employees_pkey; Type: CONSTRAINT; Schema: public; Owner: -\n--\n\nALTER TABLE ONLY public.employees\n    ADD CONSTRAINT employees_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: mail_jobs mail_jobs_job_key_unique; Type: CONSTRAINT; Schema: public; Owner: -\n--\n\nALTER TABLE ONLY public.mail_jobs\n    ADD CONSTRAINT mail_jobs_job_key_unique UNIQUE (job_key);\n\n\n--\n-- Name: mail_jobs mail_jobs_pkey; Type: CONSTRAINT; Schema: public; Owner: -\n--\n\nALTER TABLE ONLY public.mail_jobs\n    ADD CONSTRAINT mail_jobs_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: notifications notifications_pkey; Type: CONSTRAINT; Schema: public; Owner: -\n--\n\nALTER TABLE ONLY public.notifications\n    ADD CONSTRAINT notifications_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: profiles profiles_email_key; Type: CONSTRAINT; Schema: public; Owner: -\n--\n\nALTER TABLE ONLY public.profiles\n    ADD CONSTRAINT profiles_email_key UNIQUE (email);\n\n\n--\n-- Name: profiles profiles_pkey; Type: CONSTRAINT; Schema: public; Owner: -\n--\n\nALTER TABLE ONLY public.profiles\n    ADD CONSTRAINT profiles_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: shifts shifts_employee_id_work_date_key; Type: CONSTRAINT; Schema: public; Owner: -\n--\n\nALTER TABLE ONLY public.shifts\n    ADD CONSTRAINT shifts_employee_id_work_date_key UNIQUE (employee_id, work_date);\n\n\n--\n-- Name: shifts shifts_pkey; Type: CONSTRAINT; Schema: public; Owner: -\n--\n\nALTER TABLE ONLY public.shifts\n    ADD CONSTRAINT shifts_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: messages messages_pkey; Type: CONSTRAINT; Schema: realtime; Owner: -\n--\n\nALTER TABLE ONLY realtime.messages\n    ADD CONSTRAINT messages_pkey PRIMARY KEY (id, inserted_at);\n\n\n--\n-- Name: messages_2025_08_29 messages_2025_08_29_pkey; Type: CONSTRAINT; Schema: realtime; Owner: -\n--\n\nALTER TABLE ONLY realtime.messages_2025_08_29\n    ADD CONSTRAINT messages_2025_08_29_pkey PRIMARY KEY (id, inserted_at);\n\n\n--\n-- Name: messages_2025_08_30 messages_2025_08_30_pkey; Type: CONSTRAINT; Schema: realtime; Owner: -\n--\n\nALTER TABLE ONLY realtime.messages_2025_08_30\n    ADD CONSTRAINT messages_2025_08_30_pkey PRIMARY KEY (id, inserted_at);\n\n\n--\n-- Name: messages_2025_08_31 messages_2025_08_31_pkey; Type: CONSTRAINT; Schema: realtime; Owner: -\n--\n\nALTER TABLE ONLY realtime.messages_2025_08_31\n    ADD CONSTRAINT messages_2025_08_31_pkey PRIMARY KEY (id, inserted_at);\n\n\n--\n-- Name: messages_2025_09_01 messages_2025_09_01_pkey; Type: CONSTRAINT; Schema: realtime; Owner: -\n--\n\nALTER TABLE ONLY realtime.messages_2025_09_01\n    ADD CONSTRAINT messages_2025_09_01_pkey PRIMARY KEY (id, inserted_at);\n\n\n--\n-- Name: messages_2025_09_02 messages_2025_09_02_pkey; Type: CONSTRAINT; Schema: realtime; Owner: -\n--\n\nALTER TABLE ONLY realtime.messages_2025_09_02\n    ADD CONSTRAINT messages_2025_09_02_pkey PRIMARY KEY (id, inserted_at);\n\n\n--\n-- Name: messages_2025_09_03 messages_2025_09_03_pkey; Type: CONSTRAINT; Schema: realtime; Owner: -\n--\n\nALTER TABLE ONLY realtime.messages_2025_09_03\n    ADD CONSTRAINT messages_2025_09_03_pkey PRIMARY KEY (id, inserted_at);\n\n\n--\n-- Name: messages_2025_09_04 messages_2025_09_04_pkey; Type: CONSTRAINT; Schema: realtime; Owner: -\n--\n\nALTER TABLE ONLY realtime.messages_2025_09_04\n    ADD CONSTRAINT messages_2025_09_04_pkey PRIMARY KEY (id, inserted_at);\n\n\n--\n-- Name: subscription pk_subscription; Type: CONSTRAINT; Schema: realtime; Owner: -\n--\n\nALTER TABLE ONLY realtime.subscription\n    ADD CONSTRAINT pk_subscription PRIMARY KEY (id);\n\n\n--\n-- Name: schema_migrations schema_migrations_pkey; Type: CONSTRAINT; Schema: realtime; Owner: -\n--\n\nALTER TABLE ONLY realtime.schema_migrations\n    ADD CONSTRAINT schema_migrations_pkey PRIMARY KEY (version);\n\n\n--\n-- Name: buckets buckets_pkey; Type: CONSTRAINT; Schema: storage; Owner: -\n--\n\nALTER TABLE ONLY storage.buckets\n    ADD CONSTRAINT buckets_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: migrations migrations_name_key; Type: CONSTRAINT; Schema: storage; Owner: -\n--\n\nALTER TABLE ONLY storage.migrations\n    ADD CONSTRAINT migrations_name_key UNIQUE (name);\n\n\n--\n-- Name: migrations migrations_pkey; Type: CONSTRAINT; Schema: storage; Owner: -\n--\n\nALTER TABLE ONLY storage.migrations\n    ADD CONSTRAINT migrations_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: objects objects_pkey; Type: CONSTRAINT; Schema: storage; Owner: -\n--\n\nALTER TABLE ONLY storage.objects\n    ADD CONSTRAINT objects_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: s3_multipart_uploads_parts s3_multipart_uploads_parts_pkey; Type: CONSTRAINT; Schema: storage; Owner: -\n--\n\nALTER TABLE ONLY storage.s3_multipart_uploads_parts\n    ADD CONSTRAINT s3_multipart_uploads_parts_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: s3_multipart_uploads s3_multipart_uploads_pkey; Type: CONSTRAINT; Schema: storage; Owner: -\n--\n\nALTER TABLE ONLY storage.s3_multipart_uploads\n    ADD CONSTRAINT s3_multipart_uploads_pkey PRIMARY KEY (id);\n\n\n--\n-- Name: schema_migrations schema_migrations_pkey; Type: CONSTRAINT; Schema: supabase_migrations; Owner: -\n--\n\nALTER TABLE ONLY supabase_migrations.schema_migrations\n    ADD CONSTRAINT schema_migrations_pkey PRIMARY KEY (version);\n\n\n--\n-- Name: seed_files seed_files_pkey; Type: CONSTRAINT; Schema: supabase_migrations; Owner: -\n--\n\nALTER TABLE ONLY supabase_migrations.seed_files\n    ADD CONSTRAINT seed_files_pkey PRIMARY KEY (path);\n\n\n--\n-- Name: audit_logs_instance_id_idx; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE INDEX audit_logs_instance_id_idx ON auth.audit_log_entries USING btree (instance_id);\n\n\n--\n-- Name: confirmation_token_idx; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE UNIQUE INDEX confirmation_token_idx ON auth.users USING btree (confirmation_token) WHERE ((confirmation_token)::text !~ '^[0-9 ]*$'::text);\n\n\n--\n-- Name: email_change_token_current_idx; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE UNIQUE INDEX email_change_token_current_idx ON auth.users USING btree (email_change_token_current) WHERE ((email_change_token_current)::text !~ '^[0-9 ]*$'::text);\n\n\n--\n-- Name: email_change_token_new_idx; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE UNIQUE INDEX email_change_token_new_idx ON auth.users USING btree (email_change_token_new) WHERE ((email_change_token_new)::text !~ '^[0-9 ]*$'::text);\n\n\n--\n-- Name: factor_id_created_at_idx; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE INDEX factor_id_created_at_idx ON auth.mfa_factors USING btree (user_id, created_at);\n\n\n--\n-- Name: flow_state_created_at_idx; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE INDEX flow_state_created_at_idx ON auth.flow_state USING btree (created_at DESC);\n\n\n--\n-- Name: identities_email_idx; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE INDEX identities_email_idx ON auth.identities USING btree (email text_pattern_ops);\n\n\n--\n-- Name: INDEX identities_email_idx; Type: COMMENT; Schema: auth; Owner: -\n--\n\nCOMMENT ON INDEX auth.identities_email_idx IS 'Auth: Ensures indexed queries on the email column';\n\n\n--\n-- Name: identities_user_id_idx; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE INDEX identities_user_id_idx ON auth.identities USING btree (user_id);\n\n\n--\n-- Name: idx_auth_code; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE INDEX idx_auth_code ON auth.flow_state USING btree (auth_code);\n\n\n--\n-- Name: idx_user_id_auth_method; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE INDEX idx_user_id_auth_method ON auth.flow_state USING btree (user_id, authentication_method);\n\n\n--\n-- Name: mfa_challenge_created_at_idx; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE INDEX mfa_challenge_created_at_idx ON auth.mfa_challenges USING btree (created_at DESC);\n\n\n--\n-- Name: mfa_factors_user_friendly_name_unique; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE UNIQUE INDEX mfa_factors_user_friendly_name_unique ON auth.mfa_factors USING btree (friendly_name, user_id) WHERE (TRIM(BOTH FROM friendly_name) <> ''::text);\n\n\n--\n-- Name: mfa_factors_user_id_idx; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE INDEX mfa_factors_user_id_idx ON auth.mfa_factors USING btree (user_id);\n\n\n--\n-- Name: one_time_tokens_relates_to_hash_idx; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE INDEX one_time_tokens_relates_to_hash_idx ON auth.one_time_tokens USING hash (relates_to);\n\n\n--\n-- Name: one_time_tokens_token_hash_hash_idx; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE INDEX one_time_tokens_token_hash_hash_idx ON auth.one_time_tokens USING hash (token_hash);\n\n\n--\n-- Name: one_time_tokens_user_id_token_type_key; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE UNIQUE INDEX one_time_tokens_user_id_token_type_key ON auth.one_time_tokens USING btree (user_id, token_type);\n\n\n--\n-- Name: reauthentication_token_idx; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE UNIQUE INDEX reauthentication_token_idx ON auth.users USING btree (reauthentication_token) WHERE ((reauthentication_token)::text !~ '^[0-9 ]*$'::text);\n\n\n--\n-- Name: recovery_token_idx; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE UNIQUE INDEX recovery_token_idx ON auth.users USING btree (recovery_token) WHERE ((recovery_token)::text !~ '^[0-9 ]*$'::text);\n\n\n--\n-- Name: refresh_tokens_instance_id_idx; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE INDEX refresh_tokens_instance_id_idx ON auth.refresh_tokens USING btree (instance_id);\n\n\n--\n-- Name: refresh_tokens_instance_id_user_id_idx; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE INDEX refresh_tokens_instance_id_user_id_idx ON auth.refresh_tokens USING btree (instance_id, user_id);\n\n\n--\n-- Name: refresh_tokens_parent_idx; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE INDEX refresh_tokens_parent_idx ON auth.refresh_tokens USING btree (parent);\n\n\n--\n-- Name: refresh_tokens_session_id_revoked_idx; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE INDEX refresh_tokens_session_id_revoked_idx ON auth.refresh_tokens USING btree (session_id, revoked);\n\n\n--\n-- Name: refresh_tokens_updated_at_idx; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE INDEX refresh_tokens_updated_at_idx ON auth.refresh_tokens USING btree (updated_at DESC);\n\n\n--\n-- Name: saml_providers_sso_provider_id_idx; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE INDEX saml_providers_sso_provider_id_idx ON auth.saml_providers USING btree (sso_provider_id);\n\n\n--\n-- Name: saml_relay_states_created_at_idx; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE INDEX saml_relay_states_created_at_idx ON auth.saml_relay_states USING btree (created_at DESC);\n\n\n--\n-- Name: saml_relay_states_for_email_idx; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE INDEX saml_relay_states_for_email_idx ON auth.saml_relay_states USING btree (for_email);\n\n\n--\n-- Name: saml_relay_states_sso_provider_id_idx; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE INDEX saml_relay_states_sso_provider_id_idx ON auth.saml_relay_states USING btree (sso_provider_id);\n\n\n--\n-- Name: sessions_not_after_idx; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE INDEX sessions_not_after_idx ON auth.sessions USING btree (not_after DESC);\n\n\n--\n-- Name: sessions_user_id_idx; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE INDEX sessions_user_id_idx ON auth.sessions USING btree (user_id);\n\n\n--\n-- Name: sso_domains_domain_idx; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE UNIQUE INDEX sso_domains_domain_idx ON auth.sso_domains USING btree (lower(domain));\n\n\n--\n-- Name: sso_domains_sso_provider_id_idx; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE INDEX sso_domains_sso_provider_id_idx ON auth.sso_domains USING btree (sso_provider_id);\n\n\n--\n-- Name: sso_providers_resource_id_idx; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE UNIQUE INDEX sso_providers_resource_id_idx ON auth.sso_providers USING btree (lower(resource_id));\n\n\n--\n-- Name: sso_providers_resource_id_pattern_idx; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE INDEX sso_providers_resource_id_pattern_idx ON auth.sso_providers USING btree (resource_id text_pattern_ops);\n\n\n--\n-- Name: unique_phone_factor_per_user; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE UNIQUE INDEX unique_phone_factor_per_user ON auth.mfa_factors USING btree (user_id, phone);\n\n\n--\n-- Name: user_id_created_at_idx; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE INDEX user_id_created_at_idx ON auth.sessions USING btree (user_id, created_at);\n\n\n--\n-- Name: users_email_partial_key; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE UNIQUE INDEX users_email_partial_key ON auth.users USING btree (email) WHERE (is_sso_user = false);\n\n\n--\n-- Name: INDEX users_email_partial_key; Type: COMMENT; Schema: auth; Owner: -\n--\n\nCOMMENT ON INDEX auth.users_email_partial_key IS 'Auth: A partial unique index that applies only when is_sso_user is false';\n\n\n--\n-- Name: users_instance_id_email_idx; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE INDEX users_instance_id_email_idx ON auth.users USING btree (instance_id, lower((email)::text));\n\n\n--\n-- Name: users_instance_id_idx; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE INDEX users_instance_id_idx ON auth.users USING btree (instance_id);\n\n\n--\n-- Name: users_is_anonymous_idx; Type: INDEX; Schema: auth; Owner: -\n--\n\nCREATE INDEX users_is_anonymous_idx ON auth.users USING btree (is_anonymous);\n\n\n--\n-- Name: employees_email_lower_uq; Type: INDEX; Schema: public; Owner: -\n--\n\nCREATE UNIQUE INDEX employees_email_lower_uq ON public.employees USING btree (lower(email)) WHERE (email IS NOT NULL);\n\n\n--\n-- Name: idx_absences_emp_dates; Type: INDEX; Schema: public; Owner: -\n--\n\nCREATE INDEX idx_absences_emp_dates ON public.absences USING btree (employee_id, start_date, end_date);\n\n\n--\n-- Name: idx_notifications_created_at; Type: INDEX; Schema: public; Owner: -\n--\n\nCREATE INDEX idx_notifications_created_at ON public.notifications USING btree (created_at DESC);\n\n\n--\n-- Name: idx_notifications_is_read; Type: INDEX; Schema: public; Owner: -\n--\n\nCREATE INDEX idx_notifications_is_read ON public.notifications USING btree (is_read);\n\n\n--\n-- Name: idx_shifts_emp_date_pub; Type: INDEX; Schema: public; Owner: -\n--\n\nCREATE INDEX idx_shifts_emp_date_pub ON public.shifts USING btree (employee_id, work_date, published);\n\n\n--\n-- Name: idx_shifts_employee_id; Type: INDEX; Schema: public; Owner: -\n--\n\nCREATE INDEX idx_shifts_employee_id ON public.shifts USING btree (employee_id);\n\n\n--\n-- Name: idx_shifts_published; Type: INDEX; Schema: public; Owner: -\n--\n\nCREATE INDEX idx_shifts_published ON public.shifts USING btree (published);\n\n\n--\n-- Name: idx_shifts_work_date; Type: INDEX; Schema: public; Owner: -\n--\n\nCREATE INDEX idx_shifts_work_date ON public.shifts USING btree (work_date);\n\n\n--\n-- Name: mail_jobs_emp_queued_idx; Type: INDEX; Schema: public; Owner: -\n--\n\nCREATE INDEX mail_jobs_emp_queued_idx ON public.mail_jobs USING btree (((payload ->> 'employee_id'::text))) WHERE (status = 'queued'::text);\n\n\n--\n-- Name: mail_jobs_queued_time_type_idx; Type: INDEX; Schema: public; Owner: -\n--\n\nCREATE INDEX mail_jobs_queued_time_type_idx ON public.mail_jobs USING btree (created_at, type) WHERE (status = 'queued'::text);\n\n\n--\n-- Name: mail_jobs_status_idx; Type: INDEX; Schema: public; Owner: -\n--\n\nCREATE INDEX mail_jobs_status_idx ON public.mail_jobs USING btree (status) WHERE (status = 'queued'::text);\n\n\n--\n-- Name: mail_jobs_unique_key; Type: INDEX; Schema: public; Owner: -\n--\n\nCREATE UNIQUE INDEX mail_jobs_unique_key ON public.mail_jobs USING btree (job_key) WHERE (type = 'admin_new_absence'::text);\n\n\n--\n-- Name: ix_realtime_subscription_entity; Type: INDEX; Schema: realtime; Owner: -\n--\n\nCREATE INDEX ix_realtime_subscription_entity ON realtime.subscription USING btree (entity);\n\n\n--\n-- Name: subscription_subscription_id_entity_filters_key; Type: INDEX; Schema: realtime; Owner: -\n--\n\nCREATE UNIQUE INDEX subscription_subscription_id_entity_filters_key ON realtime.subscription USING btree (subscription_id, entity, filters);\n\n\n--\n-- Name: bname; Type: INDEX; Schema: storage; Owner: -\n--\n\nCREATE UNIQUE INDEX bname ON storage.buckets USING btree (name);\n\n\n--\n-- Name: bucketid_objname; Type: INDEX; Schema: storage; Owner: -\n--\n\nCREATE UNIQUE INDEX bucketid_objname ON storage.objects USING btree (bucket_id, name);\n\n\n--\n-- Name: idx_multipart_uploads_list; Type: INDEX; Schema: storage; Owner: -\n--\n\nCREATE INDEX idx_multipart_uploads_list ON storage.s3_multipart_uploads USING btree (bucket_id, key, created_at);\n\n\n--\n-- Name: idx_objects_bucket_id_name; Type: INDEX; Schema: storage; Owner: -\n--\n\nCREATE INDEX idx_objects_bucket_id_name ON storage.objects USING btree (bucket_id, name COLLATE \"C\");\n\n\n--\n-- Name: name_prefix_search; Type: INDEX; Schema: storage; Owner: -\n--\n\nCREATE INDEX name_prefix_search ON storage.objects USING btree (name text_pattern_ops);\n\n\n--\n-- Name: messages_2025_08_29_pkey; Type: INDEX ATTACH; Schema: realtime; Owner: -\n--\n\nALTER INDEX realtime.messages_pkey ATTACH PARTITION realtime.messages_2025_08_29_pkey;\n\n\n--\n-- Name: messages_2025_08_30_pkey; Type: INDEX ATTACH; Schema: realtime; Owner: -\n--\n\nALTER INDEX realtime.messages_pkey ATTACH PARTITION realtime.messages_2025_08_30_pkey;\n\n\n--\n-- Name: messages_2025_08_31_pkey; Type: INDEX ATTACH; Schema: realtime; Owner: -\n--\n\nALTER INDEX realtime.messages_pkey ATTACH PARTITION realtime.messages_2025_08_31_pkey;\n\n\n--\n-- Name: messages_2025_09_01_pkey; Type: INDEX ATTACH; Schema: realtime; Owner: -\n--\n\nALTER INDEX realtime.messages_pkey ATTACH PARTITION realtime.messages_2025_09_01_pkey;\n\n\n--\n-- Name: messages_2025_09_02_pkey; Type: INDEX ATTACH; Schema: realtime; Owner: -\n--\n\nALTER INDEX realtime.messages_pkey ATTACH PARTITION realtime.messages_2025_09_02_pkey;\n\n\n--\n-- Name: messages_2025_09_03_pkey; Type: INDEX ATTACH; Schema: realtime; Owner: -\n--\n\nALTER INDEX realtime.messages_pkey ATTACH PARTITION realtime.messages_2025_09_03_pkey;\n\n\n--\n-- Name: messages_2025_09_04_pkey; Type: INDEX ATTACH; Schema: realtime; Owner: -\n--\n\nALTER INDEX realtime.messages_pkey ATTACH PARTITION realtime.messages_2025_09_04_pkey;\n\n\n--\n-- Name: absences trg_absence_enqueue_job; Type: TRIGGER; Schema: public; Owner: -\n--\n\nCREATE TRIGGER trg_absence_enqueue_job AFTER INSERT ON public.absences FOR EACH ROW EXECUTE FUNCTION public.trg_absence_enqueue_job();\n\n\n--\n-- Name: absences trg_admin_new_absence; Type: TRIGGER; Schema: public; Owner: -\n--\n\nCREATE TRIGGER trg_admin_new_absence AFTER INSERT ON public.absences FOR EACH ROW EXECUTE FUNCTION public.enqueue_admin_new_absence();\n\n\n--\n-- Name: shifts trg_employee_new_shift; Type: TRIGGER; Schema: public; Owner: -\n--\n\nCREATE TRIGGER trg_employee_new_shift AFTER INSERT ON public.shifts FOR EACH ROW EXECUTE FUNCTION public.enqueue_employee_new_shift();\n\n\n--\n-- Name: shifts trg_employee_shift_changed; Type: TRIGGER; Schema: public; Owner: -\n--\n\nCREATE TRIGGER trg_employee_shift_changed AFTER UPDATE ON public.shifts FOR EACH ROW EXECUTE FUNCTION public.enqueue_employee_shift_changed();\n\n\n--\n-- Name: shifts trg_employee_shift_deleted; Type: TRIGGER; Schema: public; Owner: -\n--\n\nCREATE TRIGGER trg_employee_shift_deleted AFTER DELETE ON public.shifts FOR EACH ROW EXECUTE FUNCTION public.enqueue_employee_shift_deleted();\n\n\n--\n-- Name: absences trg_notify_absence_insert; Type: TRIGGER; Schema: public; Owner: -\n--\n\nCREATE TRIGGER trg_notify_absence_insert AFTER INSERT ON public.absences FOR EACH ROW EXECUTE FUNCTION public.notify_absence_insert();\n\n\n--\n-- Name: absences trg_notify_absence_update; Type: TRIGGER; Schema: public; Owner: -\n--\n\nCREATE TRIGGER trg_notify_absence_update AFTER UPDATE ON public.absences FOR EACH ROW EXECUTE FUNCTION public.notify_absence_status_update();\n\n\n--\n-- Name: employees trg_notify_employee_added; Type: TRIGGER; Schema: public; Owner: -\n--\n\nCREATE TRIGGER trg_notify_employee_added AFTER INSERT ON public.employees FOR EACH ROW EXECUTE FUNCTION public.notify_employee_added();\n\n\n--\n-- Name: shifts trg_shifts_on_publish_flip; Type: TRIGGER; Schema: public; Owner: -\n--\n\nCREATE TRIGGER trg_shifts_on_publish_flip BEFORE UPDATE OF published ON public.shifts FOR EACH ROW EXECUTE FUNCTION public.enqueue_on_publish_flip();\n\n\n--\n-- Name: shifts trg_shifts_updated_at; Type: TRIGGER; Schema: public; Owner: -\n--\n\nCREATE TRIGGER trg_shifts_updated_at BEFORE UPDATE ON public.shifts FOR EACH ROW EXECUTE FUNCTION public.set_updated_at();\n\n\n--\n-- Name: subscription tr_check_filters; Type: TRIGGER; Schema: realtime; Owner: -\n--\n\nCREATE TRIGGER tr_check_filters BEFORE INSERT OR UPDATE ON realtime.subscription FOR EACH ROW EXECUTE FUNCTION realtime.subscription_check_filters();\n\n\n--\n-- Name: objects update_objects_updated_at; Type: TRIGGER; Schema: storage; Owner: -\n--\n\nCREATE TRIGGER update_objects_updated_at BEFORE UPDATE ON storage.objects FOR EACH ROW EXECUTE FUNCTION storage.update_updated_at_column();\n\n\n--\n-- Name: identities identities_user_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.identities\n    ADD CONSTRAINT identities_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;\n\n\n--\n-- Name: mfa_amr_claims mfa_amr_claims_session_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.mfa_amr_claims\n    ADD CONSTRAINT mfa_amr_claims_session_id_fkey FOREIGN KEY (session_id) REFERENCES auth.sessions(id) ON DELETE CASCADE;\n\n\n--\n-- Name: mfa_challenges mfa_challenges_auth_factor_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.mfa_challenges\n    ADD CONSTRAINT mfa_challenges_auth_factor_id_fkey FOREIGN KEY (factor_id) REFERENCES auth.mfa_factors(id) ON DELETE CASCADE;\n\n\n--\n-- Name: mfa_factors mfa_factors_user_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.mfa_factors\n    ADD CONSTRAINT mfa_factors_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;\n\n\n--\n-- Name: one_time_tokens one_time_tokens_user_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.one_time_tokens\n    ADD CONSTRAINT one_time_tokens_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;\n\n\n--\n-- Name: refresh_tokens refresh_tokens_session_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.refresh_tokens\n    ADD CONSTRAINT refresh_tokens_session_id_fkey FOREIGN KEY (session_id) REFERENCES auth.sessions(id) ON DELETE CASCADE;\n\n\n--\n-- Name: saml_providers saml_providers_sso_provider_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.saml_providers\n    ADD CONSTRAINT saml_providers_sso_provider_id_fkey FOREIGN KEY (sso_provider_id) REFERENCES auth.sso_providers(id) ON DELETE CASCADE;\n\n\n--\n-- Name: saml_relay_states saml_relay_states_flow_state_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.saml_relay_states\n    ADD CONSTRAINT saml_relay_states_flow_state_id_fkey FOREIGN KEY (flow_state_id) REFERENCES auth.flow_state(id) ON DELETE CASCADE;\n\n\n--\n-- Name: saml_relay_states saml_relay_states_sso_provider_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.saml_relay_states\n    ADD CONSTRAINT saml_relay_states_sso_provider_id_fkey FOREIGN KEY (sso_provider_id) REFERENCES auth.sso_providers(id) ON DELETE CASCADE;\n\n\n--\n-- Name: sessions sessions_user_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.sessions\n    ADD CONSTRAINT sessions_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id) ON DELETE CASCADE;\n\n\n--\n-- Name: sso_domains sso_domains_sso_provider_id_fkey; Type: FK CONSTRAINT; Schema: auth; Owner: -\n--\n\nALTER TABLE ONLY auth.sso_domains\n    ADD CONSTRAINT sso_domains_sso_provider_id_fkey FOREIGN KEY (sso_provider_id) REFERENCES auth.sso_providers(id) ON DELETE CASCADE;\n\n\n--\n-- Name: absences absences_employee_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -\n--\n\nALTER TABLE ONLY public.absences\n    ADD CONSTRAINT absences_employee_id_fkey FOREIGN KEY (employee_id) REFERENCES public.employees(id) ON DELETE CASCADE;\n\n\n--\n-- Name: shifts shifts_employee_id_fkey; Type: FK CONSTRAINT; Schema: public; Owner: -\n--\n\nALTER TABLE ONLY public.shifts\n    ADD CONSTRAINT shifts_employee_id_fkey FOREIGN KEY (employee_id) REFERENCES public.employees(id) ON DELETE CASCADE;\n\n\n--\n-- Name: objects objects_bucketId_fkey; Type: FK CONSTRAINT; Schema: storage; Owner: -\n--\n\nALTER TABLE ONLY storage.objects\n    ADD CONSTRAINT \"objects_bucketId_fkey\" FOREIGN KEY (bucket_id) REFERENCES storage.buckets(id);\n\n\n--\n-- Name: s3_multipart_uploads s3_multipart_uploads_bucket_id_fkey; Type: FK CONSTRAINT; Schema: storage; Owner: -\n--\n\nALTER TABLE ONLY storage.s3_multipart_uploads\n    ADD CONSTRAINT s3_multipart_uploads_bucket_id_fkey FOREIGN KEY (bucket_id) REFERENCES storage.buckets(id);\n\n\n--\n-- Name: s3_multipart_uploads_parts s3_multipart_uploads_parts_bucket_id_fkey; Type: FK CONSTRAINT; Schema: storage; Owner: -\n--\n\nALTER TABLE ONLY storage.s3_multipart_uploads_parts\n    ADD CONSTRAINT s3_multipart_uploads_parts_bucket_id_fkey FOREIGN KEY (bucket_id) REFERENCES storage.buckets(id);\n\n\n--\n-- Name: s3_multipart_uploads_parts s3_multipart_uploads_parts_upload_id_fkey; Type: FK CONSTRAINT; Schema: storage; Owner: -\n--\n\nALTER TABLE ONLY storage.s3_multipart_uploads_parts\n    ADD CONSTRAINT s3_multipart_uploads_parts_upload_id_fkey FOREIGN KEY (upload_id) REFERENCES storage.s3_multipart_uploads(id) ON DELETE CASCADE;\n\n\n--\n-- Name: audit_log_entries; Type: ROW SECURITY; Schema: auth; Owner: -\n--\n\nALTER TABLE auth.audit_log_entries ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: flow_state; Type: ROW SECURITY; Schema: auth; Owner: -\n--\n\nALTER TABLE auth.flow_state ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: identities; Type: ROW SECURITY; Schema: auth; Owner: -\n--\n\nALTER TABLE auth.identities ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: instances; Type: ROW SECURITY; Schema: auth; Owner: -\n--\n\nALTER TABLE auth.instances ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: mfa_amr_claims; Type: ROW SECURITY; Schema: auth; Owner: -\n--\n\nALTER TABLE auth.mfa_amr_claims ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: mfa_challenges; Type: ROW SECURITY; Schema: auth; Owner: -\n--\n\nALTER TABLE auth.mfa_challenges ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: mfa_factors; Type: ROW SECURITY; Schema: auth; Owner: -\n--\n\nALTER TABLE auth.mfa_factors ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: one_time_tokens; Type: ROW SECURITY; Schema: auth; Owner: -\n--\n\nALTER TABLE auth.one_time_tokens ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: refresh_tokens; Type: ROW SECURITY; Schema: auth; Owner: -\n--\n\nALTER TABLE auth.refresh_tokens ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: saml_providers; Type: ROW SECURITY; Schema: auth; Owner: -\n--\n\nALTER TABLE auth.saml_providers ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: saml_relay_states; Type: ROW SECURITY; Schema: auth; Owner: -\n--\n\nALTER TABLE auth.saml_relay_states ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: schema_migrations; Type: ROW SECURITY; Schema: auth; Owner: -\n--\n\nALTER TABLE auth.schema_migrations ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: sessions; Type: ROW SECURITY; Schema: auth; Owner: -\n--\n\nALTER TABLE auth.sessions ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: sso_domains; Type: ROW SECURITY; Schema: auth; Owner: -\n--\n\nALTER TABLE auth.sso_domains ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: sso_providers; Type: ROW SECURITY; Schema: auth; Owner: -\n--\n\nALTER TABLE auth.sso_providers ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: users; Type: ROW SECURITY; Schema: auth; Owner: -\n--\n\nALTER TABLE auth.users ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: absences; Type: ROW SECURITY; Schema: public; Owner: -\n--\n\nALTER TABLE public.absences ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: absences absences_insert_auth; Type: POLICY; Schema: public; Owner: -\n--\n\nCREATE POLICY absences_insert_auth ON public.absences FOR INSERT TO authenticated WITH CHECK (true);\n\n\n--\n-- Name: absences absences_read_auth; Type: POLICY; Schema: public; Owner: -\n--\n\nCREATE POLICY absences_read_auth ON public.absences FOR SELECT TO authenticated USING (true);\n\n\n--\n-- Name: app_settings; Type: ROW SECURITY; Schema: public; Owner: -\n--\n\nALTER TABLE public.app_settings ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: employees dev: employees select for anon; Type: POLICY; Schema: public; Owner: -\n--\n\nCREATE POLICY \"dev: employees select for anon\" ON public.employees FOR SELECT TO anon USING (true);\n\n\n--\n-- Name: notifications dev: notifications select for anon; Type: POLICY; Schema: public; Owner: -\n--\n\nCREATE POLICY \"dev: notifications select for anon\" ON public.notifications FOR SELECT TO anon USING (true);\n\n\n--\n-- Name: employees; Type: ROW SECURITY; Schema: public; Owner: -\n--\n\nALTER TABLE public.employees ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: employees employees_select_auth; Type: POLICY; Schema: public; Owner: -\n--\n\nCREATE POLICY employees_select_auth ON public.employees FOR SELECT TO authenticated USING (true);\n\n\n--\n-- Name: mail_jobs; Type: ROW SECURITY; Schema: public; Owner: -\n--\n\nALTER TABLE public.mail_jobs ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: notifications; Type: ROW SECURITY; Schema: public; Owner: -\n--\n\nALTER TABLE public.notifications ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: notifications notifications_select_auth; Type: POLICY; Schema: public; Owner: -\n--\n\nCREATE POLICY notifications_select_auth ON public.notifications FOR SELECT TO authenticated USING (true);\n\n\n--\n-- Name: shifts; Type: ROW SECURITY; Schema: public; Owner: -\n--\n\nALTER TABLE public.shifts ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: shifts shifts_select_auth; Type: POLICY; Schema: public; Owner: -\n--\n\nCREATE POLICY shifts_select_auth ON public.shifts FOR SELECT TO authenticated USING (true);\n\n\n--\n-- Name: messages; Type: ROW SECURITY; Schema: realtime; Owner: -\n--\n\nALTER TABLE realtime.messages ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: buckets; Type: ROW SECURITY; Schema: storage; Owner: -\n--\n\nALTER TABLE storage.buckets ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: migrations; Type: ROW SECURITY; Schema: storage; Owner: -\n--\n\nALTER TABLE storage.migrations ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: objects; Type: ROW SECURITY; Schema: storage; Owner: -\n--\n\nALTER TABLE storage.objects ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: s3_multipart_uploads; Type: ROW SECURITY; Schema: storage; Owner: -\n--\n\nALTER TABLE storage.s3_multipart_uploads ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: s3_multipart_uploads_parts; Type: ROW SECURITY; Schema: storage; Owner: -\n--\n\nALTER TABLE storage.s3_multipart_uploads_parts ENABLE ROW LEVEL SECURITY;\n\n--\n-- Name: supabase_realtime; Type: PUBLICATION; Schema: -; Owner: -\n--\n\nCREATE PUBLICATION supabase_realtime WITH (publish = 'insert, update, delete, truncate');\n\n\n--\n-- Name: supabase_realtime_messages_publication; Type: PUBLICATION; Schema: -; Owner: -\n--\n\nCREATE PUBLICATION supabase_realtime_messages_publication WITH (publish = 'insert, update, delete, truncate');\n\n\n--\n-- Name: supabase_realtime shifts; Type: PUBLICATION TABLE; Schema: public; Owner: -\n--\n\nALTER PUBLICATION supabase_realtime ADD TABLE ONLY public.shifts;\n\n\n--\n-- Name: supabase_realtime_messages_publication messages; Type: PUBLICATION TABLE; Schema: realtime; Owner: -\n--\n\nALTER PUBLICATION supabase_realtime_messages_publication ADD TABLE ONLY realtime.messages;\n\n\n--\n-- Name: issue_graphql_placeholder; Type: EVENT TRIGGER; Schema: -; Owner: -\n--\n\nCREATE EVENT TRIGGER issue_graphql_placeholder ON sql_drop\n         WHEN TAG IN ('DROP EXTENSION')\n   EXECUTE FUNCTION extensions.set_graphql_placeholder();\n\n\n--\n-- Name: issue_pg_cron_access; Type: EVENT TRIGGER; Schema: -; Owner: -\n--\n\nCREATE EVENT TRIGGER issue_pg_cron_access ON ddl_command_end\n         WHEN TAG IN ('CREATE EXTENSION')\n   EXECUTE FUNCTION extensions.grant_pg_cron_access();\n\n\n--\n-- Name: issue_pg_graphql_access; Type: EVENT TRIGGER; Schema: -; Owner: -\n--\n\nCREATE EVENT TRIGGER issue_pg_graphql_access ON ddl_command_end\n         WHEN TAG IN ('CREATE FUNCTION')\n   EXECUTE FUNCTION extensions.grant_pg_graphql_access();\n\n\n--\n-- Name: issue_pg_net_access; Type: EVENT TRIGGER; Schema: -; Owner: -\n--\n\nCREATE EVENT TRIGGER issue_pg_net_access ON ddl_command_end\n         WHEN TAG IN ('CREATE EXTENSION')\n   EXECUTE FUNCTION extensions.grant_pg_net_access();\n\n\n--\n-- Name: pgrst_ddl_watch; Type: EVENT TRIGGER; Schema: -; Owner: -\n--\n\nCREATE EVENT TRIGGER pgrst_ddl_watch ON ddl_command_end\n   EXECUTE FUNCTION extensions.pgrst_ddl_watch();\n\n\n--\n-- Name: pgrst_drop_watch; Type: EVENT TRIGGER; Schema: -; Owner: -\n--\n\nCREATE EVENT TRIGGER pgrst_drop_watch ON sql_drop\n   EXECUTE FUNCTION extensions.pgrst_drop_watch();\n\n\n--\n-- PostgreSQL database dump complete\n--\n\n\\unrestrict [REDACTED]\n\n",
        "byteOffset": 0,
        "totalChunks": 1,
        "hasMore": false,
        "startLine": 1,
        "endLine": 3975
      }
    ]
  },
  {
    "path": "src/app/components/SettingsDialog.tsx",
    "size": 20556,
    "sha256": "14627cf85ed1c20836a9f4da1e8d1ecf3c294bb203e72d7305c575f3f09d2428",
    "lang": "tsx",
    "lines": 472,
    "modifiedAt": "2025-09-02T01:28:28+03:00",
    "commitSha": "29d28ab09b16112f6f64a83fb43e1143e63a0ed0",
    "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/SettingsDialog.tsx",
    "chunks": [
      {
        "i": 0,
        "text": "// components/SettingsDialog.tsx\n\"use client\";\n\nimport { useState } from \"react\";\nimport { toast } from \"sonner\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"./ui/popover\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"./ui/tabs\";\nimport { ScrollArea } from \"./ui/scroll-area\";\nimport { Separator } from \"./ui/separator\";\nimport { Button } from \"./ui/button\";\nimport { Switch } from \"./ui/switch\";\nimport { Slider } from \"./ui/slider\";\nimport { Label } from \"./ui/label\";\nimport { Input } from \"./ui/input\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"./ui/select\";\nimport {\n  Settings as SettingsIcon, Download, Upload, RotateCcw, Paintbrush, Zap, FileSpreadsheet,\n  Bell, Shield, Sun, Moon, Monitor, Globe, HardDrive, Database, Trash2\n} from \"lucide-react\";\n\n import { useSettingsStore } from \"@/store/useSettingsStore\";\n import { saveNotificationSettingsToDb } from \"@/lib/settingsDb\";\n import { applyTheme } from \"@/lib/theme\";\nimport type {\n  Theme, Language, WeekStartDay, DateFormat\n} from \"@/lib/settingsSchema\";\n\nexport default function SettingsDialog() {\n  const [isOpen, setIsOpen] = useState(false);\n\n  const settings = useSettingsStore((s) => s.settings);\n  const updateGeneralSettings = useSettingsStore((s) => s.updateGeneral);\n  const updateAutoGenerationSettings = useSettingsStore((s) => s.updateAutoGen);\n  const updateExportSettings = useSettingsStore((s) => s.updateExport);\n  const updateNotificationSettings = useSettingsStore((s) => s.updateNotifications);\n  const updateSystemSettings = useSettingsStore((s) => s.updateSystem);\n  const resetSettings = useSettingsStore((s) => s.reset);\n  const importFromJson = useSettingsStore((s) => s.importFromJson);\n  const exportToFile = useSettingsStore((s) => s.exportToFile);\n\n  const handleExportSettings = () => exportToFile();\n\n  const handleImportSettings = () => {\n    const input = document.createElement(\"input\");\n    input.type = \"file\";\n    input.accept = \"application/json\";\n    input.onchange = async () => {\n      if (!input.files?.[0]) return;\n      try {\n        const text = await input.files[0].text();\n        const json = JSON.parse(text);\n        const res = importFromJson(json);\n        if (!res.ok) {\n          toast.error(`Virhe tiedostossa: ${res.error}`);\n          return;\n        }\n        toast.success(\"Asetukset tuotu\");\n      } catch {\n        toast.error(\"Tiedoston luku epäonnistui\");\n      }\n    };\n    input.click();\n  };\n\n  const handleResetSettings = () => {\n    resetSettings();\n    toast.success(\"Asetukset palautettu oletuksiin\");\n  };\n\n  return (\n    <Popover open={isOpen} onOpenChange={setIsOpen}>\n      <PopoverTrigger asChild>\n        <div\n          className=\"inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 hover:bg-accent hover:text-accent-foreground h-9 w-9 cursor-pointer\"\n          onClick={() => setIsOpen(!isOpen)}\n          aria-label=\"Asetukset\"\n        >\n          <SettingsIcon className=\"w-4 h-4\" />\n        </div>\n      </PopoverTrigger>\n\n      <PopoverContent className=\"w-[680px] p-0\" align=\"end\" sideOffset={5}>\n        {/* Header */}\n        <div className=\"p-4 border-b border-border\">\n          <div className=\"flex items-center justify-between\">\n            <h3 className=\"font-medium\">Asetukset</h3>\n            <div className=\"flex items-center gap-2\">\n              <Button variant=\"ghost\" size=\"sm\" onClick={handleExportSettings} className=\"h-6 px-2 text-xs\">\n                <Download className=\"w-3 h-3 mr-1\" /> Vie\n              </Button>\n              <Button variant=\"ghost\" size=\"sm\" onClick={handleImportSettings} className=\"h-6 px-2 text-xs\">\n                <Upload className=\"w-3 h-3 mr-1\" /> Tuo\n              </Button>\n              <Button\n                variant=\"ghost\"\n                size=\"sm\"\n                onClick={handleResetSettings}\n                className=\"h-6 px-2 text-xs text-destructive hover:text-destructive\"\n              >\n                <RotateCcw className=\"w-3 h-3 mr-1\" /> Palauta\n              </Button>\n            </div>\n          </div>\n        </div>\n\n        {/* Body */}\n        <ScrollArea className=\"max-h-[600px]\">\n          <Tabs defaultValue=\"general\" className=\"w-full\">\n            <TabsList className=\"grid w-full grid-cols-5 p-1 m-2\">\n              <TabsTrigger value=\"general\" className=\"text-xs\">\n                <Paintbrush className=\"w-3 h-3 mr-1\" /> Yleiset\n              </TabsTrigger>\n              <TabsTrigger value=\"auto-generation\" className=\"text-xs\">\n                <Zap className=\"w-3 h-3 mr-1\" /> Auto-gen\n              </TabsTrigger>\n              <TabsTrigger value=\"export\" className=\"text-xs\">\n                <FileSpreadsheet className=\"w-3 h-3 mr-1\" /> Vienti\n              </TabsTrigger>\n              <TabsTrigger value=\"notifications\" className=\"text-xs\">\n                <Bell className=\"w-3 h-3 mr-1\" /> Ilmoitukset\n              </TabsTrigger>\n              <TabsTrigger value=\"system\" className=\"text-xs\">\n                <Shield className=\"w-3 h-3 mr-1\" /> Järjestelmä\n              </TabsTrigger>\n            </TabsList>\n\n            {/* Yleiset */}\n            <TabsContent value=\"general\" className=\"p-4 space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label className=\"text-sm font-medium\">Teema</Label>\n                   <Select\n                 value={settings.general.theme}\n                 onValueChange={(v: Theme) => {\n                  updateGeneralSettings(\"theme\", v);\n                  applyTheme(v);\n                  }}\n                 >\n\n                    <SelectTrigger className=\"h-8\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"light\"><div className=\"flex items-center gap-2\"><Sun className=\"w-3 h-3\" />Vaalea</div></SelectItem>\n                      <SelectItem value=\"dark\"><div className=\"flex items-center gap-2\"><Moon className=\"w-3 h-3\" />Tumma</div></SelectItem>\n                      <SelectItem value=\"system\"><div className=\"flex items-center gap-2\"><Monitor className=\"w-3 h-3\" />Järjestelmä</div></SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n\n                <div className=\"space-y-2\">\n                  <Label className=\"text-sm font-medium\">Kieli</Label>\n                  <Select\n                    value={settings.general.language}\n                    onValueChange={(v: Language) => updateGeneralSettings(\"language\", v)}\n                  >\n                    <SelectTrigger className=\"h-8\"><SelectValue /></SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"fi\"><div className=\"flex items-center gap-2\"><Globe className=\"w-3 h-3\" />Suomi</div></SelectItem>\n                      <SelectItem value=\"en\"><div className=\"flex items-center gap-2\"><Globe className=\"w-3 h-3\" />English</div></SelectItem>\n                      <SelectItem value=\"sv\"><div className=\"flex items-center gap-2\"><Globe className=\"w-3 h-3\" />Svenska</div></SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label className=\"text-sm font-medium\">Viikon alkupäivä</Label>\n                  <Select\n                    value={settings.general.weekStartDay}\n                    onValueChange={(v: WeekStartDay) => updateGeneralSettings(\"weekStartDay\", v)}\n                  >\n                    <SelectTrigger className=\"h-8\"><SelectValue /></SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"monday\">Maanantai</SelectItem>\n                      <SelectItem value=\"sunday\">Sunnuntai</SelectItem>\n                    </SelectContent>\n                  </Select>\n\n                </div>\n              {/* Coming soon */}\n              </div>\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label className=\"text-sm font-medium\">Päivämäärämuoto</Label>\n                  <Select\n                    value={settings.general.dateFormat}\n                    onValueChange={(v: DateFormat) => updateGeneralSettings(\"dateFormat\", v)}\n                  >\n                    <SelectTrigger className=\"h-8\"><SelectValue /></SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"dd.mm.yyyy\">PP.KK.VVVV</SelectItem>\n                      <SelectItem value=\"mm/dd/yyyy\">KK/PP/VVVV</SelectItem>\n                      <SelectItem value=\"yyyy-mm-dd\">VVVV-KK-PP</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n            {/* Oletusaikajakso poistettu MVP:stä */}\n              </div>\n\n\n            </TabsContent>\n\n            {/* Auto-gen */}\n            <TabsContent value=\"auto-generation\" className=\"p-4 space-y-4\">\n              <div className=\"space-y-2\">\n                <Label className=\"text-sm font-medium\">\n                  Oletustuntimäärä: {settings.autoGeneration.defaultHours}h\n                </Label>\n                <Slider\n                  value={[settings.autoGeneration.defaultHours]}\n                  onValueChange={([v]) => updateAutoGenerationSettings(\"defaultHours\", v)}\n                  min={1}\n                  max={12}\n                  step={0.5}\n                />\n                <p className=\"text-xs text-muted-foreground\">\n                  Automaattisesti luodut vuorot käyttävät tätä tuntimäärää\n                </p>\n              </div>\n\n              <Separator />\n\n              {([\n                [\"Jaa vuorot tasaisesti\", \"Jakaa vuorot mahdollisimman tasaisesti\", \"distributeEvenly\"],\n                [\"Noudata työaikoja\", \"Luo vuoroja vain työaikojen sisällä\", \"respectWorkingHours\"],\n                [\"Ohita viikonloput\", \"Älä luo vuoroja lauantaille ja sunnuntaille\", \"skipWeekends\"],\n                [\"Ohita pyhäpäivät\", \"Älä luo vuoroja merkityille pyhäpäiville\", \"skipHolidays\"],\n              ] as const).map(([title, subtitle, key]) => (\n                <div className=\"flex items-center justify-between\" key={key}>\n                  <div>\n                    <Label className=\"text-sm font-medium\">{title}</Label>\n                    <p className=\"text-xs text-muted-foreground\">{subtitle}</p>\n                  </div>\n                  <Switch\n                    checked={settings.autoGeneration[key]}\n                    onCheckedChange={(c) => updateAutoGenerationSettings(key, c)}\n                  />\n                </div>\n              ))}\n\n            </TabsContent>\n\n            {/* Vienti */}\n            <TabsContent value=\"export\" className=\"p-4 space-y-4\">\n              <div className=\"space-y-2\">\n                <Label className=\"text-sm font-medium\">Yrityksen nimi</Label>\n                <Input\n                  value={settings.export.companyName}\n                  onChange={(e) => updateExportSettings(\"companyName\", e.target.value)}\n                  placeholder=\"Yritys Oy\"\n                  className=\"h-8\"\n                />\n              </div>\n\n              <Separator />\n\n              <div className=\"space-y-2\">\n                <Label className=\"text-sm font-medium\">Sisällytä Excel-vientiin</Label>\n                {([\n                  [\"Työntekijöiden nimet\", \"includeNames\"],\n                  [\"Sähköpostiosoitteet\", \"includeEmails\"],\n                  [\"Osastotiedot\", \"includeDepartments\"],\n                  [\"Ei-aktiiviset työntekijät\", \"includeInactiveEmployees\"],\n                  [\"Tyhjät vuorot\", \"includeEmptyShifts\"],\n                  [\"Tuntisummat\", \"includeHourTotals\"],\n                ] as const).map(([label, key]) => (\n                  <div className=\"flex items-center justify-between\" key={key}>\n                    <Label className=\"text-sm\">{label}</Label>\n                    <Switch\n                      checked={settings.export[key]}\n                      onCheckedChange={(c) => updateExportSettings(key, c)}\n                    />\n                  </div>\n                ))}\n              </div>\n            </TabsContent>\n\n            {/* Ilmoitukset */}\n            <TabsContent value=\"notifications\" className=\"p-4 space-y-4\">\n              <div className=\"space-y-3\">\n                <div className=\"flex items-center justify-between\">\n                  <Label className=\"text-sm font-medium\">Sähköposti-ilmoitukset</Label>\n                  <Switch\n                    checked={settings.notifications.emailNotifications}\n                    onCheckedChange={(c) => updateNotificationSettings(\"emailNotifications\", c)}\n                  />\n                </div>\n                <div className=\"space-y-2 pl-1\">\n                  <Label className=\"text-sm font-medium\">Admin-sähköpostit</Label>\n                  <Input\n                    placeholder=\"esim. admin@firma.fi, toinen@firma.fi\"\n                    value={(settings.notifications.adminNotificationEmails ?? []).join(\", \")}\n                    onChange={(e) => {\n                      const emails = e.currentTarget.value\n                        .split(\",\")\n                        .map((s) => s.trim())\n                        .filter(Boolean);\n                      updateNotificationSettings(\"adminNotificationEmails\", emails);\n                    }}\n                    className=\"h-8\"\n                  />\n                  {(!settings.notifications.adminNotificationEmails ||\n                    settings.notifications.adminNotificationEmails.length === 0) && (\n                    <p className=\"text-xs text-amber-600\">\n                      Vinkki: lisää vähintään yksi osoite, muuten ilmoitusta ei lähetetä.\n                    </p>\n                  )}\n                </div>\n              </div>\n              <Separator />\n\n\n\n              <div className=\"space-y-2\">\n                <Label className=\"text-sm font-medium\">Ilmoitussisältö</Label>\n                {([\n                  [\"Poissaolopyynnöt\", \"absenceRequests\"],\n                  [\"Vuoromuutokset\", \"scheduleChanges\"],\n                  [\"Työntekijämuutokset\", \"employeeUpdates\"],\n                  [\"Järjestelmäpäivitykset\", \"systemUpdates\"],\n                ] as const).map(([label, key]) => (\n                  <div className=\"flex items-center justify-between\" key={key}>\n                    <Label className=\"text-sm\">{label}</Label>\n                    <Switch\n                      checked={settings.notifications[key]}\n                      onCheckedChange={(c) => updateNotificationSettings(key, c)}\n                    />\n                  </div>\n                ))}\n              </div>\n\n              <Separator />\n\n              <div className=\"space-y-3\">\n                <div className=\"flex items-center justify-between\">\n                  <div>\n                    <Label className=\"text-sm font-medium\">Päivittäinen yhteenveto</Label>\n                    <p className=\"text-xs text-muted-foreground\">Lähetä päivittäin yhteenveto</p>\n                  </div>\n                  <Switch\n                    checked={settings.notifications.dailyDigest}\n                    onCheckedChange={(c) => updateNotificationSettings(\"dailyDigest\", c)}\n                  />\n                </div>\n\n                {settings.notifications.dailyDigest && (\n                  <div className=\"space-y-2\">\n                    <Label className=\"text-sm\">Lähetysaika</Label>\n                    <Input\n                      type=\"time\"\n                      value={settings.notifications.digestTime}\n                      onChange={(e) => updateNotificationSettings(\"digestTime\", e.target.value)}\n                      className=\"h-8 w-32\"\n                    />\n                  </div>\n                )}\n              </div>\n            </TabsContent>\n\n            {/* Järjestelmä */}\n            <TabsContent value=\"system\" className=\"p-4 space-y-4\">\n              <div className=\"grid grid-cols-2 gap-4 text-sm\">\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">Versio:</span>\n                  <span>{settings.system.version}</span>\n                </div>\n                <div className=\"flex justify-between\">\n                  <span className=\"text-muted-foreground\">Viimeisin varmuuskopio:</span>\n                  <span>{settings.system.lastBackup || \"Ei koskaan\"}</span>\n                </div>\n              </div>\n\n              <Separator />\n\n              {([\n                [\"Huoltotila\", \"Estä muiden käyttäjien pääsy\", \"maintenanceMode\"],\n                [\"Debug-tila\", \"Näytä kehittäjätiedot\", \"debugMode\"],\n              ] as const).map(([title, sub, key]) => (\n                <div className=\"flex items-center justify-between\" key={key}>\n                  <div>\n                    <Label className=\"text-sm font-medium\">{title}</Label>\n                    <p className=\"text-xs text-muted-foreground\">{sub}</p>\n                  </div>\n                  <Switch\n                    checked={settings.system[key]}\n                    onCheckedChange={(c) => updateSystemSettings(key, c)}\n                  />\n                </div>\n              ))}\n\n              <Separator />\n\n              <div className=\"grid grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label className=\"text-sm font-medium\">Max työntekijöitä</Label>\n                  <Input\n                    type=\"number\"\n                    min={1}\n                    max={1000}\n                    value={settings.system.maxEmployees}\n                    onChange={(e) => updateSystemSettings(\"maxEmployees\", Number(e.target.value) || 100)}\n                    className=\"h-8\"\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label className=\"text-sm font-medium\">Datan säilytysaika (pv)</Label>\n                  <Input\n                    type=\"number\"\n                    min={30}\n                    max={3650}\n                    value={settings.system.dataRetentionDays}\n                    onChange={(e) => updateSystemSettings(\"dataRetentionDays\", Number(e.target.value) || 365)}\n                    className=\"h-8\"\n                  />\n                </div>\n              </div>\n\n              <Separator />\n\n              <div className=\"grid grid-cols-2 gap-2\">\n                <Button variant=\"outline\" size=\"sm\" className=\"justify-start\">\n                  <HardDrive className=\"w-3 h-3 mr-2\" /> Luo varmuuskopio\n                </Button>\n                <Button variant=\"outline\" size=\"sm\" className=\"justify-start\">\n                  <Database className=\"w-3 h-3 mr-2\" /> Puhdista välimuisti\n                </Button>\n                <Button variant=\"outline\" size=\"sm\" className=\"justify-start\">\n                  <Download className=\"w-3 h-3 mr-2\" /> Lataa lokit\n                </Button>\n                <Button variant=\"outline\" size=\"sm\" className=\"justify-start text-destructive hover:text-destructive\">\n                  <Trash2 className=\"w-3 h-3 mr-2\" /> Tyhjennä data\n                </Button>\n              </div>\n            </TabsContent>\n          </Tabs>\n        </ScrollArea>\n\n{/* Footer */}\n<div className=\"p-4 border-t border-border\">\n  <div className=\"flex justify-between items-center\">\n    <p className=\"text-xs text-muted-foreground\">\n      Asetukset tallennetaan automaattisesti\n    </p>\n    <Button\n      size=\"sm\"\n      onClick={async () => {\n        try {\n          await saveNotificationSettingsToDb(\n            useSettingsStore.getState().settings.notifications\n          );\n          toast.success(\"Asetukset tallennettu\");\n        } catch (e: unknown) {\n          const msg = e instanceof Error ? e.message : String(e);\n          console.error(\"[app_settings upsert failed]\", msg);\n          toast.error(`Asetusten tallennus DB:hen epäonnistui: ${msg}`);\n        } finally {\n          setIsOpen(false);\n        }\n      }}\n    >\n      Valmis\n    </Button>\n  </div>\n</div>\n      </PopoverContent>\n    </Popover>\n  );\n}\n",
        "byteOffset": 0,
        "totalChunks": 1,
        "hasMore": false,
        "startLine": 1,
        "endLine": 472
      }
    ]
  },
  {
    "path": "src/app/components/ScheduleTable.tsx",
    "size": 20632,
    "sha256": "74de566284b518e463ef684c4d0884488899322c835ac566ca0b669a092d1697",
    "lang": "tsx",
    "lines": 608,
    "modifiedAt": "2025-09-02T01:28:28+03:00",
    "commitSha": "29d28ab09b16112f6f64a83fb43e1143e63a0ed0",
    "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ScheduleTable.tsx",
    "chunks": [
      {
        "i": 0,
        "text": "\"use client\";\n\nimport React, { useEffect, useMemo, useState } from \"react\";\nimport { Badge } from \"./ui/badge\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"./ui/card\";\nimport { Calendar, Clock, Users, AlertCircle, Lock, Plane, Plus, Filter } from \"lucide-react\";\nimport { ShiftType, Employee, DateInfo } from \"../types\";\nimport { supabase } from \"@/lib/supaBaseClient\";\nimport { toast } from \"sonner\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"./ui/popover\";\nimport { Button } from \"./ui/button\";\nimport { Input } from \"./ui/input\";\nimport { useScheduleStore } from \"@/store/useScheduleStore\";\nimport { useSettingsStore } from \"@/store/useSettingsStore\";\nimport { alignToWeekStart } from \"@/lib/dateUtils\";\nimport { logError, logInfo } from \"@/lib/logger\";\n\n\n\n\ntype DateCell = DateInfo & { iso: string };\n\n        type EmployeeRow = {\n          id: string;\n          name: string;\n          email: string;\n          department: string;\n          is_active: boolean;\n        };\n\n        type AbsenceRow = {\n  employee_id: string;\n  start_date: string;\n  end_date: string | null;\n  reason: string | null;\n  status: \"pending\" | \"approved\" | \"declined\";\n};\n\n\n\ninterface ScheduleTableProps {\n  employees?: Employee[]; // säilytetään signatuuri\n}\n\n\nfunction addDaysISO(iso: string, add: number) {\n  // \"T00:00:00\" poistaa aikavyöhykkeen heiton\n  const d = new Date(iso + \"T00:00:00Z\");\n  d.setUTCDate(d.getUTCDate() + add);\n  return d.toISOString().slice(0, 10);\n}\n\nfunction fiWeekdayShort(d: Date) {\n  // su-to klo 0 locale -> FI näyttää ma, ti, ke...\n  return d\n    .toLocaleDateString(\"fi-FI\", { weekday: \"short\" })\n    .replace(\".\", \"\")\n    .toUpperCase()\n    .slice(0, 2);\n}\n\n function fiDayMonth(d: Date) {\n   const day = d.getDate();\n   const month = d.getMonth() + 1;\n   return `${day}.${month}`;\n }\n\n// 🆕 FI-normalisointi (lowercase + diakriittien poisto)\nfunction normalizeFi(s: string) {\n  return (s || \"\")\n    .toLowerCase()\n    .normalize(\"NFD\")\n    .replace(/[\\u0300-\\u036f]/g, \"\");\n}\n\n const DEFAULT_FILTERS = {\n  departments: [] as string[],\n  showActive: false,\n  showInactive: false,\n  searchTerm: \"\",\n}\n\n\nconst ScheduleTable: React.FC<ScheduleTableProps> = () => {\n\nconst startISO = useScheduleStore((s) => s.startDateISO);\nconst days = useScheduleStore((s) => s.days);\nconst weekStartDay = useSettingsStore((s) => s.settings.general.weekStartDay);\n\nconst alignedStart = useMemo(\n  () => alignToWeekStart(startISO, weekStartDay),\n  [startISO, weekStartDay]\n);\n\n\n\nconst shiftsMap = useScheduleStore((s) => s.shiftsMap) ?? {};\nconst filters = useScheduleStore((s) => s.filters) ?? DEFAULT_FILTERS;\n\n//tila-filtteri on aktiivinen, jos vain toinen on päällä\nconst stateFilterActive = filters.showActive !== filters.showInactive;\n\nconst employees = useScheduleStore(s => s.employees);\nconst filteredEmployees = useMemo(() => {\n  const term = normalizeFi((filters.searchTerm ?? \"\").trim());\n  return employees.filter((emp) => {\n    // department\n    if (filters.departments.length > 0 && !filters.departments.includes(emp.department)) {\n      return false;\n    }\n    // active/inactive XOR\n    if (stateFilterActive) {\n      if (filters.showActive && !emp.isActive) return false;\n      if (filters.showInactive && emp.isActive) return false;\n    }\n    // search (nimi + email + osasto)\n    if (term.length > 0) {\n      const hay =\n        normalizeFi(emp.name) +\n        \" \" +\n        normalizeFi(emp.email) +\n        \" \" +\n        normalizeFi(emp.department);\n      if (!hay.includes(term)) return false;\n    }\n    return true;\n  });\n}, [employees, filters, stateFilterActive]);\n  \n  const [loading, setLoading] = useState(true);\n  const [selectedCell, setSelectedCell] = useState<{ employee: string; day: number } | null>(null);\n  const [openPopover, setOpenPopover] = useState<string | null>(null);\n\n\n\n\n  // Päivärivi tuotetaan ISO:sta -> näyttää täsmälleen sun UI:n kaltaisen otsikon\nconst dates: DateCell[] = useMemo(() => {\n  return Array.from({ length: days }).map((_, i): DateCell => {\n    const iso = addDaysISO(alignedStart, i);\n    const d = new Date(iso + \"T00:00:00Z\");\n    return { day: fiWeekdayShort(d), date: fiDayMonth(d), iso };\n  });\n}, [alignedStart, days]);\n\n  // Alignaa heti mountissa ja aina kun viikon aloituspäivä muuttuu,\n  // jotta näkymä on johdonmukainen myös ilman Toolbarin efektiä.\n\n\n  // Vuorot mapattuna: key = `${employee_id}|${work_date}`\n  \n\n// 1) Hae työntekijät + 2) hae vuorot valitulle jaksolle\nuseEffect(() => {\n  (async () => {\n    try {\n      setLoading(true);\n      // Employees\n      const { data: empData, error: empErr } = await supabase\n        .from(\"employees\")\n        .select(\"id, name, email, department, is_active, created_at\")\n        .order(\"created_at\", { ascending: true });\n      if (empErr) throw empErr;\n\n      const mappedEmp: Employee[] = (empData ?? []).map((row: EmployeeRow) => ({\n        id: row.id,\n        name: row.name,\n        email: row.email,\n        department: row.department,\n        isActive: !!row.is_active,\n        shifts: [] as ShiftType[],\n      }));\n\n      const { data: s, error: sErr } = await supabase\n        .from(\"shifts\")\n        .select(\"employee_id, work_date, type, hours\")\n        .gte(\"work_date\", dates[0].iso)\n        .lte(\"work_date\", dates[dates.length - 1].iso)\n        .in(\"employee_id\", mappedEmp.map((e) => e.id));\n      if (sErr) throw sErr;\n\n      useScheduleStore.getState().hydrate({\n        employees: mappedEmp,\n        dates,\n        shifts: (s ?? []).map((r) => ({\n          employee_id: r.employee_id,\n          work_date: r.work_date,\n          type: r.type as \"normal\" | \"locked\" | \"absent\" | \"holiday\",\n          hours: r.hours ?? 0,\n        })),\n      });\n\n      const { data: abs, error: absErr } = await supabase\n        .from(\"absences\")\n        .select(\"employee_id, start_date, end_date, reason, status\")\n        .eq(\"status\", \"approved\")\n        .in(\"employee_id\", mappedEmp.map((e) => e.id));\n      if (absErr) throw absErr;\n\n      const absMap: Record<string, { type: \"absent\" | \"holiday\"; reason: string }> = {};\n      (abs ?? []).forEach((a: AbsenceRow) => {\n        const start = new Date(a.start_date);\n        const end = a.end_date ? new Date(a.end_date) : start;\n        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {\n          const iso = d.toISOString().slice(0, 10);\n          absMap[`${a.employee_id}|${iso}`] = {\n            type: a.reason?.toLowerCase() === \"holiday\" ? \"holiday\" : \"absent\",\n            reason: a.reason ?? \"\",\n          };\n        }\n      });\n      setAbsencesMap(absMap);\n      logInfo(\"ScheduleTable initial fetch OK\");\n    } catch (e) {\n      logError(\"ScheduleTable initial fetch FAILED\", e);\n      toast.error(\"Tietojen haku epäonnistui\");\n    } finally {\n      setLoading(false);\n    }\n  })();\n  // eslint-disable-next-line react-hooks/exhaustive-deps\n}, [startISO, days]);\n\n\n\nconst [absencesMap, setAbsencesMap] = useState<Record<string, { type: \"absent\" | \"holiday\"; reason: string }>>({});\n\n  // Lue solun vuoro mapista\nfunction getShift(empId: string, dayIndex: number): ShiftType {\n  const iso = dates[dayIndex].iso;\n  const key = `${empId}|${iso}`;\n  const row = shiftsMap[key];\n  if (!row) return { type: \"empty\" };                 // UI-fallback\n  if (row.type === \"normal\" || row.type === \"locked\") {\n    return { type: row.type, hours: row.hours ?? 0 };\n  }\n  return { type: row.type }; // absent/holiday\n}\n\n  // Yhteensä tunnit / työntekijä\n  const getTotalHours = (employee: Employee) =>\n    dates.reduce((sum, _, i) => {\n      const s = getShift(employee.id, i);\n      return sum + (s.hours || 0);\n    }, 0);\n\n  // Klikkaus: toggle empty <-> normal(8h), upsert DB:hen\n// ScheduleTable.tsx\n\nconst applyCellChange = useScheduleStore(s => s.applyCellChange);\n\nfunction handleCellClick(employeeId: string, dayIndex: number, hours: number | null) {\n  const iso = dates[dayIndex].iso;\n  applyCellChange({\n    employee_id: employeeId,\n    work_date: iso,\n    hours\n  });\n  setSelectedCell({ employee: employeeId, day: dayIndex });\n}\n\n\n\n\n  // UI-helper solun ulkoasuun\n  const getShiftDisplay = (shift: ShiftType) => {\n    switch (shift.type) {\n      case \"normal\":\n        return { content: `${shift.hours}h`, color: \"bg-primary text-primary-foreground\", icon: <Clock className=\"w-3 h-3\" /> };\n      case \"locked\":\n        return { content: `${shift.hours}h`, color: \"bg-amber-500 text-white\", icon: <Lock className=\"w-3 h-3\" /> };\n      case \"absent\":\n        return { content: \"A\", color: \"bg-destructive text-destructive-foreground\", icon: <AlertCircle className=\"w-3 h-3\" /> };\n      case \"holiday\":\n        return { content: \"H\", color: \"bg-blue-500 text-white\", icon: <Plane className=\"w-3 h-3\" /> };\n      default:\n        return { content: \"\", color: \"bg-muted hover:bg-accent\", icon: <Plus className=\"w-3 h-3 opacity-0 group-hover:opacity-50\" /> };\n    }\n  };\n\n  if (loading) {\n    return <div className=\"text-center py-8 text-muted-foreground\">Ladataan…</div>;\n  }\n\n  return (\n  <div className=\"w-full space-y-6\">\n    <Card className=\"shadow-lg border-0 bg-gradient-to-r from-background to-secondary/20\">\n      <CardHeader className=\"pb-4\">\n        <div className=\"flex items-center justify-between\">\n          <div className=\"flex items-center space-x-3\">\n            <Calendar className=\"w-6 h-6 text-primary\" />\n            <CardTitle className=\"text-2xl text-primary\">Vuorot</CardTitle>\n          </div>\n          <div className=\"flex items-center gap-2\">\n            <Badge variant=\"secondary\" className=\"px-3 py-1\">\n            <Users className=\"w-4 h-4 mr-2\" />\n            {filteredEmployees.length} työntekijää\n            </Badge>\n            {(filters.departments.length > 0 || stateFilterActive) && (\n              <Badge variant=\"outline\" className=\"px-3 py-1\">\n                <Filter className=\"w-3 h-3 mr-1\" />\n                Suodatettu\n              </Badge>\n              )}\n              </div>\n          </div>\n\n      </CardHeader>\n  {(filters.departments.length > 0 || stateFilterActive || (filters.searchTerm ?? \"\").trim()) && (\n    <div className=\"px-6 pb-2\">\n      <div className=\"text-sm text-muted-foreground bg-accent/40 px-3 py-2 rounded-md inline-flex items-center gap-3 flex-wrap\">\n        <Filter className=\"w-4 h-4\" />\n        <div className=\"flex flex-wrap gap-x-3 gap-y-1\">\n          {stateFilterActive && (\n            <span>{filters.showActive ? \"Vain aktiiviset työntekijät\" : \"Vain ei-aktiiviset työntekijät\"}</span>\n          )}\n          {filters.departments.length > 0 && (\n            <span>Osastot: {filters.departments.join(\", \")}</span>\n          )}\n          {(filters.searchTerm ?? \"\").trim() && (\n            <span>Haku: “{filters.searchTerm.trim()}”</span>\n            )}\n        </div>\n      </div>\n    </div>\n  )}\n\n\n      <CardContent className=\"p-0\">\n        <div className=\"overflow-x-auto\">\n          <div className=\"min-w-full\">\n            {/* Header */}\n            <div className=\"bg-muted/50 border-b\">\n              <div\n              className=\"grid gap-px\"\n              style={{ gridTemplateColumns: `minmax(200px,280px) repeat(${days}, minmax(96px, 1fr))` }}\n              >\n                <div className=\"p-4 bg-background\">\n                  <span className=\"text-sm font-medium text-muted-foreground\">Työntekijä</span>\n                </div>\n                {dates.map((date, index) => (\n                  <div key={index} className=\"p-3 bg-background text-center\">\n                    <div className=\"text-xs font-medium text-muted-foreground\">{date.day}</div>\n                    <div className=\"text-sm font-semibold mt-1\">{date.date}</div>\n                  </div>\n                ))}\n              </div>\n            </div>\n\n            {/* Employee Rows */}\n              <div className=\"divide-y divide-border\">\n              {filteredEmployees.length === 0 ? (\n                <div className=\"p-12 text-center text-muted-foreground\">\n                  <Filter className=\"w-12 h-12 mx-auto mb-4 opacity-50\" />\n                  <p>Ei työntekijöitä näytettäväksi nykyisillä suodattimilla</p>\n                  <p className=\"text-sm mt-1\">Muuta suodattimia nähdäksesi työntekijöitä</p>\n                </div>\n              ) : filteredEmployees.map((employee) => (\n\n                <div\n                  key={employee.id}\n                  className=\"grid gap-px hover:bg-accent/30 transition-colors\"\n                  style={{ gridTemplateColumns: `minmax(200px,280px) repeat(${days}, minmax(96px, 1fr))` }}\n                >\n                  <div className=\"p-4 bg-background flex items-center justify-between\">\n                    <div>\n                      <div className=\"flex items-center gap-2\">\n                        <span className=\"font-medium\">{employee.name}</span>\n                        {!employee.isActive && (\n                          <Badge variant=\"destructive\" className=\"text-xs\">Ei-aktiivinen</Badge>\n                        )}\n                      </div>\n                      <div className=\"text-xs text-muted-foreground\">{employee.department}</div>\n                    </div>\n                    <Badge variant=\"outline\" className=\"text-xs\">\n                      {getTotalHours(employee)}h\n                    </Badge>\n                  </div>\n\n{dates.map((_, dayIndex) => {\n  const shift = getShift(employee.id, dayIndex);\n  const shiftDisplay = getShiftDisplay(shift);\n  const isSelected =\n    selectedCell?.employee === employee.id && selectedCell?.day === dayIndex;\n\n  const key = `${employee.id}|${dates[dayIndex].iso}`;\n  const absence = absencesMap[key];\n\n  return (\n    <Popover\n  key={dayIndex}\n  open={openPopover === `${employee.id}-${dayIndex}`}\n  onOpenChange={(o) =>\n    setOpenPopover(o ? `${employee.id}-${dayIndex}` : null)\n  }\n>\n  <PopoverTrigger asChild>\n    <div\n      className={`\n        h-16 p-2 m-0 rounded-none border-0 group\n        flex items-center justify-center\n        ${isSelected ? \"ring-2 ring-ring ring-offset-2\" : \"\"}\n        transition-all duration-200 hover:scale-105 hover:shadow-md\n        ${\n          absence\n            ? absence.type === \"holiday\"\n              ? \"bg-blue-100 cursor-not-allowed\"\n              : \"bg-red-100 cursor-not-allowed\"\n            : shiftDisplay.color + \" cursor-pointer\"\n        }\n      `}\n    >\n      <div className=\"flex flex-col items-center space-y-1\">\n        {absence ? (\n          <>\n            <span\n              className={`text-xs font-medium ${\n                absence.type === \"holiday\" ? \"text-blue-600\" : \"text-red-600\"\n              }`}\n            >\n              {absence.type === \"holiday\" ? \"L\" : \"A\"}\n            </span>\n            <span className=\"text-[10px]\">\n              {absence.type === \"holiday\" ? \"Loma\" : \"Poissaolo\"}\n            </span>\n          </>\n        ) : (\n          <>\n            {shiftDisplay.icon}\n            {shiftDisplay.content && (\n              <span className=\"text-xs font-medium\">\n                {shiftDisplay.content}\n              </span>\n            )}\n          </>\n        )}\n      </div>\n    </div>\n  </PopoverTrigger>\n\n  {/* Näytä PopoverContent vain jos ei ole absence */}\n{!absence && (\n  <PopoverContent className=\"w-64 p-3 space-y-3\" side=\"bottom\" align=\"center\">\n    <div className=\"text-sm font-medium text-center\">\n      {employee.name} – {dates[dayIndex].day} {dates[dayIndex].date}\n    </div>\n\n    {/* Pikavalinnat */}\n    <div className=\"grid grid-cols-2 gap-2\">\n      {[4, 6, 7.5, 8].map((h) => (\n        <Button\n          key={h}\n          variant=\"outline\"\n          size=\"sm\"\n          onClick={() => {\n            handleCellClick(employee.id, dayIndex, h);\n            setOpenPopover(null);\n          }}\n          className=\"justify-center\"\n        >\n          {h}h\n        </Button>\n      ))}\n    </div>\n\n    {/* Muu-arvo + Tallenna */}\n    <div className=\"flex items-center gap-2\">\n      <Input\n        type=\"number\"\n        step=\"0.5\"\n        placeholder=\"esim. 5.5\"\n        className=\"h-8\"\n        onKeyDown={(e: React.KeyboardEvent<HTMLInputElement>) => {\n          if (e.key === \"Enter\") {\n            const val = parseFloat(e.currentTarget.value);\n            if (!isNaN(val)) {\n              handleCellClick(employee.id, dayIndex, val);\n              setOpenPopover(null);\n            }\n          }\n        }}\n      />\n      <Button\n        size=\"sm\"\n        onClick={(e) => {\n          const input = e.currentTarget.parentElement?.querySelector(\"input\") as HTMLInputElement | null;\n          const val = input ? parseFloat(input.value) : NaN;\n          if (!isNaN(val)) {\n            handleCellClick(employee.id, dayIndex, val);\n            setOpenPopover(null);\n          }\n        }}\n      >\n        ✓\n      </Button>\n    </div>\n\n    {/* Poista vuoro */}\n    <div className=\"flex justify-center\">\n      <Button\n        variant=\"ghost\"\n        size=\"sm\"\n        onClick={() => {\n          handleCellClick(employee.id, dayIndex, 0);\n          setOpenPopover(null);\n        }}\n        className=\"text-destructive\"\n      >\n        Poista (0h)\n      </Button>\n    </div>\n\n    <div className=\"text-xs text-muted-foreground text-center\">\n      Vinkki: 0h poistaa vuoron.\n    </div>\n  </PopoverContent>\n)}\n\n</Popover>\n\n  );\n})}\n\n                </div>\n              ))}\n            </div>\n\n            {/* Summary Row */}\n            <div className=\"bg-accent/50 border-t-2 border-primary/20\">\n              <div\n              className=\"grid gap-px\"\n              style={{ gridTemplateColumns: `minmax(200px,280px) repeat(${days}, minmax(96px, 1fr))` }}\n              >\n\n                <div className=\"p-4 bg-background\">\n                  <div className=\"flex items-center space-x-2\">\n                    <Users className=\"w-4 h-4 text-muted-foreground\" />\n                    <span className=\"font-medium text-sm\">\n                      Yhteensä ({filteredEmployees.length} työntekijää)\n                    </span>\n                  </div>\n                </div>\n                {dates.map((_, dayIndex) => {\n                  const dayTotal = filteredEmployees.reduce((total, emp) => {\n                    const s = getShift(emp.id, dayIndex);\n                    return total + (s?.hours || 0);\n                  }, 0);\n\n                  const filledCount = filteredEmployees.filter(\n                    (emp) => getShift(emp.id, dayIndex)?.type !== \"empty\"\n                  ).length;\n\n                  return (\n                    <div key={dayIndex} className=\"p-3 bg-background text-center\">\n                      <div className=\"text-sm font-semibold text-primary\">{dayTotal}h</div>\n                      <div className=\"text-xs text-muted-foreground\">{filledCount} henkilöä</div>\n                    </div>\n                  );\n                })}\n              </div>\n            </div>\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n\n    {/* Legend */}\n    <Card className=\"shadow-md\">\n      <CardContent className=\"p-4\">\n        <div className=\"flex flex-wrap gap-4 items-center justify-center\">\n          <div className=\"flex items-center space-x-2\">\n            <div className=\"w-4 h-4 bg-primary rounded-sm flex items-center justify-center\">\n              <Clock className=\"w-2.5 h-2.5 text-primary-foreground\" />\n            </div>\n            <span className=\"text-sm\">Normaali vuoro</span>\n          </div>\n          <div className=\"flex items-center space-x-2\">\n            <div className=\"w-4 h-4 bg-amber-500 rounded-sm flex items-center justify-center\">\n              <Lock className=\"w-2.5 h-2.5 text-white\" />\n            </div>\n            <span className=\"text-sm\">Lukittu vuoro</span>\n          </div>\n          <div className=\"flex items-center space-x-2\">\n            <div className=\"w-4 h-4 bg-destructive rounded-sm flex items-center justify-center\">\n              <AlertCircle className=\"w-2.5 h-2.5 text-destructive-foreground\" />\n            </div>\n            <span className=\"text-sm\">Poissaolo</span>\n          </div>\n          <div className=\"flex items-center space-x-2\">\n            <div className=\"w-4 h-4 bg-blue-500 rounded-sm flex items-center justify-center\">\n              <Plane className=\"w-2.5 h-2.5 text-white\" />\n            </div>\n            <span className=\"text-sm\">Loma</span>\n          </div>\n        </div>\n      </CardContent>\n    </Card>\n\n    {/* Footer Note */}\n    <div className=\"text-center text-xs text-muted-foreground bg-muted/30 p-3 rounded-lg\">\n      Vinkki: klikkaa solua → valitse tunnit. 0h poistaa vuoron.\n    </div>\n  </div>\n);\n}\n\nexport default ScheduleTable;\n",
        "byteOffset": 0,
        "totalChunks": 1,
        "hasMore": false,
        "startLine": 1,
        "endLine": 608
      }
    ]
  },
  {
    "path": "supabase/functions/app_settings/index.ts",
    "size": 6743,
    "sha256": "e0dab0d5a7592314bcb6dd9929c03215f9d02d67bbb3f6821a5ff4a10cde7c0a",
    "lang": "typescript",
    "lines": 191,
    "modifiedAt": "2025-09-02T01:28:28+03:00",
    "commitSha": "29d28ab09b16112f6f64a83fb43e1143e63a0ed0",
    "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/supabase/functions/app_settings/index.ts",
    "chunks": [
      {
        "i": 0,
        "text": "// supabase/functions/app_settings/index.ts\n// Täysin tuotantokelpoinen: CORS, auth-tarkistus, zod-validointi, GET/PUT\nimport { serve } from \"https://deno.land/std@0.224.0/http/server.ts\";\nimport { createClient } from \"https://esm.sh/@supabase/supabase-js@2.45.4\";\nimport { z } from \"https://deno.land/x/zod@v3.23.8/mod.ts\";\n\n// --- CORS + DEV bypass ---\nconst ALLOW_ORIGIN = (Deno.env.get(\"CORS_ORIGIN\") ?? \"*\").trim();\nconst DEV_ALLOW_NOAUTH =\n  (Deno.env.get(\"DEV_ALLOW_NOAUTH\") ?? \"false\").toLowerCase() === \"true\";\n\nfunction parseList(s: string) {\n  return s.split(\",\").map((x) => x.trim()).filter(Boolean);\n}\nconst ALLOWED_LIST = ALLOW_ORIGIN === \"*\" ? [] : parseList(ALLOW_ORIGIN);\n\nfunction pickOrigin(req: Request) {\n  const origin = req.headers.get(\"Origin\") ?? \"\";\n  if (ALLOW_ORIGIN === \"*\" || origin === \"\") return \"*\";\n  return ALLOWED_LIST.includes(origin) ? origin : \"null\";\n}\n\nfunction corsHeaders(origin: string) {\n  return {\n    \"Access-Control-Allow-Origin\": origin,\n    \"Access-Control-Allow-Methods\": \"GET,PUT,OPTIONS\",\n    \"Access-Control-Allow-Headers\":\n      \"authorization, content-type, x-client-info, apikey\",\n    Vary: \"Origin\",\n  };\n}\n\n// --- Admin-autentikointi (vain adminit saa kutsua) ---\n// Vähintään toinen näistä: (a) ADMIN_EMAILS env-listassa tai (b) userin profile.is_admin = true\nconst ADMIN_EMAILS = (Deno.env.get(\"ADMIN_EMAILS\") ?? \"\")\n  .split(\",\")\n  .map((s) => s.trim().toLowerCase())\n  .filter(Boolean);\n\n// Notification schema (synkassa settingsSchema.ts kanssa)\nconst NotifsSchema = z.object({\n  emailNotifications: z.boolean(),\n  adminNotificationEmails: z.array(z.string().email()).max(50),\n  absenceRequests: z.boolean(),\n  scheduleChanges: z.boolean(),\n  employeeUpdates: z.boolean(),\n  systemUpdates: z.boolean(),\n  dailyDigest: z.boolean(),\n  digestTime: z.string().regex(/^\\d{2}:\\d{2}$/),\n});\ntype Notifs = z.infer<typeof NotifsSchema>;\n\nasync function isAdmin(authClient: ReturnType<typeof createClient>) {\n  const {\n    data: { user },\n  } = await authClient.auth.getUser();\n  if (!user) return false;\n  const email = (user.email ?? \"\").toLowerCase();\n  if (ADMIN_EMAILS.includes(email)) return true;\n  const { data: prof } = await authClient\n    .from(\"profiles\")\n    .select(\"is_admin\")\n    .eq(\"id\", user.id)\n    .maybeSingle();\n  return !!prof?.is_admin;\n}\n\nserve(async (req) => {\n  // CORS\n  const origin = pickOrigin(req);\n  const base = corsHeaders(origin);\n  if (req.method === \"OPTIONS\") {\n    return new Response(null, { headers: base });\n  }\n\n   // 1) Admin-DB client (SERVICE ROLE) → käytä TÄTÄ kaikkiin DB-kirjoituksiin/lukuun\n  const supabaseAdmin = createClient(\n    Deno.env.get(\"SUPABASE_URL\")!,\n    Deno.env.get(\"SUPABASE_SERVICE_ROLE_KEY\")!\n  );\n\n  // 2) Auth client (ANON + request Authorization) → vain userin tarkistukseen\n  const supabaseAuth = createClient(\n    Deno.env.get(\"SUPABASE_URL\")!,\n    Deno.env.get(\"SUPABASE_ANON_KEY\")!,\n    { global: { headers: { Authorization: req.headers.get(\"Authorization\") ?? \"\" } } }\n  );\n\n  // DEV-bypass ennen admin-tarkistusta\n  const reqOrigin = req.headers.get(\"Origin\") ?? \"\";\n  const devBypassOk =\n    DEV_ALLOW_NOAUTH && (ALLOW_ORIGIN === \"*\" || ALLOWED_LIST.includes(reqOrigin));\n\n  if (!devBypassOk) {\n    const ok = await isAdmin(supabaseAuth);\n    if (!ok) {\n      return new Response(\n        JSON.stringify({ code: 401, message: \"Missing/invalid authorization\" }),\n        { status: 401, headers: { ...base, \"content-type\": \"application/json\" } }\n      );\n    }\n  }\n\n  try {\n    if (req.method === \"GET\") {\n      const { data, error } = await supabaseAdmin\n        .from(\"app_settings\")\n        .select(\n          \"email_notifications, admin_notification_emails, absence_requests, schedule_changes, employee_updates, system_updates, daily_digest, digest_time\"\n        )\n        .eq(\"id\", 1)\n        .maybeSingle();\n      if (error) throw error;\n\n      const notifs: Notifs = {\n        emailNotifications: data?.email_notifications ?? true,\n        adminNotificationEmails: data?.admin_notification_emails ?? [],\n        absenceRequests: data?.absence_requests ?? true,\n        scheduleChanges: data?.schedule_changes ?? true,\n        employeeUpdates: data?.employee_updates ?? false,\n        systemUpdates: data?.system_updates ?? false,\n        dailyDigest: data?.daily_digest ?? false,\n        digestTime: data?.digest_time ?? \"08:00\",\n      };\n      const parsed = NotifsSchema.safeParse(notifs);\n      const payload = parsed.success\n        ? parsed.data\n        : NotifsSchema.parse({\n            emailNotifications: true,\n            adminNotificationEmails: [],\n            absenceRequests: true,\n            scheduleChanges: true,\n            employeeUpdates: false,\n            systemUpdates: false,\n            dailyDigest: false,\n            digestTime: \"08:00\",\n          });\n      return new Response(\n        JSON.stringify({ notifications: payload }),\n        { headers: { ...base, \"content-type\": \"application/json\" } }\n      );\n    }\n\n    if (req.method === \"PUT\") {\n      const body = await req.json().catch(() => ({}));\n      const parsed = NotifsSchema.safeParse(body?.notifications);\n      if (!parsed.success) {\n        const msg = parsed.error.issues\n          .map((i) => `${i.path.join(\".\")}: ${i.message}`)\n          .join(\"; \");\n        return new Response(\n          JSON.stringify({ error: `Invalid notifications payload: ${msg}` }),\n          { status: 400, headers: { ...base, \"content-type\": \"application/json\" } }\n        );\n      }\n      const n = parsed.data;\n      const { error } = await supabaseAdmin\n        .from(\"app_settings\")\n        .upsert(\n          {\n            id: 1,\n            email_notifications: n.emailNotifications,\n            admin_notification_emails: n.adminNotificationEmails,\n            absence_requests: n.absenceRequests,\n            schedule_changes: n.scheduleChanges,\n            employee_updates: n.employeeUpdates,\n            system_updates: n.systemUpdates,\n            daily_digest: n.dailyDigest,\n            digest_time: n.digestTime,\n            updated_at: new Date().toISOString(),\n          },\n          { onConflict: \"id\" }\n        );\n      if (error) throw error;\n      return new Response(JSON.stringify({ ok: true }), {\n        headers: { ...base, \"content-type\": \"application/json\" },\n      });\n    }\n\n    return new Response(JSON.stringify({ error: \"Method Not Allowed\" }), {\n      status: 405,\n      headers: { ...base, \"content-type\": \"application/json\" },\n    });\n  } catch (e) {\n    console.error(\"[app_settings] error:\", e);\n    return new Response(\n      JSON.stringify({ error: e?.message ?? \"Unknown error\" }),\n      { status: 500, headers: { ...base, \"content-type\": \"application/json\" } }\n    );\n  }\n});",
        "byteOffset": 0,
        "totalChunks": 1,
        "hasMore": false,
        "startLine": 1,
        "endLine": 191
      }
    ]
  },
  {
    "path": "src/lib/sendEmail.ts",
    "size": 526,
    "sha256": "1e06ad3d35092436766a8a12ef51587579b571fceb6ec3bbdec2863c18fa9df9",
    "lang": "typescript",
    "lines": 20,
    "modifiedAt": "2025-09-02T01:28:28+03:00",
    "commitSha": "29d28ab09b16112f6f64a83fb43e1143e63a0ed0",
    "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/lib/sendEmail.ts",
    "chunks": [
      {
        "i": 0,
        "text": "export type SendEmailPayload = {\n  to: string | string[];\n  subject: string;\n  text?: string;\n  html?: string;\n  replyTo?: string;\n};\n\nexport async function sendEmail(payload: SendEmailPayload) {\n  const res = await fetch(\"/api/sendEmail\", {\n    method: \"POST\",\n    headers: { \"Content-Type\": \"application/json\" },\n    body: JSON.stringify(payload),\n  });\n  const data = await res.json().catch(() => ({}));\n  if (!res.ok) {\n    throw new Error(`Email send failed (${res.status}) ${JSON.stringify(data)}`);\n  }\n  return data;\n}",
        "byteOffset": 0,
        "totalChunks": 1,
        "hasMore": false,
        "startLine": 1,
        "endLine": 20
      }
    ]
  },
  {
    "path": "src/app/components/ui/NotificationsPopover.tsx",
    "size": 7845,
    "sha256": "0431e0d7cc17e25acc78a7e2a2761397e814c394e740353c8769ec239c5d3170",
    "lang": "tsx",
    "lines": 248,
    "modifiedAt": "2025-09-02T01:28:28+03:00",
    "commitSha": "29d28ab09b16112f6f64a83fb43e1143e63a0ed0",
    "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ui/NotificationsPopover.tsx",
    "chunks": [
      {
        "i": 0,
        "text": "\"use client\";\n\nimport React from \"react\";\nimport { Popover, PopoverContent, PopoverTrigger } from \"./popover\";\nimport { Button } from \"./button\";\nimport { Badge } from \"./badge\";\nimport { Separator } from \"./separator\";\nimport { Bell, Check, Calendar, UserPlus, Wand2, AlertCircle } from \"lucide-react\";\nimport { supabase } from \"@/lib/supaBaseClient\";\nimport { toast } from \"sonner\";\nimport { requestPermissionAndSubscribe } from \"@/lib/pushClient\";\nimport { logError, logInfo } from \"@/lib/logger\";\n\n// NotificationsPopover.tsx, importtien jälkeen\n\n\n// korvaa koko enablePush\nasync function enablePush() {\n  try {\n    await requestPermissionAndSubscribe();\n    toast.success(\"Push-ilmoitukset käytössä\");\n  } catch (e) {\n    logError(\"notifications enablePush FAILED\", e);\n    toast.error(\"Pushin käyttöönotto epäonnistui\");\n  }\n}\n\n\nasync function disablePush() {\n  try {\n    // Poistetaan kaikki tämän SW-rekisterin tilaukset\n    const reg = await navigator.serviceWorker.getRegistration();\n    if (reg) {\n      const sub = await reg.pushManager.getSubscription();\n      if (sub) {\n        await supabase.from(\"push_subscriptions\").delete().eq(\"endpoint\", sub.endpoint);\n        await sub.unsubscribe();\n      }\n    }\n    toast.success(\"Push-ilmoitukset poistettu käytöstä\");\n  } catch (e) {\n    logError(\"notifications disablePush FAILED\", e);\n    toast.error(\"Pushin poisto epäonnistui\");\n  }\n}\n\n\ntype NotiType =\n  | \"absence_request\"\n  | \"absence_approved\"\n  | \"absence_declined\"\n  | \"employee_added\"\n  | \"shift_auto\";\n\ntype Noti = {\n  id: string;\n  created_at: string;\n  type: NotiType;\n  title: string;\n  message: string;\n  is_read: boolean;\n};\n\nfunction iconFor(type: Noti[\"type\"]) {\n  switch (type) {\n    case \"absence_request\":\n      return <AlertCircle className=\"w-4 h-4 text-amber-600\" />;\n    case \"absence_approved\":\n      return <Check className=\"w-4 h-4 text-green-600\" />;\n    case \"absence_declined\":\n      return <AlertCircle className=\"w-4 h-4 text-red-600\" />;\n    case \"employee_added\":\n      return <UserPlus className=\"w-4 h-4 text-blue-600\" />;\n    case \"shift_auto\":\n      return <Wand2 className=\"w-4 h-4 text-indigo-600\" />;\n    default:\n      return <Bell className=\"w-4 h-4\" />;\n  }\n}\n\n\nfunction timeAgo(iso: string) {\n  const diff = Math.max(0, Date.now() - new Date(iso).getTime());\n  const m = Math.floor(diff / 60000);\n  if (m < 1) return \"juuri äsken\";\n  if (m < 60) return `${m} min sitten`;\n  const h = Math.floor(m / 60);\n  if (h < 24) return `${h} h sitten`;\n  const d = Math.floor(h / 24);\n  return `${d} pv sitten`;\n}\n\nexport default function NotificationsPopover() {\n  const [open, setOpen] = React.useState(false);\n  const [items, setItems] = React.useState<Noti[]>([]);\n  const unread = items.filter((n) => !n.is_read).length;\n\n\nconst [canWrite, setCanWrite] = React.useState(false);\n\n  React.useEffect(() => {\n    (async () => {\n     const { data: sessionRes } = await supabase.auth.getSession();\n     setCanWrite(!!sessionRes.session); // vain kirjautuneena saa merkitä luetuksi\n      const { data, error } = await supabase\n        .from(\"notifications\")\n        .select(\"*\")\n        .order(\"created_at\", { ascending: false })\n        .limit(50);\n      if (error) {\n        logError(\"notifications initial fetch FAILED\", error);\n      } else {\n        logInfo(\"notifications initial fetch OK\");\n        setItems((data ?? []) as Noti[]);\n      }\n    })();\n  }, []);\n\n    React.useEffect(() => {\n    if (!open) return;\n    (async () => {\n      const { data, error } = await supabase\n        .from(\"notifications\")\n        .select(\"*\")\n        .order(\"created_at\", { ascending: false })\n        .limit(50);\n      if (!error) setItems((data ?? []) as Noti[]);\n    })();\n  }, [open]);\n\n\nReact.useEffect(() => {\n  const ch = supabase\n    .channel(\"notifications-rt\")\n    .on(\n      \"postgres_changes\",\n      { event: \"*\", schema: \"public\", table: \"notifications\" },\n(payload) => {\n  const newRow = payload.new as Noti | null;\n  if (!newRow) return;\n\n  if (payload.eventType === \"INSERT\") {\n    setItems((prev) => [newRow, ...prev].slice(0, 50));\n  } else if (payload.eventType === \"UPDATE\") {\n    setItems((prev) =>\n      prev.map((n) => (n.id === newRow.id ? newRow : n))\n    );\n  }\n}\n\n    )\n    .subscribe();\n  return () => void supabase.removeChannel(ch);\n}, []);\n\n\n  async function markAllRead() {\n    if (!canWrite) { toast.error(\"Kirjaudu sisään merkataksesi ilmoituksia luetuiksi\"); return; }\n    const { error } = await supabase\n      .from(\"notifications\")\n      .update({ is_read: true })\n      .eq(\"is_read\", false);\n    if (error) {\n      logError(\"notifications markAllRead FAILED\", error);\n      toast.error(\"Merkintä epäonnistui\");\n      return;\n    }\n    setItems((prev) => prev.map((n) => ({ ...n, is_read: true })));\n  }\n\n // markRead – tee optimistic päivitys vain jos klikattu\nasync function markRead(id: string) {\n  if (!canWrite) { toast.error(\"Kirjaudu sisään merkataksesi ilmoituksia luetuiksi\"); return; }\n  setItems((prev) => prev.map((n) => (n.id === id ? { ...n, is_read: true } : n)));\n  const { error } = await supabase.from(\"notifications\").update({ is_read: true }).eq(\"id\", id);\n  if (error) {\n    logError(\"notifications markRead FAILED\", error);\n    toast.error(\"Merkintä epäonnistui\");\n  }\n}\n\n\n  return (\n    <Popover open={open} onOpenChange={setOpen}>\n      <PopoverTrigger asChild>\n        <Button variant=\"ghost\" size=\"sm\" className=\"relative\">\n          <Bell className=\"w-4 h-4\" />\n          {unread > 0 && (\n            <Badge variant=\"destructive\" className=\"absolute -top-1 -right-1 h-5 min-w-[20px] px-1 justify-center\">\n              {unread}\n            </Badge>\n          )}\n        </Button>\n      </PopoverTrigger>\n\n      <PopoverContent className=\"w-[420px] p-0\" align=\"end\">\n        <div className=\"p-3 flex items-center justify-between\">\n          <div className=\"font-medium\">Ilmoitukset</div>\n          <div className=\"text-xs text-muted-foreground\">{unread} lukematonta</div>\n        </div>\n        <Separator />\n        {items.length === 0 ? (\n          <div className=\"p-6 text-sm text-muted-foreground flex flex-col items-center gap-2\">\n            <Calendar className=\"w-5 h-5 opacity-60\" />\n            Ei ilmoituksia\n          </div>\n        ) : (\n          <div className=\"max-h-[360px] overflow-auto\">\n            {items.map((n) => (\n              <button\n                key={n.id}\n                onClick={() => markRead(n.id)}\n                className={`w-full text-left px-3 py-2 flex gap-2 hover:bg-accent transition ${\n                  n.is_read ? \"opacity-75\" : \"\"\n                }`}\n              >\n                <div className=\"mt-0.5\">{iconFor(n.type)}</div>\n                <div className=\"flex-1\">\n                  <div className=\"flex items-center gap-2\">\n                    <div className=\"font-medium text-sm\">{n.title}</div>\n                    {!n.is_read && <span className=\"w-1.5 h-1.5 rounded-full bg-foreground inline-block\" />}\n                  </div>\n                  <div className=\"text-xs text-muted-foreground\">{n.message}</div>\n                  <div className=\"text-[10px] text-muted-foreground mt-0.5\">{timeAgo(n.created_at)}</div>\n                </div>\n              </button>\n            ))}\n          </div>\n        )}\n<Separator />\n<div className=\"p-2 flex flex-wrap items-center justify-between gap-2\">\n  <Button variant=\"ghost\" size=\"sm\" className=\"shrink-0\" onClick={markAllRead}>\n    Merkitse kaikki luetuiksi\n  </Button>\n  <div className=\"flex flex-wrap gap-2\">\n    <Button variant=\"outline\" size=\"sm\" className=\"shrink-0\" onClick={enablePush}>\n      Ota push käyttöön\n    </Button>\n    <Button variant=\"ghost\" size=\"sm\" className=\"shrink-0\" onClick={disablePush}>\n      Poista push\n    </Button>\n  </div>\n</div>\n      </PopoverContent>\n    </Popover>\n  );\n}\n",
        "byteOffset": 0,
        "totalChunks": 1,
        "hasMore": false,
        "startLine": 1,
        "endLine": 248
      }
    ]
  },
  {
    "path": "src/app/components/AbsenceControlPanel.tsx",
    "size": 14007,
    "sha256": "3db75bfed5f5d1f54f7f5c120a65a8a86aa2f11c5bcec1649bd044ce89fb826e",
    "lang": "tsx",
    "lines": 360,
    "modifiedAt": "2025-09-02T01:28:28+03:00",
    "commitSha": "29d28ab09b16112f6f64a83fb43e1143e63a0ed0",
    "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/AbsenceControlPanel.tsx",
    "chunks": [
      {
        "i": 0,
        "text": "\"use client\";\n\nimport React, { useEffect, useState } from 'react';\nimport { Card, CardContent, CardHeader, CardTitle } from './ui/card';\nimport { Button } from './ui/button';\nimport { Badge } from './ui/badge';\nimport { Avatar, AvatarFallback } from './ui/avatar';\nimport { Textarea } from './ui/textarea';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from './ui/dialog';\nimport { \n  Clock, \n  CheckCircle, \n  XCircle, \n  Calendar,\n  MessageSquare,\n  User,\n  AlertTriangle\n} from 'lucide-react';\nimport { AbsenceRequest } from '../types';\nimport { toast } from 'sonner';\nimport { supabase } from '@/lib/supaBaseClient';\nimport { notifyAbsenceDecision } from '@/features/absences/notify';\nimport { useSettingsStore } from \"@/store/useSettingsStore\";\n\nconst AbsenceControlPanel = () => {\n  const [requests, setRequests] = useState<AbsenceRequest[]>([]);\n  const [adminResponse, setAdminResponse] = useState('');\n\n  const emailEnabled =\n  useSettingsStore((s) => s.settings?.notifications?.emailNotifications ?? true);\n\n  // --- FETCH FROM SUPABASE ---\n  useEffect(() => {\n    const fetchAbsences = async () => {\nconst { data, error } = await supabase\n  .from('absences')\n  .select(`\n    id,\n    employee_id,\n    start_date,\n    end_date,\n    reason,\n    message,\n    status,\n    submitted_at,\n    employees:employees!absences_employee_id_fkey ( name )\n  `)\n  .order('submitted_at', { ascending: false });\n\nif (error) {\n  console.error(error);\n  toast.error('Poissaolojen haku epäonnistui');\n  return;\n}\n\ntype AbsenceRow = {\n  id: string;\n  employee_id: string;\n  start_date: string;\n  end_date: string | null;\n  reason: string | null;\n  message: string | null;\n  status: 'pending' | 'approved' | 'declined';\n  submitted_at: string;\n  employees?: { name: string }[] | { name: string } | null;\n};\n\nconst mapped: AbsenceRequest[] = (data as AbsenceRow[]).map((r) => {\n  const employeeName = Array.isArray(r.employees)\n    ? r.employees[0]?.name\n    : r.employees?.name;\n\n  return {\n    id: r.id,\n    employeeId: r.employee_id,\n    employeeName: employeeName ?? 'Tuntematon',\n    startDate: r.start_date,\n    endDate: r.end_date ?? '',\n    reason: r.reason ?? '',\n    status: r.status,\n    submittedAt: r.submitted_at,\n    message: r.message ?? '',\n  };\n});\n\n\n      setRequests(mapped);\n      \n    };\n\n    fetchAbsences();\n  }, []);\n\n  // --- STATUS HELPERS (UI) ---\n  const getStatusBadge = (status: AbsenceRequest['status']) => {\n    switch (status) {\n      case 'pending':\n        return <Badge variant=\"outline\" className=\"bg-amber-50 text-amber-700 border-amber-300\"><Clock className=\"w-3 h-3 mr-1\" />Odottaa</Badge>;\n      case 'approved':\n        return <Badge variant=\"outline\" className=\"bg-green-50 text-green-700 border-green-300\"><CheckCircle className=\"w-3 h-3 mr-1\" />Hyväksytty</Badge>;\n      case 'declined':\n        return <Badge variant=\"outline\" className=\"bg-red-50 text-red-700 border-red-300\"><XCircle className=\"w-3 h-3 mr-1\" />Hylätty</Badge>;\n    }\n  };\n\n  // --- SUPABASE UPDATES ---\nconst handleApprove = async (requestId: string) => {\n  // Optimistinen päivitys\n  setRequests(prev => prev.map(r => r.id === requestId ? { ...r, status: 'approved' } : r));\n\n  const target = requests.find(r => r.id === requestId);\n  const { error } = await supabase.from('absences').update({ status: 'approved' }).eq('id', requestId);\n  if (error) {\n    console.error('[ABSENCE APPROVE ERROR]', error.code, error.message, error.details);\n    // revert\n    setRequests(prev => prev.map(r => r.id === requestId ? { ...r, status: 'pending' } : r));\n    toast.error('Hyväksyntä epäonnistui');\n    return;\n  }\n  // Lähetä sähköposti + loki notify.ts:n kautta (ei kaadeta hyväksyntää, jos maili epäonnistuu)\n  if (emailEnabled && target) {\n    try {\n      await notifyAbsenceDecision({\n        employeeId: target.employeeId,\n        status: \"approved\",\n        startDate: target.startDate,\n        endDate: target.endDate || null,\n        adminMessage: adminResponse?.trim() || undefined,\n      });\n    } catch (e) {\n      console.error(\"[EMAIL APPROVE ERROR]\", e);\n      toast.error(\"Sähköpostin lähetys epäonnistui (hyväksyntä tallessa).\");\n    }\n  }\n  toast.success('Poissaolopyyntö hyväksytty');\n};\n\n\nconst handleDecline = async (requestId: string) => {\n  setRequests(prev => prev.map(r => r.id === requestId ? { ...r, status: 'declined' } : r));\n\n  const target = requests.find(r => r.id === requestId);\n  const { error } = await supabase.from('absences').update({ status: 'declined' }).eq('id', requestId);\n  if (error) {\n    console.error('[ABSENCE DECLINE ERROR]', error.code, error.message, error.details);\n    setRequests(prev => prev.map(r => r.id === requestId ? { ...r, status: 'pending' } : r));\n    toast.error('Hylkäys epäonnistui');\n    return;\n  }\n\n  if (emailEnabled && target) {\n    try {\n      await notifyAbsenceDecision({\n        employeeId: target.employeeId,\n        status: \"declined\",\n        startDate: target.startDate,\n        endDate: target.endDate || null,\n        adminMessage: adminResponse?.trim() || undefined,\n      });\n    } catch (e) {\n      console.error(\"[EMAIL DECLINE ERROR]\", e);\n      toast.error(\"Sähköpostin lähetys epäonnistui (hylkäys tallessa).\");\n    }\n  }\n  toast.success('Poissaolopyyntö hylätty');\n};\n\n\n  // --- DERIVED LISTS (UI pysyy samana) ---\n  const pendingRequests = requests.filter(req => req.status === 'pending');\n  const processedRequests = requests.filter(req => req.status !== 'pending');\n\n  const formatDate = (dateString: string) => {\n    if (!dateString) return '';\n    return new Date(dateString).toLocaleDateString('fi-FI', {\n      day: 'numeric',\n      month: 'numeric',\n      year: 'numeric'\n    });\n  };\n\n  const formatDateTime = (dateString: string) => {\n    if (!dateString) return '';\n    return new Date(dateString).toLocaleDateString('fi-FI', {\n      day: 'numeric',\n      month: 'numeric',\n      hour: '2-digit',\n      minute: '2-digit'\n    });\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Pending Requests */}\n      <Card className=\"shadow-lg border-0 bg-gradient-to-r from-background to-secondary/20\">\n        <CardHeader className=\"pb-4\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center space-x-3\">\n              <AlertTriangle className=\"w-6 h-6 text-amber-500\" />\n              <CardTitle className=\"text-xl text-primary\">Odottavat poissaolopyynnöt</CardTitle>\n            </div>\n            <Badge variant=\"secondary\" className=\"px-3 py-1\">\n              {pendingRequests.length} pyyntöä\n            </Badge>\n          </div>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          {pendingRequests.length === 0 ? (\n            <div className=\"text-center py-8 text-muted-foreground\">\n              <Calendar className=\"w-12 h-12 mx-auto mb-4 opacity-50\" />\n              <p>Ei odottavia poissaolopyyntöjä</p>\n            </div>\n          ) : (\n            pendingRequests.map((request) => (\n              <div key={request.id} className=\"border border-border rounded-lg p-4 bg-background hover:shadow-md transition-shadow\">\n                <div className=\"flex items-start justify-between\">\n                  <div className=\"flex items-start space-x-3 flex-1\">\n                    <Avatar className=\"w-10 h-10\">\n                      <AvatarFallback className=\"bg-primary text-primary-foreground\">\n                        {request.employeeName?.split(' ').map(n => n[0]).join('')}\n                      </AvatarFallback>\n                    </Avatar>\n                    <div className=\"flex-1\">\n                      <div className=\"flex items-center gap-2 mb-2\">\n                        <h4 className=\"font-medium\">{request.employeeName}</h4>\n                        {getStatusBadge(request.status)}\n                      </div>\n                      <div className=\"space-y-1 text-sm text-muted-foreground\">\n                        <div className=\"flex items-center gap-2\">\n                          <Calendar className=\"w-4 h-4\" />\n                          <span>\n                            {formatDate(request.startDate)} \n                            {request.startDate !== request.endDate && ` - ${formatDate(request.endDate)}`}\n                          </span>\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                          <User className=\"w-4 h-4\" />\n                          <span>Syy: {request.reason}</span>\n                        </div>\n                        <div className=\"flex items-center gap-2\">\n                          <Clock className=\"w-4 h-4\" />\n                          <span>Jätetty: {formatDateTime(request.submittedAt || '')}</span>\n                        </div>\n                      </div>\n                      {request.message && (\n                        <div className=\"mt-3 p-3 bg-muted/50 rounded-md\">\n                          <div className=\"flex items-start gap-2\">\n                            <MessageSquare className=\"w-4 h-4 mt-0.5 text-muted-foreground\" />\n                            <p className=\"text-sm\">{request.message}</p>\n                          </div>\n                        </div>\n                      )}\n                    </div>\n                  </div>\n                  <div className=\"flex items-center gap-2 ml-4\">\n                    <Dialog>\n                      <DialogTrigger asChild>\n                        <div\n                          className=\"inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-input bg-background hover:bg-accent hover:text-accent-foreground h-9 px-3 cursor-pointer\"\n                        >\n                          <MessageSquare className=\"w-4 h-4 mr-2\" />\n                          Vastaa\n                        </div>\n                      </DialogTrigger>\n                      <DialogContent>\n                        <DialogHeader>\n                          <DialogTitle>Vastaa poissaolopyyntöön</DialogTitle>\n                        </DialogHeader>\n                        <div className=\"space-y-4\">\n                          <div className=\"space-y-2\">\n                            <label className=\"text-sm font-medium\">Viesti työntekijälle:</label>\n                            <Textarea \n                              value={adminResponse}\n                              onChange={(e) => setAdminResponse(e.target.value)}\n                              placeholder=\"Kirjoita viesti...\"\n                              className=\"min-h-[100px]\"\n                            />\n                          </div>\n                          <div className=\"flex gap-2\">\n                            <Button \n                              onClick={() => {\n                                handleApprove(request.id);\n                                setAdminResponse('');\n                              }}\n                              className=\"flex-1\"\n                            >\n                              <CheckCircle className=\"w-4 h-4 mr-2\" />\n                              Hyväksy\n                            </Button>\n                            <Button \n                              variant=\"destructive\"\n                              onClick={() => {\n                                handleDecline(request.id);\n                                setAdminResponse('');\n                              }}\n                              className=\"flex-1\"\n                            >\n                              <XCircle className=\"w-4 h-4 mr-2\" />\n                              Hylkää\n                            </Button>\n                          </div>\n                        </div>\n                      </DialogContent>\n                    </Dialog>\n                    <Button \n                      size=\"sm\"\n                      onClick={() => handleApprove(request.id)}\n                      className=\"bg-green-600 hover:bg-green-700\"\n                    >\n                      <CheckCircle className=\"w-4 h-4\" />\n                    </Button>\n                    <Button \n                      variant=\"destructive\"\n                      size=\"sm\"\n                      onClick={() => handleDecline(request.id)}\n                    >\n                      <XCircle className=\"w-4 h-4\" />\n                    </Button>\n                  </div>\n                </div>\n              </div>\n            ))\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Processed Requests */}\n      <Card className=\"shadow-md\">\n        <CardHeader className=\"pb-4\">\n          <CardTitle className=\"text-lg\">Käsitellyt pyynnöt</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-3\">\n            {processedRequests.map((request) => (\n              <div key={request.id} className=\"flex items-center justify-between p-3 border border-border rounded-md bg-muted/30\">\n                <div className=\"flex items-center space-x-3\">\n                  <Avatar className=\"w-8 h-8\">\n                    <AvatarFallback className=\"text-xs\">\n                      {request.employeeName?.split(' ').map(n => n[0]).join('')}\n                    </AvatarFallback>\n                  </Avatar>\n                  <div>\n                    <p className=\"font-medium text-sm\">{request.employeeName}</p>\n                    <p className=\"text-xs text-muted-foreground\">\n                      {formatDate(request.startDate)} - {request.reason}\n                    </p>\n                  </div>\n                </div>\n                {getStatusBadge(request.status)}\n              </div>\n            ))}\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n\nexport default AbsenceControlPanel;\n",
        "byteOffset": 0,
        "totalChunks": 1,
        "hasMore": false,
        "startLine": 1,
        "endLine": 360
      }
    ]
  },
  {
    "path": "src/app/components/ui/utils.ts",
    "size": 169,
    "sha256": "d1f1e0d62cb8d8d1e04c26e14de842d8a151f75812d81b046c65b5d1fe8e4b27",
    "lang": "typescript",
    "lines": 7,
    "modifiedAt": "2025-09-02T01:28:28+03:00",
    "commitSha": "29d28ab09b16112f6f64a83fb43e1143e63a0ed0",
    "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ui/utils.ts",
    "chunks": [
      {
        "i": 0,
        "text": "import { clsx, type ClassValue } from \"clsx\";\nimport { twMerge } from \"tailwind-merge\";\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs));\n}\n",
        "byteOffset": 0,
        "totalChunks": 1,
        "hasMore": false,
        "startLine": 1,
        "endLine": 7
      }
    ]
  },
  {
    "path": "src/lib/supaBaseClient.ts",
    "size": 213,
    "sha256": "50e3390541d690ecab3af0d93049f7cf7590cf322f77ff1a03901a9f826e68fd",
    "lang": "typescript",
    "lines": 7,
    "modifiedAt": "2025-09-02T01:28:28+03:00",
    "commitSha": "29d28ab09b16112f6f64a83fb43e1143e63a0ed0",
    "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/lib/supaBaseClient.ts",
    "chunks": [
      {
        "i": 0,
        "text": "import { createClient } from \"@supabase/supabase-js\";\n\nconst url = process.env.NEXT_PUBLIC_SUPABASE_URL!;\nconst anon = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;\n\nexport const supabase = createClient(url, anon);\n",
        "byteOffset": 0,
        "totalChunks": 1,
        "hasMore": false,
        "startLine": 1,
        "endLine": 7
      }
    ]
  },
  {
    "path": "src/app/components/ui/sonner.tsx",
    "size": 571,
    "sha256": "c5853f16cc11cb69e0115bab13eeabe7be5dad16fafd77b35cdfe4dbc64f0256",
    "lang": "tsx",
    "lines": 26,
    "modifiedAt": "2025-09-02T01:28:28+03:00",
    "commitSha": "29d28ab09b16112f6f64a83fb43e1143e63a0ed0",
    "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ui/sonner.tsx",
    "chunks": [
      {
        "i": 0,
        "text": "\"use client\";\n\nimport { useTheme } from \"next-themes\";\nimport { Toaster as Sonner, ToasterProps } from \"sonner\";\n\nconst Toaster = ({ ...props }: ToasterProps) => {\n  const { theme = \"system\" } = useTheme();\n\n  return (\n    <Sonner\n      theme={theme as ToasterProps[\"theme\"]}\n      className=\"toaster group\"\n      style={\n        {\n          \"--normal-bg\": \"var(--popover)\",\n          \"--normal-text\": \"var(--popover-foreground)\",\n          \"--normal-border\": \"var(--border)\",\n        } as React.CSSProperties\n      }\n      {...props}\n    />\n  );\n};\n\nexport { Toaster };\n",
        "byteOffset": 0,
        "totalChunks": 1,
        "hasMore": false,
        "startLine": 1,
        "endLine": 26
      }
    ]
  },
  {
    "path": "src/app/components/ui/label.tsx",
    "size": 614,
    "sha256": "5ed157f039340cedaa59a888931db608667827170ae9538513a50ccf2ca65a9f",
    "lang": "tsx",
    "lines": 25,
    "modifiedAt": "2025-09-02T01:28:28+03:00",
    "commitSha": "29d28ab09b16112f6f64a83fb43e1143e63a0ed0",
    "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ui/label.tsx",
    "chunks": [
      {
        "i": 0,
        "text": "\"use client\";\n\nimport * as React from \"react\";\nimport * as LabelPrimitive from \"@radix-ui/react-label\";\n\nimport { cn } from \"./utils\";\n\nfunction Label({\n  className,\n  ...props\n}: React.ComponentProps<typeof LabelPrimitive.Root>) {\n  return (\n    <LabelPrimitive.Root\n      data-slot=\"label\"\n      className={cn(\n        \"flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50\",\n        className,\n      )}\n      {...props}\n    />\n  );\n}\n\nexport { Label };\n",
        "byteOffset": 0,
        "totalChunks": 1,
        "hasMore": false,
        "startLine": 1,
        "endLine": 25
      }
    ]
  },
  {
    "path": "src/lib/theme.ts",
    "size": 703,
    "sha256": "353d0508a52528960c4a3f52d96e6595b0cf166c0952c2e5cde2a61ef41604b4",
    "lang": "typescript",
    "lines": 21,
    "modifiedAt": "2025-09-02T01:28:28+03:00",
    "commitSha": "29d28ab09b16112f6f64a83fb43e1143e63a0ed0",
    "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/lib/theme.ts",
    "chunks": [
      {
        "i": 0,
        "text": "// src/lib/theme.ts\nexport type ThemeMode = \"light\" | \"dark\" | \"system\";\n\n/**\n * Asettaa dokumentin teeman: light/dark tai järjestelmän mukaan.\n * Ei heitä virheitä – toimii myös SSR:ssa guardien ansiosta.\n */\nexport function applyTheme(mode: ThemeMode) {\n  if (typeof window === \"undefined\" || typeof document === \"undefined\") return;\n  try {\n    localStorage.setItem(\"soili-theme\", mode);\n  } catch {\n    // ignore storage errors\n  }\n  const prefersDark = window.matchMedia?.(\"(prefers-color-scheme: dark)\")?.matches ?? false;\n  const eff = mode === \"system\" ? (prefersDark ? \"dark\" : \"light\") : mode;\n  const c = document.documentElement.classList;\n  c.remove(\"light\",\"dark\");\n  c.add(eff);\n}\n",
        "byteOffset": 0,
        "totalChunks": 1,
        "hasMore": false,
        "startLine": 1,
        "endLine": 21
      }
    ]
  },
  {
    "path": "src/app/components/ui/separator.tsx",
    "size": 707,
    "sha256": "54cc34fc3ef7e445948c5bccf7307efbb2c8f9e63db0fc68dd3fa8ee54dc9812",
    "lang": "tsx",
    "lines": 29,
    "modifiedAt": "2025-09-02T01:28:28+03:00",
    "commitSha": "29d28ab09b16112f6f64a83fb43e1143e63a0ed0",
    "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ui/separator.tsx",
    "chunks": [
      {
        "i": 0,
        "text": "\"use client\";\n\nimport * as React from \"react\";\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\";\n\nimport { cn } from \"./utils\";\n\nfunction Separator({\n  className,\n  orientation = \"horizontal\",\n  decorative = true,\n  ...props\n}: React.ComponentProps<typeof SeparatorPrimitive.Root>) {\n  return (\n    <SeparatorPrimitive.Root\n      data-slot=\"separator-root\"\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-px\",\n        className,\n      )}\n      {...props}\n    />\n  );\n}\n\nexport { Separator };\n",
        "byteOffset": 0,
        "totalChunks": 1,
        "hasMore": false,
        "startLine": 1,
        "endLine": 29
      }
    ]
  },
  {
    "path": "src/app/components/ui/textarea.tsx",
    "size": 767,
    "sha256": "6c3127c28ba1dda0428ba286a9e291c52ad95bfc8acd10518b262b71e470f3e7",
    "lang": "tsx",
    "lines": 19,
    "modifiedAt": "2025-09-02T01:28:28+03:00",
    "commitSha": "29d28ab09b16112f6f64a83fb43e1143e63a0ed0",
    "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ui/textarea.tsx",
    "chunks": [
      {
        "i": 0,
        "text": "import * as React from \"react\";\n\nimport { cn } from \"./utils\";\n\nfunction Textarea({ className, ...props }: React.ComponentProps<\"textarea\">) {\n  return (\n    <textarea\n      data-slot=\"textarea\"\n      className={cn(\n        \"resize-none border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 flex field-sizing-content min-h-16 w-full rounded-md border bg-input-background px-3 py-2 text-base transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className,\n      )}\n      {...props}\n    />\n  );\n}\n\nexport { Textarea };\n",
        "byteOffset": 0,
        "totalChunks": 1,
        "hasMore": false,
        "startLine": 1,
        "endLine": 19
      }
    ]
  },
  {
    "path": "src/app/components/ui/input.tsx",
    "size": 963,
    "sha256": "cb82ffcd1a9accdf9b07edc8e976f43ad1c9cf91968ffd7639df5df14b7ad407",
    "lang": "tsx",
    "lines": 22,
    "modifiedAt": "2025-09-02T01:28:28+03:00",
    "commitSha": "29d28ab09b16112f6f64a83fb43e1143e63a0ed0",
    "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ui/input.tsx",
    "chunks": [
      {
        "i": 0,
        "text": "import * as React from \"react\";\n\nimport { cn } from \"./utils\";\n\nfunction Input({ className, type, ...props }: React.ComponentProps<\"input\">) {\n  return (\n    <input\n      type={type}\n      data-slot=\"input\"\n      className={cn(\n        \"file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input flex h-9 w-full min-w-0 rounded-md border px-3 py-1 text-base bg-input-background transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        \"focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]\",\n        \"aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive\",\n        className,\n      )}\n      {...props}\n    />\n  );\n}\n\nexport { Input };\n",
        "byteOffset": 0,
        "totalChunks": 1,
        "hasMore": false,
        "startLine": 1,
        "endLine": 22
      }
    ]
  },
  {
    "path": "src/lib/dateUtils.ts",
    "size": 984,
    "sha256": "ac4a55bccc8a3540a4052f3d652aff2dee2421aff36bd6f223f1d94c49370067",
    "lang": "typescript",
    "lines": 30,
    "modifiedAt": "2025-09-02T01:28:28+03:00",
    "commitSha": "29d28ab09b16112f6f64a83fb43e1143e63a0ed0",
    "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/lib/dateUtils.ts",
    "chunks": [
      {
        "i": 0,
        "text": "// dateutils.ts\nexport type WeekStartDay = \"monday\" | \"sunday\";\n\n// Paikallinen keskiyö -> YYYY-MM-DD ilman UTC-heittelyä\nexport function toLocalISO(date: Date) {\n  const d = new Date(date);\n  d.setHours(0, 0, 0, 0);\n  const yyyy = d.getFullYear();\n  const mm = String(d.getMonth() + 1).padStart(2, \"0\");\n  const dd = String(d.getDate()).padStart(2, \"0\");\n  return `${yyyy}-${mm}-${dd}`;\n}\n\nexport function addDaysLocalISO(iso: string, add: number) {\n  const [y, m, da] = iso.split(\"-\").map(Number);\n  const d = new Date(y, m - 1, da); // paikallinen\n  d.setDate(d.getDate() + add);\n  return toLocalISO(d);\n}\n\nexport function alignToWeekStart(iso: string, weekStart: WeekStartDay) {\n  const [y, m, da] = iso.split(\"-\").map(Number);\n  const d = new Date(y, m - 1, da); // paikallinen\n  const day = d.getDay(); // 0 = su, 1 = ma\n  const startIndex = weekStart === \"monday\" ? 1 : 0;\n  const diff = (day - startIndex + 7) % 7;\n  d.setDate(d.getDate() - diff);\n  return toLocalISO(d);\n}\n",
        "byteOffset": 0,
        "totalChunks": 1,
        "hasMore": false,
        "startLine": 1,
        "endLine": 30
      }
    ]
  },
  {
    "path": "src/app/components/ui/avatar.tsx",
    "size": 1104,
    "sha256": "d40b1cbabe71c094c6bcf089ac5702ec77623dbc75c770ca9f86530e03d6fea1",
    "lang": "tsx",
    "lines": 54,
    "modifiedAt": "2025-09-02T01:28:28+03:00",
    "commitSha": "29d28ab09b16112f6f64a83fb43e1143e63a0ed0",
    "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ui/avatar.tsx",
    "chunks": [
      {
        "i": 0,
        "text": "\"use client\";\n\nimport * as React from \"react\";\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\";\n\nimport { cn } from \"./utils\";\n\nfunction Avatar({\n  className,\n  ...props\n}: React.ComponentProps<typeof AvatarPrimitive.Root>) {\n  return (\n    <AvatarPrimitive.Root\n      data-slot=\"avatar\"\n      className={cn(\n        \"relative flex size-10 shrink-0 overflow-hidden rounded-full\",\n        className,\n      )}\n      {...props}\n    />\n  );\n}\n\nfunction AvatarImage({\n  className,\n  ...props\n}: React.ComponentProps<typeof AvatarPrimitive.Image>) {\n  return (\n    <AvatarPrimitive.Image\n      data-slot=\"avatar-image\"\n      className={cn(\"aspect-square size-full\", className)}\n      {...props}\n    />\n  );\n}\n\nfunction AvatarFallback({\n  className,\n  ...props\n}: React.ComponentProps<typeof AvatarPrimitive.Fallback>) {\n  return (\n    <AvatarPrimitive.Fallback\n      data-slot=\"avatar-fallback\"\n      className={cn(\n        \"bg-muted flex size-full items-center justify-center rounded-full\",\n        className,\n      )}\n      {...props}\n    />\n  );\n}\n\nexport { Avatar, AvatarImage, AvatarFallback };\n",
        "byteOffset": 0,
        "totalChunks": 1,
        "hasMore": false,
        "startLine": 1,
        "endLine": 54
      }
    ]
  },
  {
    "path": "src/app/components/ui/switch.tsx",
    "size": 1182,
    "sha256": "d4c744131c6161300510909aafe2c2cb6d819f2c7a8c2aeb75d4317004c7eff7",
    "lang": "tsx",
    "lines": 32,
    "modifiedAt": "2025-09-02T01:28:28+03:00",
    "commitSha": "29d28ab09b16112f6f64a83fb43e1143e63a0ed0",
    "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ui/switch.tsx",
    "chunks": [
      {
        "i": 0,
        "text": "\"use client\";\n\nimport * as React from \"react\";\nimport * as SwitchPrimitive from \"@radix-ui/react-switch\";\n\nimport { cn } from \"./utils\";\n\nfunction Switch({\n  className,\n  ...props\n}: React.ComponentProps<typeof SwitchPrimitive.Root>) {\n  return (\n    <SwitchPrimitive.Root\n      data-slot=\"switch\"\n      className={cn(\n        \"peer data-[state=checked]:bg-primary data-[state=unchecked]:bg-switch-background focus-visible:border-ring focus-visible:ring-ring/50 dark:data-[state=unchecked]:bg-input/80 inline-flex h-[1.15rem] w-8 shrink-0 items-center rounded-full border border-transparent transition-all outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50\",\n        className,\n      )}\n      {...props}\n    >\n      <SwitchPrimitive.Thumb\n        data-slot=\"switch-thumb\"\n        className={cn(\n          \"bg-card dark:data-[state=unchecked]:bg-card-foreground dark:data-[state=checked]:bg-primary-foreground pointer-events-none block size-4 rounded-full ring-0 transition-transform data-[state=checked]:translate-x-[calc(100%-2px)] data-[state=unchecked]:translate-x-0\",\n        )}\n      />\n    </SwitchPrimitive.Root>\n  );\n}\n\nexport { Switch };\n",
        "byteOffset": 0,
        "totalChunks": 1,
        "hasMore": false,
        "startLine": 1,
        "endLine": 32
      }
    ]
  },
  {
    "path": "src/app/components/ui/checkbox.tsx",
    "size": 1244,
    "sha256": "894eb30992723a15e3ae75c46a3bf8808a526f5b3bff2c61c78f4d3e8d521cb8",
    "lang": "tsx",
    "lines": 33,
    "modifiedAt": "2025-09-02T01:28:28+03:00",
    "commitSha": "29d28ab09b16112f6f64a83fb43e1143e63a0ed0",
    "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ui/checkbox.tsx",
    "chunks": [
      {
        "i": 0,
        "text": "\"use client\";\n\nimport * as React from \"react\";\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\";\nimport { CheckIcon } from \"lucide-react\";\n\nimport { cn } from \"./utils\";\n\nfunction Checkbox({\n  className,\n  ...props\n}: React.ComponentProps<typeof CheckboxPrimitive.Root>) {\n  return (\n    <CheckboxPrimitive.Root\n      data-slot=\"checkbox\"\n      className={cn(\n        \"peer border bg-input-background dark:bg-input/30 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground dark:data-[state=checked]:bg-primary data-[state=checked]:border-primary focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive size-4 shrink-0 rounded-[4px] border shadow-xs transition-shadow outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50\",\n        className,\n      )}\n      {...props}\n    >\n      <CheckboxPrimitive.Indicator\n        data-slot=\"checkbox-indicator\"\n        className=\"flex items-center justify-center text-current transition-none\"\n      >\n        <CheckIcon className=\"size-3.5\" />\n      </CheckboxPrimitive.Indicator>\n    </CheckboxPrimitive.Root>\n  );\n}\n\nexport { Checkbox };\n",
        "byteOffset": 0,
        "totalChunks": 1,
        "hasMore": false,
        "startLine": 1,
        "endLine": 33
      }
    ]
  },
  {
    "path": "src/app/components/ui/badge.tsx",
    "size": 1636,
    "sha256": "8329a0b50f818665f1aca05ab93c16b103178b463f2949234ee4416bbc7d3fe2",
    "lang": "tsx",
    "lines": 47,
    "modifiedAt": "2025-09-02T01:28:28+03:00",
    "commitSha": "29d28ab09b16112f6f64a83fb43e1143e63a0ed0",
    "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ui/badge.tsx",
    "chunks": [
      {
        "i": 0,
        "text": "import * as React from \"react\";\nimport { Slot } from \"@radix-ui/react-slot\";\nimport { cva, type VariantProps } from \"class-variance-authority\";\n\nimport { cn } from \"./utils\";\n\nconst badgeVariants = cva(\n  \"inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90\",\n        secondary:\n          \"border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90\",\n        destructive:\n          \"border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60\",\n        outline:\n          \"text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  },\n);\n\nfunction Badge({\n  className,\n  variant,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"span\"> &\n  VariantProps<typeof badgeVariants> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"span\";\n\n  return (\n    <Comp\n      data-slot=\"badge\"\n      className={cn(badgeVariants({ variant }), className)}\n      {...props}\n    />\n  );\n}\n\nexport { Badge, badgeVariants };\n",
        "byteOffset": 0,
        "totalChunks": 1,
        "hasMore": false,
        "startLine": 1,
        "endLine": 47
      }
    ]
  },
  {
    "path": "src/app/components/ui/popover.tsx",
    "size": 1641,
    "sha256": "f14e16bebcfb1b605f6336d52153e43b76456c419930faea216d0ce2e3b1d3b7",
    "lang": "tsx",
    "lines": 49,
    "modifiedAt": "2025-09-02T01:28:28+03:00",
    "commitSha": "29d28ab09b16112f6f64a83fb43e1143e63a0ed0",
    "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ui/popover.tsx",
    "chunks": [
      {
        "i": 0,
        "text": "\"use client\";\n\nimport * as React from \"react\";\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\";\n\nimport { cn } from \"./utils\";\n\nfunction Popover({\n  ...props\n}: React.ComponentProps<typeof PopoverPrimitive.Root>) {\n  return <PopoverPrimitive.Root data-slot=\"popover\" {...props} />;\n}\n\nfunction PopoverTrigger({\n  ...props\n}: React.ComponentProps<typeof PopoverPrimitive.Trigger>) {\n  return <PopoverPrimitive.Trigger data-slot=\"popover-trigger\" {...props} />;\n}\n\nfunction PopoverContent({\n  className,\n  align = \"center\",\n  sideOffset = 4,\n  ...props\n}: React.ComponentProps<typeof PopoverPrimitive.Content>) {\n  return (\n    <PopoverPrimitive.Portal>\n      <PopoverPrimitive.Content\n        data-slot=\"popover-content\"\n        align={align}\n        sideOffset={sideOffset}\n        className={cn(\n          \"bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-72 origin-(--radix-popover-content-transform-origin) rounded-md border p-4 shadow-md outline-hidden\",\n          className,\n        )}\n        {...props}\n      />\n    </PopoverPrimitive.Portal>\n  );\n}\n\nfunction PopoverAnchor({\n  ...props\n}: React.ComponentProps<typeof PopoverPrimitive.Anchor>) {\n  return <PopoverPrimitive.Anchor data-slot=\"popover-anchor\" {...props} />;\n}\n\nexport { Popover, PopoverTrigger, PopoverContent, PopoverAnchor };\n",
        "byteOffset": 0,
        "totalChunks": 1,
        "hasMore": false,
        "startLine": 1,
        "endLine": 49
      }
    ]
  },
  {
    "path": "src/app/components/ui/scroll-area.tsx",
    "size": 1649,
    "sha256": "5bd9bb1d6909467b431283e96d2a9c83003bca1aa043d149dcfed8e81de51986",
    "lang": "tsx",
    "lines": 59,
    "modifiedAt": "2025-09-02T01:28:28+03:00",
    "commitSha": "29d28ab09b16112f6f64a83fb43e1143e63a0ed0",
    "rawUrl": "https://raw.githubusercontent.com/serlaoravainen/tuukka-chat-exports/main/files/src/app/components/ui/scroll-area.tsx",
    "chunks": [
      {
        "i": 0,
        "text": "\"use client\";\n\nimport * as React from \"react\";\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\";\n\nimport { cn } from \"./utils\";\n\nfunction ScrollArea({\n  className,\n  children,\n  ...props\n}: React.ComponentProps<typeof ScrollAreaPrimitive.Root>) {\n  return (\n    <ScrollAreaPrimitive.Root\n      data-slot=\"scroll-area\"\n      className={cn(\"relative\", className)}\n      {...props}\n    >\n      <ScrollAreaPrimitive.Viewport\n        data-slot=\"scroll-area-viewport\"\n        className=\"focus-visible:ring-ring/50 size-full rounded-[inherit] transition-[color,box-shadow] outline-none focus-visible:ring-[3px] focus-visible:outline-1\"\n      >\n        {children}\n      </ScrollAreaPrimitive.Viewport>\n      <ScrollBar />\n      <ScrollAreaPrimitive.Corner />\n    </ScrollAreaPrimitive.Root>\n  );\n}\n\nfunction ScrollBar({\n  className,\n  orientation = \"vertical\",\n  ...props\n}: React.ComponentProps<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>) {\n  return (\n    <ScrollAreaPrimitive.ScrollAreaScrollbar\n      data-slot=\"scroll-area-scrollbar\"\n      orientation={orientation}\n      className={cn(\n        \"flex touch-none p-px transition-colors select-none\",\n        orientation === \"vertical\" &&\n          \"h-full w-2.5 border-l border-l-transparent\",\n        orientation === \"horizontal\" &&\n          \"h-2.5 flex-col border-t border-t-transparent\",\n        className,\n      )}\n      {...props}\n    >\n      <ScrollAreaPrimitive.ScrollAreaThumb\n        data-slot=\"scroll-area-thumb\"\n        className=\"bg-border relative flex-1 rounded-full\"\n      />\n    </ScrollAreaPrimitive.ScrollAreaScrollbar>\n  );\n}\n\nexport { ScrollArea, ScrollBar };\n",
        "byteOffset": 0,
        "totalChunks": 1,
        "hasMore": false,
        "startLine": 1,
        "endLine": 59
      }
    ]
  }
]